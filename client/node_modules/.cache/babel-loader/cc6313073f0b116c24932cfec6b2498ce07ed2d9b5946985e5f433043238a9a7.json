{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.filter.js\";\nimport \"core-js/modules/es.iterator.find.js\";\nimport \"core-js/modules/es.iterator.for-each.js\";\nimport \"core-js/modules/es.iterator.map.js\";\nimport { ref, computed, onMounted, onUnmounted, watch, nextTick } from 'vue';\nimport { useStore } from 'vuex';\nimport { useRoute, useRouter } from 'vue-router';\nimport axios from 'axios';\nimport moment from 'moment-timezone';\nimport Chart from 'chart.js/auto';\nimport StudentDetailsModal from '@/components/modals/StudentDetailsModal.vue';\nimport * as XLSX from 'xlsx';\n\n// Create axios instance with base URL\nconst api = axios.create({\n  baseURL: 'http://localhost:8000/api',\n  headers: {\n    'Content-Type': 'application/json'\n  }\n});\nexport default {\n  name: 'Attendance',\n  components: {\n    StudentDetailsModal\n  },\n  setup() {\n    const store = useStore();\n    const route = useRoute();\n    const router = useRouter();\n    const students = ref([]);\n    const searchQuery = ref('');\n    const sortField = ref('lastName');\n    const sortOrder = ref('asc');\n    const selectedStudent = ref(null);\n    const currentDate = ref(moment().tz('Asia/Manila').startOf('day').toDate());\n    const slideDirection = ref('');\n    let attendanceChart = null;\n    let dateUpdateInterval = null;\n\n    // Date filter for attendance history\n    const historyStartDate = ref(moment().tz('Asia/Manila').subtract(30, 'days').format('YYYY-MM-DD'));\n    const historyEndDate = ref(moment().tz('Asia/Manila').format('YYYY-MM-DD'));\n    const showHistoryDatePicker = ref(false);\n    const showCalendarPopup = ref(false);\n\n    // Add refs for query parameters\n    const selectedYear = ref(route.query.year || localStorage.getItem('selectedYear') || '');\n    const selectedSection = ref(route.query.section || localStorage.getItem('selectedSection') || '');\n    const selectedSubject = ref(route.query.subject || localStorage.getItem('selectedSubject') || '');\n\n    // Add refs for available options\n    const availableYears = ref([]);\n    const availableSections = ref([]);\n    const sectionsByYear = ref({});\n    const teacherSubjects = ref([]);\n\n    // Computed property for filtered sections based on selected year\n    const filteredSections = computed(() => {\n      if (!selectedYear.value) return [];\n      return sectionsByYear.value[selectedYear.value] || [];\n    });\n\n    // Function to fetch available years and sections\n    const fetchAvailableYearsAndSections = async () => {\n      try {\n        const token = store.state.auth.token;\n        const teacherId = store.state.auth.user?._id;\n        if (!teacherId) {\n          console.error('Teacher ID not available');\n          return;\n        }\n        console.log('Fetching available years and sections for teacher:', teacherId);\n\n        // Use the teacher-specific endpoint to get only years and sections for this teacher\n        const response = await api.get('/teacher-class-records/available-years-sections', {\n          params: {\n            teacherId\n          },\n          headers: {\n            'Authorization': `Bearer ${token}`\n          }\n        }).catch(error => {\n          console.error('Error fetching teacher-specific years and sections:', error);\n\n          // Fall back to the general endpoint if teacher-specific one fails\n          return api.get('/students/available-years-sections', {\n            headers: {\n              'Authorization': `Bearer ${token}`\n            }\n          });\n        });\n        console.log('API Response for years and sections:', response.data);\n        if (response.data) {\n          // Set available years and sections from the response\n          availableYears.value = response.data.years || [];\n          availableSections.value = response.data.sections || [];\n\n          // Use sectionsByYear from the API response\n          if (response.data.sectionsByYear) {\n            sectionsByYear.value = response.data.sectionsByYear;\n          } else {\n            sectionsByYear.value = {};\n\n            // If we have years and sections but no sectionsByYear mapping,\n            // create a simple mapping where each year has all sections\n            if (availableYears.value.length > 0 && availableSections.value.length > 0) {\n              availableYears.value.forEach(year => {\n                sectionsByYear.value[year] = [...availableSections.value];\n              });\n            }\n          }\n          console.log('Available years:', availableYears.value);\n          console.log('Available sections:', availableSections.value);\n          console.log('Sections by year mapping:', sectionsByYear.value);\n\n          // If no years are available, don't add default values\n          // This ensures teachers only see years they've added\n          if (availableYears.value.length === 0) {\n            console.log('No years found for this teacher');\n          }\n\n          // If no sections are available, don't add default values\n          if (availableSections.value.length === 0) {\n            console.log('No sections found for this teacher');\n          }\n        }\n      } catch (error) {\n        console.error('Failed to fetch available years and sections:', error);\n        // Don't set default values - teacher should only see what they've added\n        availableYears.value = [];\n        availableSections.value = [];\n        sectionsByYear.value = {};\n      }\n    };\n\n    // Function to fetch teacher subjects\n    const fetchTeacherSubjects = async () => {\n      try {\n        const token = store.state.auth.token;\n        const teacherId = store.state.auth.user?._id;\n        if (!teacherId) {\n          console.error('Teacher ID not available');\n          return;\n        }\n\n        // Try to fetch subjects from the teacher class records\n        try {\n          const response = await api.get('/teacher-class-records/available-years-sections', {\n            params: {\n              teacherId\n            },\n            headers: {\n              'Authorization': `Bearer ${token}`\n            }\n          });\n          if (response.data && response.data.subjects && response.data.subjects.length > 0) {\n            teacherSubjects.value = response.data.subjects;\n            console.log('Subjects loaded from teacher class records:', teacherSubjects.value);\n          } else {\n            // If no subjects found in class records, try the user endpoint\n            const userResponse = await api.get(`/users/${teacherId}/subjects`, {\n              headers: {\n                'Authorization': `Bearer ${token}`\n              }\n            });\n            if (userResponse.data && userResponse.data.subjects && userResponse.data.subjects.length > 0) {\n              teacherSubjects.value = userResponse.data.subjects;\n              console.log('Subjects loaded from user profile:', teacherSubjects.value);\n            } else {\n              // If still no subjects, use default subjects\n              console.log('No subjects found, using default subjects');\n            }\n          }\n        } catch (error) {\n          console.error('Failed to fetch teacher subjects from class records:', error);\n\n          // Try the user endpoint as fallback\n          try {\n            const userResponse = await api.get(`/users/${teacherId}/subjects`, {\n              headers: {\n                'Authorization': `Bearer ${token}`\n              }\n            });\n            if (userResponse.data && userResponse.data.subjects && userResponse.data.subjects.length > 0) {\n              teacherSubjects.value = userResponse.data.subjects;\n              console.log('Subjects loaded from user profile (fallback):', teacherSubjects.value);\n            } else {\n              teacherSubjects.value = ['Math', 'Science', 'English', 'History'];\n              console.log('No subjects found in user profile, using default subjects');\n            }\n          } catch (userError) {\n            console.error('Failed to fetch teacher subjects from user profile:', userError);\n            teacherSubjects.value = ['Math', 'Science', 'English', 'History'];\n            console.log('Using default subjects due to API errors');\n          }\n        }\n      } catch (error) {\n        console.error('Error in fetchTeacherSubjects:', error);\n        teacherSubjects.value = ['Math', 'Science', 'English', 'History'];\n      }\n    };\n\n    // Function to apply filters\n    const applyFilters = async () => {\n      console.log('Applying filters:', {\n        year: selectedYear.value,\n        section: selectedSection.value,\n        subject: selectedSubject.value\n      });\n\n      // Save selected values to localStorage\n      if (selectedYear.value) localStorage.setItem('selectedYear', selectedYear.value);\n      if (selectedSection.value) localStorage.setItem('selectedSection', selectedSection.value);\n      if (selectedSubject.value) localStorage.setItem('selectedSubject', selectedSubject.value);\n\n      // Update URL query parameters\n      router.replace({\n        query: {\n          ...route.query,\n          year: selectedYear.value || undefined,\n          section: selectedSection.value || undefined,\n          subject: selectedSubject.value || undefined\n        }\n      });\n\n      // Always fetch student records when filters are applied\n      await fetchStudentRecords();\n    };\n\n    // Function to clear filters\n    const clearFilters = () => {\n      selectedYear.value = '';\n      selectedSection.value = '';\n      selectedSubject.value = '';\n      localStorage.removeItem('selectedYear');\n      localStorage.removeItem('selectedSection');\n      localStorage.removeItem('selectedSubject');\n\n      // Update URL query parameters\n      router.replace({\n        query: {}\n      });\n    };\n\n    // Function to fetch students and their attendance\n    const fetchStudentRecords = async () => {\n      try {\n        const token = store.state.auth.token;\n        const teacherId = store.state.auth.user?._id;\n        if (!teacherId) {\n          console.error('Teacher ID not available');\n          return;\n        }\n\n        // Create a params object with the teacher ID\n        const params = {\n          teacherId\n        };\n\n        // Add any selected filters to the params\n        if (selectedYear.value) params.year = selectedYear.value;\n        if (selectedSection.value) params.section = selectedSection.value;\n        if (selectedSubject.value) params.subject = selectedSubject.value;\n        console.log('Fetching student records with filters:', params);\n        try {\n          const response = await api.get('/teacher-class-records/students-for-attendance', {\n            params,\n            headers: {\n              'Authorization': `Bearer ${token}`\n            }\n          });\n          console.log('Students API response:', response.data);\n          if (response.data) {\n            let studentList = [];\n            if (Array.isArray(response.data)) {\n              studentList = response.data;\n            } else if (response.data.students && Array.isArray(response.data.students)) {\n              studentList = response.data.students;\n            }\n\n            // Log each student's data to verify studentId is present\n            studentList.forEach(student => {\n              console.log('Student data:', {\n                studentId: student._id || student.studentId,\n                studentNumber: student.studentNumber,\n                name: `${student.firstName} ${student.lastName}`\n              });\n            });\n\n            // Initialize students with 'none' status and ensure studentId is set\n            students.value = studentList.map(student => ({\n              ...student,\n              studentId: student._id || student.studentId,\n              // Use _id if studentId is not present\n              currentStatus: 'none'\n            }));\n            console.log(`Loaded ${students.value.length} students with IDs`);\n\n            // Immediately fetch attendance after loading students\n            if (students.value.length > 0) {\n              await fetchAttendance();\n            }\n          }\n        } catch (error) {\n          console.error('Failed to fetch student records:', error);\n          students.value = [];\n        }\n      } catch (error) {\n        console.error('Error in fetchStudentRecords:', error);\n        students.value = [];\n      }\n    };\n\n    // Function to fetch attendance for current date\n    const fetchAttendance = async () => {\n      try {\n        // If there are no students, we can't fetch attendance\n        if (!students.value.length) {\n          console.log('fetchAttendance: No students to fetch attendance for');\n          return;\n        }\n        const date = moment(currentDate.value).tz('Asia/Manila').startOf('day').format('YYYY-MM-DD');\n        console.log('fetchAttendance: Fetching attendance data for date:', date);\n\n        // Create params object with the date and required filters\n        const params = {\n          teacherId: store.state.auth.user?._id,\n          date: date\n        };\n\n        // Add any selected filters to the params\n        if (selectedYear.value) params.year = selectedYear.value;\n        if (selectedSection.value) params.section = selectedSection.value;\n        if (selectedSubject.value) params.subject = selectedSubject.value;\n        console.log('Fetching attendance with params:', params);\n        const response = await api.get(`/attendance/date/${date}`, {\n          params,\n          headers: {\n            'Authorization': `Bearer ${store.state.auth.token}`\n          }\n        });\n        console.log('Attendance data received:', response.data);\n\n        // Create a map to store attendance by student ID\n        const studentMap = new Map();\n        if (response.data && Array.isArray(response.data)) {\n          console.log(`Processing ${response.data.length} attendance records`);\n\n          // Group records by student ID to find the most recent one for each student\n          const recordsByStudent = {};\n          response.data.forEach(record => {\n            if (record.studentId) {\n              // If we don't have this student yet, or this record is newer\n              if (!recordsByStudent[record.studentId] || record.createdAt && (!recordsByStudent[record.studentId].createdAt || new Date(record.createdAt) > new Date(recordsByStudent[record.studentId].createdAt))) {\n                recordsByStudent[record.studentId] = record;\n                console.log(`Found newer record for student ${record.studentId}: ${record.status} (created at ${record.createdAt})`);\n              }\n            } else {\n              console.log('Record missing studentId:', record);\n            }\n          });\n\n          // Now use the most recent record for each student\n          Object.values(recordsByStudent).forEach(record => {\n            studentMap.set(String(record.studentId), record.status || 'none');\n            console.log(`Using most recent attendance for student ID ${record.studentId}: ${record.status || 'none'} (created at ${record.createdAt})`);\n          });\n        }\n\n        // Update students with attendance data\n        if (students.value && students.value.length > 0) {\n          // Merge attendance data into students array\n          // This will fix the updating of attendance data\n          students.value = students.value.map(student => ({\n            ...student,\n            currentStatus: response.data.find(att => att.studentId === student.studentId)?.status\n          }));\n\n          // Force a UI update\n          await nextTick();\n          students.value = [...students.value];\n          console.log('Updated attendance status for all students');\n        }\n      } catch (error) {\n        console.error('Error in fetchAttendance:', error);\n      }\n    };\n\n    // Create attendance chart\n    const createPerformanceChart = () => {\n      if (!selectedStudent.value) return;\n\n      // Create a unique chart ID for each student\n      const chartId = `attendanceChart-${selectedStudent.value.studentId}`;\n      const chartElement = document.getElementById('attendanceChart');\n\n      // Set a unique ID to the chart element\n      if (chartElement) {\n        chartElement.id = chartId;\n      }\n      const ctx = document.getElementById(chartId)?.getContext('2d');\n      if (!ctx) return;\n\n      // Destroy existing chart if it exists\n      if (attendanceChart) {\n        attendanceChart.destroy();\n        attendanceChart = null;\n      }\n\n      // Get the chart container\n      const chartContainer = document.querySelector('.chart-container');\n      if (!chartContainer) return;\n\n      // Check if we have valid attendance statistics and records\n      const stats = selectedStudent.value.attendanceStats;\n      const hasAttendanceRecords = selectedStudent.value.attendanceHistory && selectedStudent.value.attendanceHistory.length > 0;\n      if (!hasAttendanceRecords || !stats || stats.presentPercentage === 0 && stats.absentPercentage === 0 && stats.latePercentage === 0) {\n        // If no attendance data, display a message instead of an empty chart\n        chartContainer.innerHTML = '';\n        const noDataMessage = document.createElement('div');\n        noDataMessage.className = 'text-center py-5 text-muted';\n        noDataMessage.innerHTML = '<i class=\"fas fa-info-circle me-2\"></i>No attendance data available for this student in the selected date range.';\n        chartContainer.appendChild(noDataMessage);\n        return;\n      }\n\n      // Clear the container and add canvas back\n      chartContainer.innerHTML = '';\n      const canvas = document.createElement('canvas');\n      canvas.id = chartId;\n      chartContainer.appendChild(canvas);\n\n      // Get the context from the new canvas\n      const newCtx = document.getElementById(chartId)?.getContext('2d');\n      if (!newCtx) return;\n\n      // Enhanced colors for the chart\n      const chartColors = {\n        present: {\n          backgroundColor: '#4CAF50',\n          hoverBackgroundColor: '#388E3C',\n          borderColor: '#fff',\n          borderWidth: 2\n        },\n        absent: {\n          backgroundColor: '#F44336',\n          hoverBackgroundColor: '#D32F2F',\n          borderColor: '#fff',\n          borderWidth: 2\n        },\n        late: {\n          backgroundColor: '#FFC107',\n          hoverBackgroundColor: '#FFA000',\n          borderColor: '#fff',\n          borderWidth: 2\n        }\n      };\n\n      // Create the chart\n      attendanceChart = new Chart(newCtx, {\n        type: 'doughnut',\n        data: {\n          labels: ['Present', 'Absent', 'Late'],\n          datasets: [{\n            data: [stats.presentPercentage, stats.absentPercentage, stats.latePercentage],\n            backgroundColor: [chartColors.present.backgroundColor, chartColors.absent.backgroundColor, chartColors.late.backgroundColor],\n            hoverBackgroundColor: [chartColors.present.hoverBackgroundColor, chartColors.absent.hoverBackgroundColor, chartColors.late.hoverBackgroundColor],\n            borderColor: [chartColors.present.borderColor, chartColors.absent.borderColor, chartColors.late.borderColor],\n            borderWidth: 2,\n            borderRadius: 5,\n            spacing: 5,\n            hoverOffset: 10\n          }]\n        },\n        options: {\n          responsive: true,\n          maintainAspectRatio: false,\n          cutout: '70%',\n          animation: {\n            animateScale: true,\n            animateRotate: true,\n            duration: 1000,\n            easing: 'easeOutQuart'\n          },\n          plugins: {\n            legend: {\n              position: 'bottom',\n              labels: {\n                padding: 20,\n                boxWidth: 15,\n                boxHeight: 15,\n                font: {\n                  size: 14,\n                  weight: 'bold'\n                },\n                generateLabels: chart => {\n                  const data = chart.data;\n                  if (data.labels.length && data.datasets.length) {\n                    return data.labels.map((label, i) => {\n                      const meta = chart.getDatasetMeta(0);\n                      const style = meta.controller.getStyle(i);\n                      return {\n                        text: `${label}: ${data.datasets[0].data[i].toFixed(1)}%`,\n                        fillStyle: style.backgroundColor,\n                        strokeStyle: style.borderColor,\n                        lineWidth: style.borderWidth,\n                        hidden: isNaN(data.datasets[0].data[i]) || meta.data[i].hidden,\n                        index: i\n                      };\n                    });\n                  }\n                  return [];\n                }\n              }\n            },\n            tooltip: {\n              backgroundColor: 'rgba(0, 0, 0, 0.8)',\n              titleFont: {\n                size: 16,\n                weight: 'bold'\n              },\n              bodyFont: {\n                size: 14\n              },\n              padding: 15,\n              cornerRadius: 8,\n              displayColors: true,\n              callbacks: {\n                label: function (context) {\n                  const label = context.label || '';\n                  const value = context.raw || 0;\n                  return `${label}: ${value.toFixed(1)}%`;\n                }\n              }\n            }\n          }\n        }\n      });\n    };\n\n    // View student details\n    const viewStudentDetails = async student => {\n      try {\n        // Reset any existing chart before showing a new student\n        if (attendanceChart) {\n          attendanceChart.destroy();\n          attendanceChart = null;\n        }\n        selectedStudent.value = {\n          ...student,\n          attendanceHistory: [],\n          attendanceStats: {\n            presentPercentage: 0,\n            absentPercentage: 0,\n            latePercentage: 0\n          }\n        };\n\n        // Fetch attendance history with the current date filters\n        await fetchStudentAttendanceHistory(selectedStudent.value);\n      } catch (error) {\n        console.error('Error fetching student details:', error);\n        alert('Failed to load student details. Please try again.');\n      }\n    };\n\n    // Fetch student attendance history with date filters\n    const fetchStudentAttendanceHistory = async student => {\n      if (!student) return;\n      try {\n        console.log(`Fetching attendance history for student ${student.studentNumber} with date range:`, {\n          startDate: historyStartDate.value,\n          endDate: historyEndDate.value\n        });\n        const response = await api.get(`/attendance/${student.studentId}/history`, {\n          params: {\n            subject: selectedSubject.value,\n            startDate: historyStartDate.value,\n            endDate: historyEndDate.value\n          },\n          headers: {\n            'Authorization': `Bearer ${store.state.auth.token}`\n          }\n        });\n        if (response.data) {\n          // Make sure we're updating the correct student\n          if (selectedStudent.value && selectedStudent.value.studentId === student.studentId) {\n            // Only include records that have a valid status (not null, undefined, or empty string)\n            const validRecords = Array.isArray(response.data.records) ? response.data.records.filter(record => record && record.status && record.status !== '') : [];\n            selectedStudent.value.attendanceHistory = validRecords;\n\n            // Only calculate statistics based on valid records\n            if (validRecords.length > 0) {\n              // Count occurrences of each status\n              const statusCounts = {\n                present: 0,\n                absent: 0,\n                late: 0\n              };\n              validRecords.forEach(record => {\n                if (record.status in statusCounts) {\n                  statusCounts[record.status]++;\n                }\n              });\n\n              // Calculate percentages\n              const total = validRecords.length;\n              const presentPercentage = total > 0 ? statusCounts.present / total * 100 : 0;\n              const absentPercentage = total > 0 ? statusCounts.absent / total * 100 : 0;\n              const latePercentage = total > 0 ? statusCounts.late / total * 100 : 0;\n              selectedStudent.value.attendanceStats = {\n                presentPercentage,\n                absentPercentage,\n                latePercentage\n              };\n            } else {\n              // If no valid records, set all percentages to 0\n              selectedStudent.value.attendanceStats = {\n                presentPercentage: 0,\n                absentPercentage: 0,\n                latePercentage: 0\n              };\n            }\n            console.log(`Loaded ${selectedStudent.value.attendanceHistory.length} attendance records for student ${student.studentNumber}`);\n\n            // Create attendance chart on next tick to ensure DOM is ready\n            nextTick(() => {\n              // Reset any existing chart before creating a new one\n              if (attendanceChart) {\n                attendanceChart.destroy();\n                attendanceChart = null;\n              }\n              createPerformanceChart();\n            });\n          } else {\n            console.log('Selected student changed, not updating attendance history');\n          }\n        }\n      } catch (error) {\n        console.error('Error fetching student attendance history:', error);\n        selectedStudent.value.attendanceHistory = [];\n        selectedStudent.value.attendanceStats = {\n          presentPercentage: 0,\n          absentPercentage: 0,\n          latePercentage: 0\n        };\n\n        // Create chart with empty data\n        nextTick(() => {\n          if (attendanceChart) {\n            attendanceChart.destroy();\n            attendanceChart = null;\n          }\n          createPerformanceChart();\n        });\n      }\n    };\n\n    // Sort functions\n    const sortBy = field => {\n      if (sortField.value === field) {\n        sortOrder.value = sortOrder.value === 'asc' ? 'desc' : 'asc';\n      } else {\n        sortField.value = field;\n        sortOrder.value = 'asc';\n      }\n    };\n    const getSortIcon = field => {\n      if (sortField.value !== field) return 'fas fa-sort';\n      return sortOrder.value === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';\n    };\n\n    // Sort students\n    const sortedStudents = computed(() => {\n      if (!Array.isArray(students.value)) {\n        return [];\n      }\n      let sortedList = [...students.value];\n      if (sortField.value) {\n        sortedList.sort((a, b) => {\n          let aVal = a[sortField.value];\n          let bVal = b[sortField.value];\n          if (typeof aVal === 'string') aVal = aVal.toLowerCase();\n          if (typeof bVal === 'string') bVal = bVal.toLowerCase();\n          if (aVal < bVal) return sortOrder.value === 'asc' ? -1 : 1;\n          if (aVal > bVal) return sortOrder.value === 'asc' ? 1 : -1;\n          return 0;\n        });\n      }\n      if (!searchQuery.value) {\n        return sortedList;\n      }\n      const searchLower = searchQuery.value.toLowerCase();\n      return sortedList.filter(student => {\n        return student.studentNumber.toLowerCase().includes(searchLower) || student.firstName.toLowerCase().includes(searchLower) || student.lastName.toLowerCase().includes(searchLower);\n      });\n    });\n\n    // Update attendance status\n    const markAttendance = async (student, status) => {\n      try {\n        if (!status || !student) {\n          console.log('Invalid status or student:', {\n            status,\n            student\n          });\n          return;\n        }\n        const date = moment(currentDate.value).tz('Asia/Manila').startOf('day').format('YYYY-MM-DD');\n        console.log('Marking attendance:', {\n          studentId: student.studentId,\n          studentNumber: student.studentNumber,\n          status,\n          date\n        });\n        const attendanceData = {\n          studentId: student.studentId,\n          studentNumber: student.studentNumber,\n          teacherId: store.state.auth.user._id,\n          date: date,\n          subject: selectedSubject.value,\n          section: selectedSection.value,\n          year: selectedYear.value,\n          status: status,\n          createdAt: new Date().toISOString() // Ensure we have a current timestamp\n        };\n\n        // Update UI immediately for better responsiveness\n        student.currentStatus = status;\n        const response = await api.post('/attendance', attendanceData, {\n          headers: {\n            'Authorization': `Bearer ${store.state.auth.token}`\n          }\n        });\n        if (response.data) {\n          console.log('Attendance marked successfully:', response.data);\n\n          // Store the attendance status in the student object for this date\n          if (!student.attendanceByDate) {\n            student.attendanceByDate = {};\n          }\n          student.attendanceByDate[date] = status;\n\n          // If the student is currently selected in the details modal, update their history\n          if (selectedStudent.value && selectedStudent.value.studentId === student.studentId) {\n            await fetchStudentAttendanceHistory(selectedStudent.value);\n          }\n        }\n      } catch (error) {\n        console.error('Error marking attendance:', error);\n        // Revert the status on error\n        student.currentStatus = 'none';\n        alert('Failed to save attendance. Please try again.');\n      }\n    };\n\n    // Handle search\n    const handleSearch = () => {\n      // The sortedStudents computed property will automatically filter based on searchQuery\n    };\n\n    // Watch for query parameter changes\n    watch([selectedYear, selectedSection, selectedSubject], async () => {\n      // Save selected values to localStorage\n      if (selectedYear.value) localStorage.setItem('selectedYear', selectedYear.value);\n      if (selectedSection.value) localStorage.setItem('selectedSection', selectedSection.value);\n      if (selectedSubject.value) localStorage.setItem('selectedSubject', selectedSubject.value);\n\n      // Fetch student records and attendance when filters change\n      if (selectedYear.value && selectedSection.value && selectedSubject.value) {\n        await fetchStudentRecords();\n      }\n\n      // Update navigation title\n      if (selectedYear.value && selectedSection.value && selectedSubject.value) {\n        try {\n          if (router.currentRoute.value.matched[0].components.default.props) {\n            router.currentRoute.value.matched[0].components.default.props.selectedInfo = `${selectedYear.value} - ${selectedSection.value} | ${selectedSubject.value}`;\n          }\n        } catch (error) {\n          console.error('Error updating navigation title:', error);\n        }\n      }\n    });\n\n    // Watch for date changes\n    watch(currentDate, async (newDate, oldDate) => {\n      console.log('Current date changed from', moment(oldDate).format('YYYY-MM-DD'), 'to', moment(newDate).format('YYYY-MM-DD'));\n\n      // Only fetch if we have the required data\n      if (selectedYear.value && selectedSection.value && selectedSubject.value && students.value.length > 0) {\n        console.log('Fetching attendance data for new date');\n        await fetchAttendance();\n      } else {\n        console.log('Skipping attendance fetch due to missing data:', {\n          year: selectedYear.value,\n          section: selectedSection.value,\n          subject: selectedSubject.value,\n          studentsCount: students.value?.length || 0\n        });\n      }\n    });\n\n    // Clean up chart when component unmounts\n    onUnmounted(() => {\n      if (attendanceChart) {\n        attendanceChart.destroy();\n        attendanceChart = null;\n      }\n      if (dateUpdateInterval) {\n        clearInterval(dateUpdateInterval);\n      }\n    });\n\n    // Clean up chart when student modal closes\n    watch(() => selectedStudent.value, (newValue, oldValue) => {\n      if (!newValue && attendanceChart) {\n        attendanceChart.destroy();\n        attendanceChart = null;\n\n        // Reset the chart element ID back to the default\n        if (oldValue) {\n          const chartElement = document.getElementById(`attendanceChart-${oldValue.studentId}`);\n          if (chartElement) {\n            chartElement.id = 'attendanceChart';\n          }\n        }\n      }\n    });\n\n    // Format date for display\n    const formatDate = date => {\n      if (!date) return 'N/A';\n      return moment(date).tz('Asia/Manila').format('MMMM D, YYYY');\n    };\n\n    // Format date for input fields (YYYY-MM-DD)\n    const formatDateForInput = date => {\n      if (!date) return '';\n      return moment(date).tz('Asia/Manila').format('YYYY-MM-DD');\n    };\n\n    // Add isNextDayDisabled computed property\n    const isNextDayDisabled = computed(() => {\n      const now = moment().tz('Asia/Manila').startOf('day');\n      const selected = moment(currentDate.value).tz('Asia/Manila').startOf('day');\n      return selected.isSameOrAfter(now, 'day');\n    });\n\n    // Add navigateDate function\n    const navigateDate = direction => {\n      const now = moment().tz('Asia/Manila').startOf('day');\n      const newDate = moment(currentDate.value).tz('Asia/Manila').startOf('day').add(direction, 'days');\n\n      // Only allow navigation to past dates or current date\n      if (direction < 0 || direction > 0 && !newDate.isAfter(now, 'day')) {\n        slideDirection.value = direction > 0 ? 'slide-left' : 'slide-right';\n        currentDate.value = newDate.toDate();\n\n        // Refresh attendance data\n        fetchAttendance(currentDate.value);\n        setTimeout(() => {\n          slideDirection.value = '';\n        }, 300);\n      }\n    };\n\n    // Setup date auto-update to handle timezone correctly\n    const setupDateAutoUpdate = () => {\n      const checkAndUpdateDate = () => {\n        const now = moment().tz('Asia/Manila').startOf('day');\n        const current = moment(currentDate.value).tz('Asia/Manila').startOf('day');\n\n        // If it's past midnight and we're showing yesterday's date\n        if (now.isAfter(current, 'day')) {\n          currentDate.value = now.toDate();\n          fetchAttendance();\n        }\n      };\n\n      // Clear existing interval if any\n      if (dateUpdateInterval) {\n        clearInterval(dateUpdateInterval);\n      }\n\n      // Check every minute\n      dateUpdateInterval = setInterval(checkAndUpdateDate, 60000);\n    };\n\n    // Add watchers for filter changes\n    watch(selectedYear, newValue => {\n      if (newValue) {\n        selectedSection.value = '';\n        selectedSubject.value = '';\n      }\n    });\n    watch(selectedSection, newValue => {\n      if (newValue) {\n        selectedSubject.value = '';\n      }\n    });\n\n    // Get attendance status for display\n    const getAttendanceStatus = student => {\n      // If student has a currentStatus property and it's not 'none', use it\n      if (student.currentStatus && student.currentStatus !== 'none') {\n        return student.currentStatus;\n      }\n\n      // If no status is set, return 'none'\n      return 'none';\n    };\n\n    // Add setCurrentDate function\n    const setCurrentDate = dateString => {\n      if (!dateString) return;\n      const newDate = moment(dateString).tz('Asia/Manila').startOf('day');\n      const now = moment().tz('Asia/Manila').startOf('day');\n\n      // Only allow setting dates up to the current date\n      if (newDate.isAfter(now, 'day')) {\n        return;\n      }\n\n      // Set animation direction based on whether we're going forward or backward in time\n      const currentMoment = moment(currentDate.value).tz('Asia/Manila').startOf('day');\n      slideDirection.value = newDate.isAfter(currentMoment) ? 'slide-left' : 'slide-right';\n\n      // Update the current date\n      currentDate.value = newDate.toDate();\n\n      // Refresh attendance data\n      fetchAttendance();\n\n      // Reset animation after transition completes\n      setTimeout(() => {\n        slideDirection.value = '';\n      }, 300);\n    };\n\n    // Reset history date filter to default (last 30 days)\n    const resetHistoryDateFilter = () => {\n      historyStartDate.value = moment().tz('Asia/Manila').subtract(30, 'days').format('YYYY-MM-DD');\n      historyEndDate.value = moment().tz('Asia/Manila').format('YYYY-MM-DD');\n\n      // Fetch attendance history with the reset date range\n      if (selectedStudent.value) {\n        fetchStudentAttendanceHistory(selectedStudent.value);\n      }\n    };\n\n    // Set history date range based on preset\n    const setHistoryDateRange = preset => {\n      const now = moment().tz('Asia/Manila');\n      switch (preset) {\n        case 'week':\n          historyStartDate.value = now.clone().subtract(7, 'days').format('YYYY-MM-DD');\n          break;\n        case 'month':\n          historyStartDate.value = now.clone().subtract(30, 'days').format('YYYY-MM-DD');\n          break;\n        case 'quarter':\n          historyStartDate.value = now.clone().subtract(90, 'days').format('YYYY-MM-DD');\n          break;\n        case 'semester':\n          // Approximately 6 months\n          historyStartDate.value = now.clone().subtract(180, 'days').format('YYYY-MM-DD');\n          break;\n        default:\n          historyStartDate.value = now.clone().subtract(30, 'days').format('YYYY-MM-DD');\n      }\n      historyEndDate.value = now.format('YYYY-MM-DD');\n\n      // Fetch attendance history with the new date range\n      if (selectedStudent.value) {\n        fetchStudentAttendanceHistory(selectedStudent.value);\n      }\n    };\n\n    // Initialize component\n    onMounted(async () => {\n      if (store.getters.isLoggedIn) {\n        try {\n          console.log('Component mounted, initializing...');\n\n          // Fetch available years, sections, and subjects\n          await Promise.all([fetchAvailableYearsAndSections(), fetchTeacherSubjects()]);\n          console.log('Initialization complete, checking for saved filters:', {\n            year: selectedYear.value,\n            section: selectedSection.value,\n            subject: selectedSubject.value\n          });\n\n          // Apply filters if they are set\n          if (selectedYear.value && selectedSection.value && selectedSubject.value) {\n            console.log('Saved filters found, fetching student records...');\n            await fetchStudentRecords();\n            console.log('Student records loaded');\n          } else {\n            console.log('No saved filters found, skipping data fetch');\n          }\n\n          // Set up date auto-update\n          setupDateAutoUpdate();\n        } catch (error) {\n          console.error('Error during component initialization:', error);\n        }\n      } else {\n        router.push('/login');\n      }\n    });\n\n    // Function to refresh attendance data\n    const refreshAttendance = async () => {\n      console.log('Manually refreshing attendance data');\n\n      // Show loading indicator\n      const refreshButton = document.querySelector('.btn-outline-secondary i.fa-sync-alt');\n      if (refreshButton) {\n        refreshButton.classList.add('fa-spin');\n      }\n      try {\n        // Fetch fresh attendance data from the server\n        await fetchAttendance();\n\n        // Force a UI update to ensure the changes are reflected\n        nextTick(() => {\n          students.value = [...students.value];\n          console.log('Attendance data refreshed successfully');\n        });\n      } catch (error) {\n        console.error('Error refreshing attendance data:', error);\n      } finally {\n        // Remove loading indicator\n        setTimeout(() => {\n          if (refreshButton) {\n            refreshButton.classList.remove('fa-spin');\n          }\n        }, 500);\n      }\n    };\n\n    // Add openDatePicker function\n    const openDatePicker = () => {\n      const datePicker = document.querySelector('.date-picker-hidden');\n      if (datePicker) {\n        datePicker.click();\n      }\n    };\n\n    // Add openHistoryDatePicker function\n    const openHistoryDatePicker = () => {\n      showHistoryDatePicker.value = true;\n    };\n\n    // Add applyHistoryDateFilter function\n    const applyHistoryDateFilter = () => {\n      if (selectedStudent.value) {\n        fetchStudentAttendanceHistory(selectedStudent.value);\n      }\n      showHistoryDatePicker.value = false;\n    };\n\n    // Add openCalendarPopup function\n    const openCalendarPopup = () => {\n      showCalendarPopup.value = true;\n    };\n\n    // Add pagination state\n    const currentPage = ref(1);\n    const itemsPerPage = 25;\n\n    // Compute total pages\n    const totalPages = computed(() => Math.ceil(sortedStudents.value.length / itemsPerPage));\n\n    // Get paginated students\n    const paginatedStudents = computed(() => {\n      const start = (currentPage.value - 1) * itemsPerPage;\n      const end = start + itemsPerPage;\n      return sortedStudents.value.slice(start, end);\n    });\n\n    // Compute pagination info\n    const paginationInfo = computed(() => {\n      const start = sortedStudents.value.length === 0 ? 0 : (currentPage.value - 1) * itemsPerPage + 1;\n      const end = Math.min(start + itemsPerPage - 1, sortedStudents.value.length);\n      return {\n        start,\n        end\n      };\n    });\n\n    // Pagination methods\n    const nextPage = () => {\n      if (currentPage.value < totalPages.value) {\n        currentPage.value++;\n      }\n    };\n    const previousPage = () => {\n      if (currentPage.value > 1) {\n        currentPage.value--;\n      }\n    };\n\n    // Reset pagination when filters change\n    watch([searchQuery, selectedYear, selectedSection, selectedSubject], () => {\n      currentPage.value = 1;\n    });\n\n    // Add clearSearch function if it doesn't exist\n    const clearSearch = () => {\n      searchQuery.value = '';\n      handleSearch();\n    };\n\n    // Add export related refs\n    const showExportModal = ref(false);\n    const exportDateRange = ref({\n      start: moment().subtract(30, 'days').format('YYYY-MM-DD'),\n      end: moment().format('YYYY-MM-DD')\n    });\n    const exportType = ref('excel');\n    const isExporting = ref(false);\n\n    // Function to export attendance records\n    const exportRecords = async () => {\n      try {\n        isExporting.value = true;\n\n        // Validate date range\n        const startDate = new Date(exportDateRange.value.start);\n        const endDate = new Date(exportDateRange.value.end);\n        if (startDate > endDate) {\n          alert('Start date cannot be after end date');\n          isExporting.value = false;\n          return;\n        }\n        const teacherId = store.state.auth.user?._id;\n        if (!teacherId) {\n          throw new Error('Teacher ID not available');\n        }\n\n        // Fetch export data from API\n        const response = await api.get('/users/export/attendance', {\n          params: {\n            teacherId,\n            year: selectedYear.value,\n            section: selectedSection.value,\n            subject: selectedSubject.value,\n            startDate: exportDateRange.value.start,\n            endDate: exportDateRange.value.end\n          },\n          headers: {\n            'Authorization': `Bearer ${store.state.auth.token}`\n          }\n        });\n        const data = response.data;\n\n        // Prepare worksheet data\n        const worksheetData = [];\n\n        // Add header rows with class information\n        worksheetData.push(['Attendance Records Export']);\n        worksheetData.push(['Teacher:', data.teacherName]);\n        worksheetData.push(['Year:', data.year]);\n        worksheetData.push(['Section:', data.section]);\n        worksheetData.push(['Subject:', data.subject]);\n        worksheetData.push(['Date Range:', data.dateRange]);\n        worksheetData.push([]); // Empty row\n\n        // Add table headers\n        const headers = ['Student Number', 'Last Name', 'First Name'];\n\n        // Add date headers\n        data.dates.forEach(date => {\n          headers.push(moment(date).format('MM/DD/YYYY'));\n        });\n        worksheetData.push(headers);\n\n        // Add student data rows\n        data.students.forEach(student => {\n          const row = [student.studentNumber, student.lastName, student.firstName];\n\n          // Add attendance status for each date\n          data.dates.forEach(date => {\n            const status = student.attendance[date] || 'none';\n\n            // Capitalize first letter and handle 'none' specially\n            const formattedStatus = status === 'none' ? 'N/A' : status.charAt(0).toUpperCase() + status.slice(1);\n            row.push(formattedStatus);\n          });\n          worksheetData.push(row);\n        });\n\n        // Create worksheet and workbook\n        const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);\n        const workbook = XLSX.utils.book_new();\n        XLSX.utils.book_append_sheet(workbook, worksheet, 'Attendance Records');\n\n        // Set column widths\n        const colWidths = [{\n          wch: 15\n        },\n        // Student Number\n        {\n          wch: 15\n        },\n        // Last Name\n        {\n          wch: 15\n        } // First Name\n        ];\n\n        // Add widths for each date column\n        data.dates.forEach(() => {\n          colWidths.push({\n            wch: 12\n          });\n        });\n        worksheet['!cols'] = colWidths;\n\n        // Export based on selected type\n        if (exportType.value === 'excel') {\n          XLSX.writeFile(workbook, `${data.subject}_${data.year}_${data.section}_Attendance.xlsx`);\n        } else {\n          XLSX.writeFile(workbook, `${data.subject}_${data.year}_${data.section}_Attendance.csv`, {\n            bookType: 'csv'\n          });\n        }\n        closeExportModal();\n      } catch (error) {\n        console.error('Error exporting attendance records:', error);\n        alert('Failed to export attendance records. Please try again.');\n      } finally {\n        isExporting.value = false;\n      }\n    };\n\n    // Function to open export modal\n    const openExportModal = () => {\n      // Set modal visibility\n      showExportModal.value = true;\n\n      // Add class to body to prevent scrolling when modal is open\n      document.body.classList.add('modal-open');\n\n      // Reset date range to last 30 days by default\n      exportDateRange.value = {\n        start: moment().subtract(30, 'days').format('YYYY-MM-DD'),\n        end: moment().format('YYYY-MM-DD')\n      };\n\n      // Log modal opening for debugging\n      console.log('Export modal opened');\n    };\n\n    // Function to close export modal\n    const closeExportModal = () => {\n      showExportModal.value = false;\n      document.body.classList.remove('modal-open');\n    };\n    return {\n      students,\n      searchQuery,\n      sortedStudents,\n      selectedStudent,\n      currentDate,\n      formatDate,\n      formatDateForInput,\n      navigateDate,\n      isNextDayDisabled,\n      markAttendance,\n      slideDirection,\n      selectedYear,\n      selectedSection,\n      selectedSubject,\n      sortBy,\n      getSortIcon,\n      handleSearch,\n      viewStudentDetails,\n      fetchStudentAttendanceHistory,\n      historyStartDate,\n      historyEndDate,\n      availableYears,\n      availableSections,\n      sectionsByYear,\n      teacherSubjects,\n      filteredSections,\n      fetchAvailableYearsAndSections,\n      fetchTeacherSubjects,\n      applyFilters,\n      clearFilters,\n      getAttendanceStatus,\n      setCurrentDate,\n      resetHistoryDateFilter,\n      setHistoryDateRange,\n      openDatePicker,\n      showHistoryDatePicker,\n      openHistoryDatePicker,\n      applyHistoryDateFilter,\n      showCalendarPopup,\n      openCalendarPopup,\n      refreshAttendance,\n      currentPage,\n      totalPages,\n      paginatedStudents,\n      paginationInfo,\n      nextPage,\n      previousPage,\n      clearSearch,\n      showExportModal,\n      exportDateRange,\n      exportType,\n      isExporting,\n      exportRecords,\n      openExportModal,\n      closeExportModal\n    };\n  }\n};","map":{"version":3,"names":["ref","computed","onMounted","onUnmounted","watch","nextTick","useStore","useRoute","useRouter","axios","moment","Chart","StudentDetailsModal","XLSX","api","create","baseURL","headers","name","components","setup","store","route","router","students","searchQuery","sortField","sortOrder","selectedStudent","currentDate","tz","startOf","toDate","slideDirection","attendanceChart","dateUpdateInterval","historyStartDate","subtract","format","historyEndDate","showHistoryDatePicker","showCalendarPopup","selectedYear","query","year","localStorage","getItem","selectedSection","section","selectedSubject","subject","availableYears","availableSections","sectionsByYear","teacherSubjects","filteredSections","value","fetchAvailableYearsAndSections","token","state","auth","teacherId","user","_id","console","error","log","response","get","params","catch","data","years","sections","length","forEach","fetchTeacherSubjects","subjects","userResponse","userError","applyFilters","setItem","replace","undefined","fetchStudentRecords","clearFilters","removeItem","studentList","Array","isArray","student","studentId","studentNumber","firstName","lastName","map","currentStatus","fetchAttendance","date","studentMap","Map","recordsByStudent","record","createdAt","Date","status","Object","values","set","String","find","att","createPerformanceChart","chartId","chartElement","document","getElementById","id","ctx","getContext","destroy","chartContainer","querySelector","stats","attendanceStats","hasAttendanceRecords","attendanceHistory","presentPercentage","absentPercentage","latePercentage","innerHTML","noDataMessage","createElement","className","appendChild","canvas","newCtx","chartColors","present","backgroundColor","hoverBackgroundColor","borderColor","borderWidth","absent","late","type","labels","datasets","borderRadius","spacing","hoverOffset","options","responsive","maintainAspectRatio","cutout","animation","animateScale","animateRotate","duration","easing","plugins","legend","position","padding","boxWidth","boxHeight","font","size","weight","generateLabels","chart","label","i","meta","getDatasetMeta","style","controller","getStyle","text","toFixed","fillStyle","strokeStyle","lineWidth","hidden","isNaN","index","tooltip","titleFont","bodyFont","cornerRadius","displayColors","callbacks","context","raw","viewStudentDetails","fetchStudentAttendanceHistory","alert","startDate","endDate","validRecords","records","filter","statusCounts","total","sortBy","field","getSortIcon","sortedStudents","sortedList","sort","a","b","aVal","bVal","toLowerCase","searchLower","includes","markAttendance","attendanceData","toISOString","post","attendanceByDate","handleSearch","currentRoute","matched","default","props","selectedInfo","newDate","oldDate","studentsCount","clearInterval","newValue","oldValue","formatDate","formatDateForInput","isNextDayDisabled","now","selected","isSameOrAfter","navigateDate","direction","add","isAfter","setTimeout","setupDateAutoUpdate","checkAndUpdateDate","current","setInterval","getAttendanceStatus","setCurrentDate","dateString","currentMoment","resetHistoryDateFilter","setHistoryDateRange","preset","clone","getters","isLoggedIn","Promise","all","push","refreshAttendance","refreshButton","classList","remove","openDatePicker","datePicker","click","openHistoryDatePicker","applyHistoryDateFilter","openCalendarPopup","currentPage","itemsPerPage","totalPages","Math","ceil","paginatedStudents","start","end","slice","paginationInfo","min","nextPage","previousPage","clearSearch","showExportModal","exportDateRange","exportType","isExporting","exportRecords","Error","worksheetData","teacherName","dateRange","dates","row","attendance","formattedStatus","charAt","toUpperCase","worksheet","utils","aoa_to_sheet","workbook","book_new","book_append_sheet","colWidths","wch","writeFile","bookType","closeExportModal","openExportModal","body"],"sources":["D:\\au_dev\\client\\src\\views\\Attendance.vue"],"sourcesContent":["<template>\n  <div class=\"attendance-view\">\n    <!-- Control Buttons and Date Navigation -->\n    <div class=\"d-flex justify-content-between align-items-center mb-4\">\n      <div class=\"d-flex gap-2\">\n        <!-- Any attendance-specific buttons can go here -->\n        <button \n          class=\"btn btn-outline-secondary\" \n          @click=\"refreshAttendance\"\n          title=\"Refresh attendance data from database\"\n        >\n          <i class=\"fas fa-sync-alt me-2\"></i> Refresh Attendance\n        </button>\n        <button \n          class=\"btn btn-success\" \n          @click=\"openExportModal\"\n          title=\"Export attendance records\"\n        >\n          <i class=\"fas fa-file-export me-2\"></i> Export Attendance\n        </button>\n      </div>\n      \n      <!-- Date Navigation -->\n      <div class=\"d-flex align-items-center gap-3\">\n        <button class=\"btn btn-outline-primary\" @click=\"navigateDate(-1)\">\n          <i class=\"fas fa-chevron-left\"></i>\n        </button>\n        <div class=\"date-display\" @click=\"openCalendarPopup\" role=\"button\">\n          {{ formatDate(currentDate) }}\n        </div>\n        <button \n          class=\"btn btn-outline-primary\" \n          @click=\"navigateDate(1)\"\n          :disabled=\"isNextDayDisabled\"\n        >\n          <i class=\"fas fa-chevron-right\"></i>\n        </button>\n      </div>\n    </div>\n\n    <!-- Attendance Table -->\n    <div class=\"card\">\n      <div class=\"card-body\">\n        <!-- Table Controls -->\n        <div class=\"table-controls mb-4\" >\n          <div class=\"d-flex gap-3 align-items-center\">\n            <div class=\"d-flex gap-3\" >\n              <!-- Sort Dropdown -->\n              <div class=\"dropdown\" >\n                <button class=\"btn btn-control\" type=\"button\" data-bs-toggle=\"dropdown\" aria-expanded=\"false\">\n                  <i class=\"fas fa-sort me-2\"></i> Sort by\n                </button>\n                <ul class=\"dropdown-menu control-menu\" >\n                  <li>\n                    <a class=\"dropdown-item d-flex align-items-center\" href=\"#\" @click=\"sortBy('studentNumber')\">\n                      <i class=\"fas fa-sort-numeric-down me-2\"></i> Student Number\n                      <i :class=\"getSortIcon('studentNumber')\" class=\"ms-auto\"></i>\n                    </a>\n                  </li>\n                  <li>\n                    <a class=\"dropdown-item d-flex align-items-center\" href=\"#\" @click=\"sortBy('lastName')\">\n                      <i class=\"fas fa-sort-alpha-down me-2\"></i> Name\n                      <i :class=\"getSortIcon('lastName')\" class=\"ms-auto\"></i>\n                    </a>\n                  </li>\n                </ul>\n              </div>\n\n              <!-- Filter Dropdown -->\n              <div class=\"dropdown\">\n                <button class=\"btn btn-control\" type=\"button\" data-bs-toggle=\"dropdown\" aria-expanded=\"false\">\n                  <i class=\"fas fa-filter me-2\"></i> Filter\n                  <span v-if=\"selectedYear || selectedSection || selectedSubject\" class=\"filter-badge\">!</span>\n                </button>\n                <div class=\"dropdown-menu control-menu p-3\" style=\"width: 280px;\">\n                  <h6 class=\"dropdown-header mb-2\">Filter Options</h6>\n                  <div class=\"mb-3\">\n                    <label class=\"form-label\">Year Level</label>\n                    <select class=\"form-select form-select-sm\" v-model=\"selectedYear\" @change=\"applyFilters\">\n                      <option value=\"\">Select Year</option>\n                      <option v-for=\"year in availableYears\" :key=\"year\" :value=\"year\">{{ year }}</option>\n                    </select>\n                  </div>\n                  <div class=\"mb-3\">\n                    <label class=\"form-label\">Section</label>\n                    <select class=\"form-select form-select-sm\" v-model=\"selectedSection\" :disabled=\"!selectedYear\" @change=\"applyFilters\">\n                      <option value=\"\">Select Section</option>\n                      <option v-for=\"section in filteredSections\" :key=\"section\" :value=\"section\">{{ section }}</option>\n                    </select>\n                  </div>\n                  <div class=\"mb-3\">\n                    <label class=\"form-label\">Subject</label>\n                    <select class=\"form-select form-select-sm\" v-model=\"selectedSubject\" :disabled=\"!selectedSection\" @change=\"applyFilters\">\n                      <option value=\"\">Select Subject</option>\n                      <option v-for=\"subject in teacherSubjects\" :key=\"subject\" :value=\"subject\">{{ subject }}</option>\n                    </select>\n                  </div>\n                  <div class=\"d-flex justify-content-end gap-2 mt-3\">\n                    <button class=\"btn btn-sm btn-light\" @click=\"clearFilters\">\n                      Clear All\n                    </button>\n                    <button class=\"btn btn-sm btn-primary\" @click=\"applyFilters\">\n                      Apply Filters\n                    </button>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            <!-- Search Control -->\n            <div class=\"search-control\" style=\"flex: 1; max-width: 400px;\">\n              <div class=\"input-group\">\n                <span class=\"input-group-text border-end-0\">\n                  <i class=\"fas fa-search\"></i>\n                </span>\n                <input \n                  type=\"text\" \n                  class=\"form-control border-start-0\" \n                  v-model=\"searchQuery\"\n                  placeholder=\"Search students...\"\n                  @input=\"handleSearch\"\n                >\n                <button \n                  v-if=\"searchQuery\"\n                  class=\"btn btn-outline-secondary border-start-0\" \n                  type=\"button\"\n                  @click=\"clearSearch\"\n                >\n                  <i class=\"fas fa-times\"></i>\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        <!-- Table -->\n        <div class=\"table-responsive\">\n          <table class=\"table table-hover\">\n            <thead>\n              <tr>\n            <th>Student Number</th>\n                <th>Last Name</th>\n                <th>First Name</th>\n                  <th>Status</th>\n              </tr>\n            </thead>\n            <tbody>\n            <tr \n                v-for=\"student in paginatedStudents\" \n                  :key=\"student.studentNumber\" \n                  class=\"clickable-row\" \n                  @click=\"viewStudentDetails(student)\"\n                  :class=\"{\n                    'status-row-present': student.currentStatus === 'present',\n                    'status-row-absent': student.currentStatus === 'absent',\n                    'status-row-late': student.currentStatus === 'late'\n                  }\"\n            >\n              <td>{{ student.studentNumber }}</td>\n                  <td>{{ student.lastName }}</td>\n                  <td>{{ student.firstName }}</td>\n                  <td>\n                    <div class=\"attendance-status-container\">\n                      <select \n                        class=\"form-select form-select-sm attendance-select\"\n                        :class=\"{\n                          'select-present': student.currentStatus === 'present',\n                          'select-absent': student.currentStatus === 'absent',\n                          'select-late': student.currentStatus === 'late',\n                          'select-none': student.currentStatus === 'none'\n                        }\"\n                        v-model=\"student.currentStatus\"\n                        @change=\"markAttendance(student, $event.target.value)\"\n                        @click.stop\n                      >\n                        <option value=\"none\">Not marked</option>\n                        <option :selected=\"student.currentStatus === 'present'\" value=\"present\">Present</option>\n                        <option :selected=\"student.currentStatus === 'absent'\" value=\"absent\">Absent</option>\n                        <option :selected=\"student.currentStatus === 'late'\" value=\"late\">Late</option>\n                      </select>\n                      <div \n                        class=\"status-indicator\" \n                        :class=\"{\n                          'indicator-present': student.currentStatus === 'present',\n                          'indicator-absent': student.currentStatus === 'absent',\n                          'indicator-late': student.currentStatus === 'late',\n                          'indicator-none': student.currentStatus === 'none'\n                        }\"\n                      >\n                        <i \n                          class=\"fas\" \n                          :class=\"{\n                            'fa-check-circle': student.currentStatus === 'present',\n                            'fa-times-circle': student.currentStatus === 'absent',\n                            'fa-exclamation-circle': student.currentStatus === 'late',\n                            'fa-question-circle': student.currentStatus === 'none'\n                          }\"\n                        ></i>\n                      </div>\n                    </div>\n                  </td>\n              </tr>\n              <tr v-if=\"paginatedStudents.length === 0\">\n                <td colspan=\"4\" class=\"text-center py-4\">\n                  <div class=\"empty-state-message\">\n                    <i class=\"fas fa-users text-muted mb-2\"></i>\n                    <p class=\"mb-0\">No students found</p>\n                    <p class=\"text-muted small\" v-if=\"selectedYear || selectedSection || selectedSubject\">\n                      Try adjusting your filters\n                    </p>\n                  </div>\n                </td>\n              </tr>\n            </tbody>\n          </table>\n          </div>\n        \n        <!-- Pagination Controls -->\n        <div class=\"pagination-controls mt-3 d-flex justify-content-between align-items-center\">\n          <div class=\"pagination-info\">\n            Showing {{ paginationInfo.start }} to {{ paginationInfo.end }} of {{ sortedStudents.length }} entries\n          </div>\n          <div class=\"pagination-buttons\">\n            <button \n              class=\"btn btn-outline-primary me-2\" \n              @click=\"previousPage\" \n              :disabled=\"currentPage === 1\"\n            >\n              <i class=\"fas fa-chevron-left me-1\"></i> Previous\n            </button>\n            <button \n              class=\"btn btn-outline-primary\" \n              @click=\"nextPage\" \n              :disabled=\"currentPage >= totalPages\"\n            >\n              Next <i class=\"fas fa-chevron-right ms-1\"></i>\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n\n    <!-- Calendar Popup -->\n    <div class=\"calendar-popup\" v-if=\"showCalendarPopup\" @click.self=\"showCalendarPopup = false\">\n      <div class=\"calendar-container\">\n        <div class=\"calendar-header\">\n          <h6 class=\"mb-0\">Select Date</h6>\n          <button type=\"button\" class=\"btn-close\" @click=\"showCalendarPopup = false\"></button>\n        </div>\n        <div class=\"calendar-body\">\n          <div class=\"input-group\">\n            <span class=\"input-group-text\"><i class=\"fas fa-calendar-day\"></i></span>\n            <input \n              type=\"date\" \n              class=\"form-control\" \n              :value=\"formatDateForInput(currentDate)\"\n              :max=\"formatDateForInput(new Date())\"\n              @change=\"setCurrentDate($event.target.value); showCalendarPopup = false\"\n            >\n          </div>\n          \n          <!-- Quick Date Buttons -->\n          <div class=\"quick-date-buttons mt-3\">\n            <button class=\"btn btn-sm btn-outline-secondary\" @click=\"navigateDate(-7); showCalendarPopup = false\">\n              <i class=\"fas fa-angle-double-left me-1\"></i> Last Week\n            </button>\n            <button class=\"btn btn-sm btn-outline-secondary\" @click=\"navigateDate(-1); showCalendarPopup = false\">\n              <i class=\"fas fa-angle-left me-1\"></i> Yesterday\n            </button>\n            <button class=\"btn btn-sm btn-primary\" @click=\"setCurrentDate(formatDateForInput(new Date())); showCalendarPopup = false\">\n              Today\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n\n    <!-- Student Details Modal -->\n    <StudentDetailsModal\n      :show=\"!!selectedStudent\"\n      :student=\"selectedStudent || {}\"\n      :year-level=\"selectedYear\"\n      :section=\"selectedSection\"\n      :subject=\"selectedSubject\"\n      title=\"Student Attendance Details\"\n      chart-title=\"Attendance Overview\"\n      history-title=\"Attendance History\"\n      :chart-id=\"`attendanceChart-${selectedStudent?.studentId}`\"\n      :is-class-record=\"false\"\n      @update:show=\"(value) => !value && (selectedStudent = null)\"\n      @close=\"selectedStudent = null\"\n    >\n      <template #history-table>\n        <table class=\"table\">\n          <thead>\n            <tr>\n              <th>Date</th>\n              <th>Status</th>\n            </tr>\n          </thead>\n          <tbody>\n            <tr v-if=\"!selectedStudent?.attendanceHistory || selectedStudent.attendanceHistory.length === 0\">\n              <td colspan=\"2\" class=\"text-center py-3 text-muted\">\n                <i class=\"fas fa-info-circle me-2\"></i>No attendance records found.\n              </td>\n            </tr>\n            <tr v-for=\"record in selectedStudent?.attendanceHistory\" :key=\"record.date\">\n              <td>{{ formatDate(record.date) }}</td>\n              <td>\n                <span \n                  class=\"badge\"\n                  :class=\"{\n                    'bg-success': record.status === 'present',\n                    'bg-danger': record.status === 'absent',\n                    'bg-warning': record.status === 'late'\n                  }\"\n                >\n                  {{ record.status.charAt(0).toUpperCase() + record.status.slice(1) }}\n                </span>\n              </td>\n            </tr>\n          </tbody>\n        </table>\n      </template>\n    </StudentDetailsModal>\n    \n    <!-- Export Records Modal -->\n    <teleport to=\"body\" v-if=\"showExportModal\">\n      <div class=\"modal-overlay\">\n        <div class=\"modal-wrapper\">\n          <div class=\"modal-dialog\">\n            <div class=\"modal-content\">\n              <div class=\"modal-header\">\n                <h5 class=\"modal-title\">Export Attendance Records</h5>\n                <button type=\"button\" class=\"btn-close\" @click=\"closeExportModal\"></button>\n              </div>\n              <div class=\"modal-body\">\n                <div class=\"alert alert-info\">\n                  <i class=\"fas fa-info-circle me-2\"></i>\n                  Select a date range to export attendance records. Only attendance within this date range will be included.\n                </div>\n\n                <form @submit.prevent=\"exportRecords\">\n                  <div class=\"mb-3\">\n                    <label class=\"form-label\">Start Date</label>\n                    <input type=\"date\" class=\"form-control\" v-model=\"exportDateRange.start\" required>\n                  </div>\n                  <div class=\"mb-3\">\n                    <label class=\"form-label\">End Date</label>\n                    <input type=\"date\" class=\"form-control\" v-model=\"exportDateRange.end\" required>\n                  </div>\n                  \n                  <div class=\"mt-4\">\n                    <div class=\"form-check\">\n                      <input class=\"form-check-input\" type=\"radio\" name=\"exportType\" id=\"exportTypeExcel\" value=\"excel\" v-model=\"exportType\">\n                      <label class=\"form-check-label\" for=\"exportTypeExcel\">\n                        Export to Excel (.xlsx)\n                      </label>\n                    </div>\n                    <div class=\"form-check\">\n                      <input class=\"form-check-input\" type=\"radio\" name=\"exportType\" id=\"exportTypeCsv\" value=\"csv\" v-model=\"exportType\">\n                      <label class=\"form-check-label\" for=\"exportTypeCsv\">\n                        Export to CSV (.csv)\n                      </label>\n                    </div>\n                  </div>\n                  \n                  <div class=\"mt-4 text-end\">\n                    <button type=\"button\" class=\"btn btn-secondary me-2\" @click=\"closeExportModal\">\n                      Cancel\n                    </button>\n                    <button type=\"submit\" class=\"btn btn-success\" :disabled=\"isExporting\">\n                      <span v-if=\"isExporting\">\n                        <i class=\"fas fa-spinner fa-spin me-2\"></i> Exporting...\n                      </span>\n                      <span v-else>\n                        <i class=\"fas fa-file-export me-2\"></i> Export\n                      </span>\n                    </button>\n                  </div>\n                </form>\n              </div>\n            </div>\n          </div>\n        </div>\n        <div class=\"modal-backdrop\" @click=\"closeExportModal\"></div>\n      </div>\n    </teleport>\n  </div>\n</template>\n\n<script>\nimport { ref, computed, onMounted, onUnmounted, watch, nextTick } from 'vue'\nimport { useStore } from 'vuex'\nimport { useRoute, useRouter } from 'vue-router'\nimport axios from 'axios'\nimport moment from 'moment-timezone'\nimport Chart from 'chart.js/auto'\nimport StudentDetailsModal from '@/components/modals/StudentDetailsModal.vue'\nimport * as XLSX from 'xlsx'\n\n// Create axios instance with base URL\nconst api = axios.create({\n  baseURL: 'http://localhost:8000/api',\n  headers: {\n    'Content-Type': 'application/json'\n  }\n});\n\nexport default {\n  name: 'Attendance',\n  components: {\n    StudentDetailsModal\n  },\n  setup() {\n    const store = useStore()\n    const route = useRoute()\n    const router = useRouter()\n    const students = ref([])\n    const searchQuery = ref('')\n    const sortField = ref('lastName')\n    const sortOrder = ref('asc')\n    const selectedStudent = ref(null)\n    const currentDate = ref(moment().tz('Asia/Manila').startOf('day').toDate())\n    const slideDirection = ref('')\n    let attendanceChart = null\n    let dateUpdateInterval = null\n    \n    // Date filter for attendance history\n    const historyStartDate = ref(moment().tz('Asia/Manila').subtract(30, 'days').format('YYYY-MM-DD'))\n    const historyEndDate = ref(moment().tz('Asia/Manila').format('YYYY-MM-DD'))\n    const showHistoryDatePicker = ref(false)\n    const showCalendarPopup = ref(false)\n\n    // Add refs for query parameters\n    const selectedYear = ref(route.query.year || localStorage.getItem('selectedYear') || '')\n    const selectedSection = ref(route.query.section || localStorage.getItem('selectedSection') || '')\n    const selectedSubject = ref(route.query.subject || localStorage.getItem('selectedSubject') || '')\n    \n    // Add refs for available options\n    const availableYears = ref([])\n    const availableSections = ref([])\n    const sectionsByYear = ref({})\n    const teacherSubjects = ref([])\n    \n    // Computed property for filtered sections based on selected year\n    const filteredSections = computed(() => {\n      if (!selectedYear.value) return []\n      return sectionsByYear.value[selectedYear.value] || []\n    })\n    \n    // Function to fetch available years and sections\n    const fetchAvailableYearsAndSections = async () => {\n      try {\n        const token = store.state.auth.token\n        const teacherId = store.state.auth.user?._id\n        \n        if (!teacherId) {\n          console.error('Teacher ID not available')\n          return\n        }\n\n        console.log('Fetching available years and sections for teacher:', teacherId)\n        \n        // Use the teacher-specific endpoint to get only years and sections for this teacher\n        const response = await api.get('/teacher-class-records/available-years-sections', {\n          params: { teacherId },\n          headers: { 'Authorization': `Bearer ${token}` }\n        }).catch(error => {\n          console.error('Error fetching teacher-specific years and sections:', error)\n          \n          // Fall back to the general endpoint if teacher-specific one fails\n          return api.get('/students/available-years-sections', {\n            headers: { 'Authorization': `Bearer ${token}` }\n          })\n        })\n\n        console.log('API Response for years and sections:', response.data)\n\n        if (response.data) {\n          // Set available years and sections from the response\n          availableYears.value = response.data.years || []\n          availableSections.value = response.data.sections || []\n          \n          // Use sectionsByYear from the API response\n          if (response.data.sectionsByYear) {\n            sectionsByYear.value = response.data.sectionsByYear\n          } else {\n            sectionsByYear.value = {}\n            \n            // If we have years and sections but no sectionsByYear mapping,\n            // create a simple mapping where each year has all sections\n            if (availableYears.value.length > 0 && availableSections.value.length > 0) {\n              availableYears.value.forEach(year => {\n                sectionsByYear.value[year] = [...availableSections.value]\n              })\n            }\n          }\n          \n          console.log('Available years:', availableYears.value)\n          console.log('Available sections:', availableSections.value)\n          console.log('Sections by year mapping:', sectionsByYear.value)\n          \n          // If no years are available, don't add default values\n          // This ensures teachers only see years they've added\n          if (availableYears.value.length === 0) {\n            console.log('No years found for this teacher')\n          }\n          \n          // If no sections are available, don't add default values\n          if (availableSections.value.length === 0) {\n            console.log('No sections found for this teacher')\n          }\n        }\n      } catch (error) {\n        console.error('Failed to fetch available years and sections:', error)\n        // Don't set default values - teacher should only see what they've added\n        availableYears.value = []\n        availableSections.value = []\n        sectionsByYear.value = {}\n      }\n    }\n    \n    // Function to fetch teacher subjects\n    const fetchTeacherSubjects = async () => {\n      try {\n        const token = store.state.auth.token\n        const teacherId = store.state.auth.user?._id\n\n        if (!teacherId) {\n          console.error('Teacher ID not available')\n          return\n        }\n\n        // Try to fetch subjects from the teacher class records\n        try {\n          const response = await api.get('/teacher-class-records/available-years-sections', {\n          params: { teacherId },\n          headers: { 'Authorization': `Bearer ${token}` }\n        })\n\n          if (response.data && response.data.subjects && response.data.subjects.length > 0) {\n            teacherSubjects.value = response.data.subjects\n            console.log('Subjects loaded from teacher class records:', teacherSubjects.value)\n          } else {\n            // If no subjects found in class records, try the user endpoint\n            const userResponse = await api.get(`/users/${teacherId}/subjects`, {\n              headers: { 'Authorization': `Bearer ${token}` }\n            })\n            \n            if (userResponse.data && userResponse.data.subjects && userResponse.data.subjects.length > 0) {\n              teacherSubjects.value = userResponse.data.subjects\n              console.log('Subjects loaded from user profile:', teacherSubjects.value)\n            } else {\n              // If still no subjects, use default subjects\n              console.log('No subjects found, using default subjects')\n            }\n          }\n        } catch (error) {\n          console.error('Failed to fetch teacher subjects from class records:', error)\n          \n          // Try the user endpoint as fallback\n          try {\n            const userResponse = await api.get(`/users/${teacherId}/subjects`, {\n              headers: { 'Authorization': `Bearer ${token}` }\n            })\n            \n            if (userResponse.data && userResponse.data.subjects && userResponse.data.subjects.length > 0) {\n              teacherSubjects.value = userResponse.data.subjects\n              console.log('Subjects loaded from user profile (fallback):', teacherSubjects.value)\n            } else {\n              teacherSubjects.value = ['Math', 'Science', 'English', 'History']\n              console.log('No subjects found in user profile, using default subjects')\n            }\n          } catch (userError) {\n            console.error('Failed to fetch teacher subjects from user profile:', userError)\n            teacherSubjects.value = ['Math', 'Science', 'English', 'History']\n            console.log('Using default subjects due to API errors')\n          }\n        }\n      } catch (error) {\n        console.error('Error in fetchTeacherSubjects:', error)\n        teacherSubjects.value = ['Math', 'Science', 'English', 'History']\n      }\n    }\n    \n    // Function to apply filters\n    const applyFilters = async () => {\n      console.log('Applying filters:', {\n        year: selectedYear.value,\n        section: selectedSection.value,\n        subject: selectedSubject.value\n      })\n      \n      // Save selected values to localStorage\n      if (selectedYear.value) localStorage.setItem('selectedYear', selectedYear.value)\n      if (selectedSection.value) localStorage.setItem('selectedSection', selectedSection.value)\n      if (selectedSubject.value) localStorage.setItem('selectedSubject', selectedSubject.value)\n      \n      // Update URL query parameters\n      router.replace({\n        query: {\n          ...route.query,\n          year: selectedYear.value || undefined,\n          section: selectedSection.value || undefined,\n          subject: selectedSubject.value || undefined\n        }\n      })\n      \n      // Always fetch student records when filters are applied\n      await fetchStudentRecords()\n    }\n    \n    // Function to clear filters\n    const clearFilters = () => {\n      selectedYear.value = ''\n      selectedSection.value = ''\n      selectedSubject.value = ''\n      localStorage.removeItem('selectedYear')\n      localStorage.removeItem('selectedSection')\n      localStorage.removeItem('selectedSubject')\n      \n      // Update URL query parameters\n      router.replace({\n        query: {}\n      })\n    }\n\n    // Function to fetch students and their attendance\n    const fetchStudentRecords = async () => {\n      try {\n        const token = store.state.auth.token;\n        const teacherId = store.state.auth.user?._id;\n\n        if (!teacherId) {\n          console.error('Teacher ID not available');\n          return;\n        }\n\n        // Create a params object with the teacher ID\n        const params = { teacherId };\n        \n        // Add any selected filters to the params\n        if (selectedYear.value) params.year = selectedYear.value;\n        if (selectedSection.value) params.section = selectedSection.value;\n        if (selectedSubject.value) params.subject = selectedSubject.value;\n        \n        console.log('Fetching student records with filters:', params);\n        \n        try {\n          const response = await api.get('/teacher-class-records/students-for-attendance', {\n            params,\n            headers: {\n              'Authorization': `Bearer ${token}`\n            }\n          });\n\n          console.log('Students API response:', response.data);\n\n          if (response.data) {\n            let studentList = [];\n            \n            if (Array.isArray(response.data)) {\n              studentList = response.data;\n            } else if (response.data.students && Array.isArray(response.data.students)) {\n              studentList = response.data.students;\n            }\n            \n            // Log each student's data to verify studentId is present\n            studentList.forEach(student => {\n              console.log('Student data:', {\n                studentId: student._id || student.studentId,\n                studentNumber: student.studentNumber,\n                name: `${student.firstName} ${student.lastName}`\n              });\n            });\n            \n            // Initialize students with 'none' status and ensure studentId is set\n            students.value = studentList.map(student => ({\n              ...student,\n              studentId: student._id || student.studentId, // Use _id if studentId is not present\n              currentStatus: 'none'\n            }));\n            \n            console.log(`Loaded ${students.value.length} students with IDs`);\n            \n            // Immediately fetch attendance after loading students\n            if (students.value.length > 0) {\n              await fetchAttendance();\n          }\n        }\n      } catch (error) {\n          console.error('Failed to fetch student records:', error);\n        students.value = [];\n      }\n      } catch (error) {\n        console.error('Error in fetchStudentRecords:', error);\n        students.value = [];\n      }\n    };\n\n    // Function to fetch attendance for current date\n    const fetchAttendance = async () => {\n      try {\n        // If there are no students, we can't fetch attendance\n        if (!students.value.length) {\n          console.log('fetchAttendance: No students to fetch attendance for');\n          return;\n        }\n\n        const date = moment(currentDate.value).tz('Asia/Manila').startOf('day').format('YYYY-MM-DD');\n        console.log('fetchAttendance: Fetching attendance data for date:', date);\n\n        // Create params object with the date and required filters\n        const params = {\n          teacherId: store.state.auth.user?._id,\n          date: date\n        };\n        \n        // Add any selected filters to the params\n        if (selectedYear.value) params.year = selectedYear.value;\n        if (selectedSection.value) params.section = selectedSection.value;\n        if (selectedSubject.value) params.subject = selectedSubject.value;\n        \n        console.log('Fetching attendance with params:', params);\n        \n        const response = await api.get(`/attendance/date/${date}`, {\n          params,\n          headers: { 'Authorization': `Bearer ${store.state.auth.token}` }\n        });\n\n        console.log('Attendance data received:', response.data);\n\n        // Create a map to store attendance by student ID\n        const studentMap = new Map();\n\n        if (response.data && Array.isArray(response.data)) {\n          console.log(`Processing ${response.data.length} attendance records`);\n          \n          // Group records by student ID to find the most recent one for each student\n          const recordsByStudent = {};\n          \n          response.data.forEach(record => {\n            if (record.studentId) {\n              // If we don't have this student yet, or this record is newer\n              if (!recordsByStudent[record.studentId] || \n                  (record.createdAt && \n                   (!recordsByStudent[record.studentId].createdAt || \n                    new Date(record.createdAt) > new Date(recordsByStudent[record.studentId].createdAt)))) {\n                recordsByStudent[record.studentId] = record;\n                console.log(`Found newer record for student ${record.studentId}: ${record.status} (created at ${record.createdAt})`);\n              }\n            } else {\n              console.log('Record missing studentId:', record);\n            }\n          });\n          \n          // Now use the most recent record for each student\n          Object.values(recordsByStudent).forEach(record => {\n            studentMap.set(String(record.studentId), record.status || 'none');\n            console.log(`Using most recent attendance for student ID ${record.studentId}: ${record.status || 'none'} (created at ${record.createdAt})`);\n          });\n        }\n\n        // Update students with attendance data\n        if (students.value && students.value.length > 0) {\n          // Merge attendance data into students array\n          // This will fix the updating of attendance data\n          students.value = students.value\n            .map(student => ({\n              ...student,\n              currentStatus: response.data.find(att => att.studentId === student.studentId)?.status\n            }));\n          \n          // Force a UI update\n          await nextTick();\n          students.value = [...students.value];\n          console.log('Updated attendance status for all students');\n        }\n      } catch (error) {\n        console.error('Error in fetchAttendance:', error);\n      }\n    };\n\n    // Create attendance chart\n    const createPerformanceChart = () => {\n      if (!selectedStudent.value) return;\n      \n      // Create a unique chart ID for each student\n      const chartId = `attendanceChart-${selectedStudent.value.studentId}`;\n      const chartElement = document.getElementById('attendanceChart');\n      \n      // Set a unique ID to the chart element\n      if (chartElement) {\n        chartElement.id = chartId;\n      }\n      \n      const ctx = document.getElementById(chartId)?.getContext('2d');\n      if (!ctx) return;\n\n      // Destroy existing chart if it exists\n      if (attendanceChart) {\n        attendanceChart.destroy();\n        attendanceChart = null;\n      }\n\n      // Get the chart container\n      const chartContainer = document.querySelector('.chart-container');\n      if (!chartContainer) return;\n\n      // Check if we have valid attendance statistics and records\n      const stats = selectedStudent.value.attendanceStats;\n      const hasAttendanceRecords = selectedStudent.value.attendanceHistory && \n                                  selectedStudent.value.attendanceHistory.length > 0;\n      \n      if (!hasAttendanceRecords || \n          !stats || \n          (stats.presentPercentage === 0 && stats.absentPercentage === 0 && stats.latePercentage === 0)) {\n        // If no attendance data, display a message instead of an empty chart\n        chartContainer.innerHTML = '';\n        const noDataMessage = document.createElement('div');\n        noDataMessage.className = 'text-center py-5 text-muted';\n        noDataMessage.innerHTML = '<i class=\"fas fa-info-circle me-2\"></i>No attendance data available for this student in the selected date range.';\n        chartContainer.appendChild(noDataMessage);\n        return;\n      }\n\n      // Clear the container and add canvas back\n      chartContainer.innerHTML = '';\n      const canvas = document.createElement('canvas');\n      canvas.id = chartId;\n      chartContainer.appendChild(canvas);\n\n      // Get the context from the new canvas\n      const newCtx = document.getElementById(chartId)?.getContext('2d');\n      if (!newCtx) return;\n\n      // Enhanced colors for the chart\n      const chartColors = {\n        present: {\n          backgroundColor: '#4CAF50',\n          hoverBackgroundColor: '#388E3C',\n          borderColor: '#fff',\n          borderWidth: 2\n        },\n        absent: {\n          backgroundColor: '#F44336',\n          hoverBackgroundColor: '#D32F2F',\n          borderColor: '#fff',\n          borderWidth: 2\n        },\n        late: {\n          backgroundColor: '#FFC107',\n          hoverBackgroundColor: '#FFA000',\n          borderColor: '#fff',\n          borderWidth: 2\n        }\n      };\n\n      // Create the chart\n      attendanceChart = new Chart(newCtx, {\n        type: 'doughnut',\n        data: {\n          labels: ['Present', 'Absent', 'Late'],\n          datasets: [{\n            data: [stats.presentPercentage, stats.absentPercentage, stats.latePercentage],\n            backgroundColor: [\n              chartColors.present.backgroundColor,\n              chartColors.absent.backgroundColor,\n              chartColors.late.backgroundColor\n            ],\n            hoverBackgroundColor: [\n              chartColors.present.hoverBackgroundColor,\n              chartColors.absent.hoverBackgroundColor,\n              chartColors.late.hoverBackgroundColor\n            ],\n            borderColor: [\n              chartColors.present.borderColor,\n              chartColors.absent.borderColor,\n              chartColors.late.borderColor\n            ],\n            borderWidth: 2,\n            borderRadius: 5,\n            spacing: 5,\n            hoverOffset: 10\n          }]\n        },\n        options: {\n          responsive: true,\n          maintainAspectRatio: false,\n          cutout: '70%',\n          animation: {\n            animateScale: true,\n            animateRotate: true,\n            duration: 1000,\n            easing: 'easeOutQuart'\n          },\n          plugins: {\n            legend: {\n              position: 'bottom',\n              labels: {\n                padding: 20,\n                boxWidth: 15,\n                boxHeight: 15,\n                font: {\n                  size: 14,\n                  weight: 'bold'\n                },\n                generateLabels: (chart) => {\n                  const data = chart.data;\n                  if (data.labels.length && data.datasets.length) {\n                    return data.labels.map((label, i) => {\n                      const meta = chart.getDatasetMeta(0);\n                      const style = meta.controller.getStyle(i);\n                      \n                      return {\n                        text: `${label}: ${data.datasets[0].data[i].toFixed(1)}%`,\n                        fillStyle: style.backgroundColor,\n                        strokeStyle: style.borderColor,\n                        lineWidth: style.borderWidth,\n                        hidden: isNaN(data.datasets[0].data[i]) || meta.data[i].hidden,\n                        index: i\n                      };\n                    });\n                  }\n                  return [];\n                }\n              }\n            },\n            tooltip: {\n              backgroundColor: 'rgba(0, 0, 0, 0.8)',\n              titleFont: {\n                size: 16,\n                weight: 'bold'\n              },\n              bodyFont: {\n                size: 14\n              },\n              padding: 15,\n              cornerRadius: 8,\n              displayColors: true,\n              callbacks: {\n                label: function(context) {\n                  const label = context.label || '';\n                  const value = context.raw || 0;\n                  return `${label}: ${value.toFixed(1)}%`;\n                }\n              }\n            }\n          }\n        }\n      });\n    }\n\n    // View student details\n    const viewStudentDetails = async (student) => {\n      try {\n        // Reset any existing chart before showing a new student\n        if (attendanceChart) {\n          attendanceChart.destroy();\n          attendanceChart = null;\n        }\n        \n        selectedStudent.value = {\n          ...student,\n          attendanceHistory: [],\n          attendanceStats: { presentPercentage: 0, absentPercentage: 0, latePercentage: 0 }\n        }\n        \n        // Fetch attendance history with the current date filters\n        await fetchStudentAttendanceHistory(selectedStudent.value);\n      } catch (error) {\n        console.error('Error fetching student details:', error)\n        alert('Failed to load student details. Please try again.')\n      }\n    }\n    \n    // Fetch student attendance history with date filters\n    const fetchStudentAttendanceHistory = async (student) => {\n      if (!student) return;\n      \n      try {\n        console.log(`Fetching attendance history for student ${student.studentNumber} with date range:`, {\n          startDate: historyStartDate.value,\n          endDate: historyEndDate.value\n        });\n        \n        const response = await api.get(\n          `/attendance/${student.studentId}/history`,\n          {\n            params: {\n              subject: selectedSubject.value,\n              startDate: historyStartDate.value,\n              endDate: historyEndDate.value\n            },\n            headers: { 'Authorization': `Bearer ${store.state.auth.token}` }\n          }\n        )\n        \n        if (response.data) {\n          // Make sure we're updating the correct student\n          if (selectedStudent.value && selectedStudent.value.studentId === student.studentId) {\n            // Only include records that have a valid status (not null, undefined, or empty string)\n            const validRecords = Array.isArray(response.data.records) \n              ? response.data.records.filter(record => record && record.status && record.status !== '')\n              : [];\n            \n            selectedStudent.value.attendanceHistory = validRecords;\n            \n            // Only calculate statistics based on valid records\n            if (validRecords.length > 0) {\n              // Count occurrences of each status\n              const statusCounts = {\n                present: 0,\n                absent: 0,\n                late: 0\n              };\n              \n              validRecords.forEach(record => {\n                if (record.status in statusCounts) {\n                  statusCounts[record.status]++;\n                }\n              });\n              \n              // Calculate percentages\n              const total = validRecords.length;\n              const presentPercentage = total > 0 ? (statusCounts.present / total) * 100 : 0;\n              const absentPercentage = total > 0 ? (statusCounts.absent / total) * 100 : 0;\n              const latePercentage = total > 0 ? (statusCounts.late / total) * 100 : 0;\n              \n              selectedStudent.value.attendanceStats = {\n                presentPercentage,\n                absentPercentage,\n                latePercentage\n              };\n      } else {\n              // If no valid records, set all percentages to 0\n              selectedStudent.value.attendanceStats = {\n                presentPercentage: 0,\n                absentPercentage: 0,\n                latePercentage: 0\n              };\n            }\n            \n            console.log(`Loaded ${selectedStudent.value.attendanceHistory.length} attendance records for student ${student.studentNumber}`);\n            \n            // Create attendance chart on next tick to ensure DOM is ready\n            nextTick(() => {\n              // Reset any existing chart before creating a new one\n              if (attendanceChart) {\n                attendanceChart.destroy();\n                attendanceChart = null;\n              }\n              createPerformanceChart();\n            });\n          } else {\n            console.log('Selected student changed, not updating attendance history');\n          }\n        }\n      } catch (error) {\n        console.error('Error fetching student attendance history:', error);\n        selectedStudent.value.attendanceHistory = [];\n        selectedStudent.value.attendanceStats = { \n          presentPercentage: 0, \n          absentPercentage: 0, \n          latePercentage: 0 \n        };\n        \n        // Create chart with empty data\n        nextTick(() => {\n          if (attendanceChart) {\n            attendanceChart.destroy();\n            attendanceChart = null;\n          }\n          createPerformanceChart();\n        });\n      }\n    }\n\n    // Sort functions\n    const sortBy = (field) => {\n      if (sortField.value === field) {\n        sortOrder.value = sortOrder.value === 'asc' ? 'desc' : 'asc'\n      } else {\n        sortField.value = field\n        sortOrder.value = 'asc'\n      }\n    }\n\n    const getSortIcon = (field) => {\n      if (sortField.value !== field) return 'fas fa-sort'\n      return sortOrder.value === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'\n    }\n\n    // Sort students\n    const sortedStudents = computed(() => {\n      if (!Array.isArray(students.value)) {\n        return []\n      }\n\n      let sortedList = [...students.value]\n      if (sortField.value) {\n        sortedList.sort((a, b) => {\n          let aVal = a[sortField.value]\n          let bVal = b[sortField.value]\n          if (typeof aVal === 'string') aVal = aVal.toLowerCase()\n          if (typeof bVal === 'string') bVal = bVal.toLowerCase()\n          if (aVal < bVal) return sortOrder.value === 'asc' ? -1 : 1\n          if (aVal > bVal) return sortOrder.value === 'asc' ? 1 : -1\n          return 0\n        })\n      }\n\n      if (!searchQuery.value) {\n      return sortedList\n      }\n      \n      const searchLower = searchQuery.value.toLowerCase()\n      return sortedList.filter(student => {\n        return (\n          student.studentNumber.toLowerCase().includes(searchLower) ||\n          student.firstName.toLowerCase().includes(searchLower) ||\n          student.lastName.toLowerCase().includes(searchLower)\n        )\n      })\n    })\n\n    // Update attendance status\n    const markAttendance = async (student, status) => {\n      try {\n        if (!status || !student) {\n          console.log('Invalid status or student:', { status, student });\n          return;\n        }\n        \n        const date = moment(currentDate.value).tz('Asia/Manila').startOf('day').format('YYYY-MM-DD');\n        console.log('Marking attendance:', {\n          studentId: student.studentId,\n          studentNumber: student.studentNumber,\n          status,\n          date\n        });\n\n        const attendanceData = {\n          studentId: student.studentId,\n          studentNumber: student.studentNumber,\n          teacherId: store.state.auth.user._id,\n          date: date,\n          subject: selectedSubject.value,\n          section: selectedSection.value,\n          year: selectedYear.value,\n          status: status,\n          createdAt: new Date().toISOString() // Ensure we have a current timestamp\n        };\n        \n        // Update UI immediately for better responsiveness\n        student.currentStatus = status;\n\n        const response = await api.post('/attendance', attendanceData, {\n          headers: { 'Authorization': `Bearer ${store.state.auth.token}` }\n        });\n\n        if (response.data) {\n          console.log('Attendance marked successfully:', response.data);\n          \n          // Store the attendance status in the student object for this date\n          if (!student.attendanceByDate) {\n            student.attendanceByDate = {};\n          }\n          student.attendanceByDate[date] = status;\n          \n          // If the student is currently selected in the details modal, update their history\n          if (selectedStudent.value && selectedStudent.value.studentId === student.studentId) {\n            await fetchStudentAttendanceHistory(selectedStudent.value);\n          }\n        }\n      } catch (error) {\n        console.error('Error marking attendance:', error);\n        // Revert the status on error\n        student.currentStatus = 'none';\n        alert('Failed to save attendance. Please try again.');\n      }\n    };\n\n    // Handle search\n    const handleSearch = () => {\n      // The sortedStudents computed property will automatically filter based on searchQuery\n    }\n\n    // Watch for query parameter changes\n    watch([selectedYear, selectedSection, selectedSubject], async () => {\n      // Save selected values to localStorage\n      if (selectedYear.value) localStorage.setItem('selectedYear', selectedYear.value)\n      if (selectedSection.value) localStorage.setItem('selectedSection', selectedSection.value)\n      if (selectedSubject.value) localStorage.setItem('selectedSubject', selectedSubject.value)\n      \n      // Fetch student records and attendance when filters change\n      if (selectedYear.value && selectedSection.value && selectedSubject.value) {\n        await fetchStudentRecords()\n      }\n      \n      // Update navigation title\n      if (selectedYear.value && selectedSection.value && selectedSubject.value) {\n        try {\n          if (router.currentRoute.value.matched[0].components.default.props) {\n            router.currentRoute.value.matched[0].components.default.props.selectedInfo = \n              `${selectedYear.value} - ${selectedSection.value} | ${selectedSubject.value}`\n          }\n        } catch (error) {\n          console.error('Error updating navigation title:', error)\n        }\n      }\n    })\n\n    // Watch for date changes\n    watch(currentDate, async (newDate, oldDate) => {\n      console.log('Current date changed from', moment(oldDate).format('YYYY-MM-DD'), 'to', moment(newDate).format('YYYY-MM-DD'));\n      \n      // Only fetch if we have the required data\n      if (selectedYear.value && selectedSection.value && selectedSubject.value && students.value.length > 0) {\n        console.log('Fetching attendance data for new date');\n        await fetchAttendance();\n      } else {\n        console.log('Skipping attendance fetch due to missing data:', {\n          year: selectedYear.value,\n          section: selectedSection.value,\n          subject: selectedSubject.value,\n          studentsCount: students.value?.length || 0\n        });\n      }\n    });\n\n    // Clean up chart when component unmounts\n    onUnmounted(() => {\n      if (attendanceChart) {\n        attendanceChart.destroy()\n        attendanceChart = null\n      }\n      \n      if (dateUpdateInterval) {\n        clearInterval(dateUpdateInterval)\n      }\n    })\n\n    // Clean up chart when student modal closes\n    watch(() => selectedStudent.value, (newValue, oldValue) => {\n      if (!newValue && attendanceChart) {\n        attendanceChart.destroy();\n        attendanceChart = null;\n        \n        // Reset the chart element ID back to the default\n        if (oldValue) {\n          const chartElement = document.getElementById(`attendanceChart-${oldValue.studentId}`);\n          if (chartElement) {\n            chartElement.id = 'attendanceChart';\n          }\n        }\n      }\n    });\n\n    // Format date for display\n    const formatDate = (date) => {\n      if (!date) return 'N/A'\n      return moment(date).tz('Asia/Manila').format('MMMM D, YYYY')\n    }\n    \n    // Format date for input fields (YYYY-MM-DD)\n    const formatDateForInput = (date) => {\n      if (!date) return ''\n      return moment(date).tz('Asia/Manila').format('YYYY-MM-DD')\n    }\n\n    // Add isNextDayDisabled computed property\n    const isNextDayDisabled = computed(() => {\n      const now = moment().tz('Asia/Manila').startOf('day')\n      const selected = moment(currentDate.value).tz('Asia/Manila').startOf('day')\n      return selected.isSameOrAfter(now, 'day')\n    })\n\n    // Add navigateDate function\n    const navigateDate = (direction) => {\n      const now = moment().tz('Asia/Manila').startOf('day')\n      const newDate = moment(currentDate.value).tz('Asia/Manila').startOf('day').add(direction, 'days')\n      \n      // Only allow navigation to past dates or current date\n      if (direction < 0 || (direction > 0 && !newDate.isAfter(now, 'day'))) {\n        slideDirection.value = direction > 0 ? 'slide-left' : 'slide-right'\n        currentDate.value = newDate.toDate()\n        \n        // Refresh attendance data\n        fetchAttendance(currentDate.value)\n        \n        setTimeout(() => {\n          slideDirection.value = ''\n        }, 300)\n      }\n    }\n\n    // Setup date auto-update to handle timezone correctly\n    const setupDateAutoUpdate = () => {\n      const checkAndUpdateDate = () => {\n        const now = moment().tz('Asia/Manila').startOf('day')\n        const current = moment(currentDate.value).tz('Asia/Manila').startOf('day')\n        \n        // If it's past midnight and we're showing yesterday's date\n        if (now.isAfter(current, 'day')) {\n          currentDate.value = now.toDate()\n          fetchAttendance()\n        }\n      }\n\n      // Clear existing interval if any\n      if (dateUpdateInterval) {\n        clearInterval(dateUpdateInterval)\n      }\n\n      // Check every minute\n      dateUpdateInterval = setInterval(checkAndUpdateDate, 60000)\n    }\n\n    // Add watchers for filter changes\n    watch(selectedYear, (newValue) => {\n      if (newValue) {\n        selectedSection.value = '';\n        selectedSubject.value = '';\n      }\n    });\n\n    watch(selectedSection, (newValue) => {\n      if (newValue) {\n        selectedSubject.value = '';\n      }\n    });\n\n    // Get attendance status for display\n    const getAttendanceStatus = (student) => {\n      // If student has a currentStatus property and it's not 'none', use it\n      if (student.currentStatus && student.currentStatus !== 'none') {\n        return student.currentStatus;\n      }\n      \n      // If no status is set, return 'none'\n      return 'none';\n    }\n\n    // Add setCurrentDate function\n    const setCurrentDate = (dateString) => {\n      if (!dateString) return;\n      \n      const newDate = moment(dateString).tz('Asia/Manila').startOf('day');\n      const now = moment().tz('Asia/Manila').startOf('day');\n      \n      // Only allow setting dates up to the current date\n      if (newDate.isAfter(now, 'day')) {\n        return;\n      }\n      \n      // Set animation direction based on whether we're going forward or backward in time\n      const currentMoment = moment(currentDate.value).tz('Asia/Manila').startOf('day');\n      slideDirection.value = newDate.isAfter(currentMoment) ? 'slide-left' : 'slide-right';\n      \n      // Update the current date\n      currentDate.value = newDate.toDate();\n      \n      // Refresh attendance data\n      fetchAttendance();\n      \n      // Reset animation after transition completes\n      setTimeout(() => {\n        slideDirection.value = '';\n      }, 300);\n    };\n\n    // Reset history date filter to default (last 30 days)\n    const resetHistoryDateFilter = () => {\n      historyStartDate.value = moment().tz('Asia/Manila').subtract(30, 'days').format('YYYY-MM-DD');\n      historyEndDate.value = moment().tz('Asia/Manila').format('YYYY-MM-DD');\n      \n      // Fetch attendance history with the reset date range\n      if (selectedStudent.value) {\n        fetchStudentAttendanceHistory(selectedStudent.value);\n      }\n    };\n\n    // Set history date range based on preset\n    const setHistoryDateRange = (preset) => {\n      const now = moment().tz('Asia/Manila');\n      \n      switch (preset) {\n        case 'week':\n          historyStartDate.value = now.clone().subtract(7, 'days').format('YYYY-MM-DD');\n          break;\n        case 'month':\n          historyStartDate.value = now.clone().subtract(30, 'days').format('YYYY-MM-DD');\n          break;\n        case 'quarter':\n          historyStartDate.value = now.clone().subtract(90, 'days').format('YYYY-MM-DD');\n          break;\n        case 'semester':\n          // Approximately 6 months\n          historyStartDate.value = now.clone().subtract(180, 'days').format('YYYY-MM-DD');\n          break;\n        default:\n          historyStartDate.value = now.clone().subtract(30, 'days').format('YYYY-MM-DD');\n      }\n      \n      historyEndDate.value = now.format('YYYY-MM-DD');\n      \n      // Fetch attendance history with the new date range\n      if (selectedStudent.value) {\n        fetchStudentAttendanceHistory(selectedStudent.value);\n      }\n    };\n\n    // Initialize component\n    onMounted(async () => {\n      if (store.getters.isLoggedIn) {\n        try {\n          console.log('Component mounted, initializing...');\n          \n          // Fetch available years, sections, and subjects\n          await Promise.all([\n            fetchAvailableYearsAndSections(),\n            fetchTeacherSubjects()\n          ]);\n          \n          console.log('Initialization complete, checking for saved filters:', {\n            year: selectedYear.value,\n            section: selectedSection.value,\n            subject: selectedSubject.value\n          });\n          \n          // Apply filters if they are set\n          if (selectedYear.value && selectedSection.value && selectedSubject.value) {\n            console.log('Saved filters found, fetching student records...');\n            await fetchStudentRecords();\n            console.log('Student records loaded');\n          } else {\n            console.log('No saved filters found, skipping data fetch');\n          }\n          \n          // Set up date auto-update\n          setupDateAutoUpdate();\n      } catch (error) {\n          console.error('Error during component initialization:', error);\n        }\n      } else {\n        router.push('/login');\n      }\n    });\n    \n    // Function to refresh attendance data\n    const refreshAttendance = async () => {\n      console.log('Manually refreshing attendance data');\n      \n      // Show loading indicator\n      const refreshButton = document.querySelector('.btn-outline-secondary i.fa-sync-alt');\n      if (refreshButton) {\n        refreshButton.classList.add('fa-spin');\n      }\n      \n      try {\n      // Fetch fresh attendance data from the server\n      await fetchAttendance();\n      \n      // Force a UI update to ensure the changes are reflected\n      nextTick(() => {\n        students.value = [...students.value];\n          console.log('Attendance data refreshed successfully');\n        });\n      } catch (error) {\n        console.error('Error refreshing attendance data:', error);\n      } finally {\n        // Remove loading indicator\n        setTimeout(() => {\n          if (refreshButton) {\n            refreshButton.classList.remove('fa-spin');\n          }\n        }, 500);\n      }\n    };\n\n    // Add openDatePicker function\n    const openDatePicker = () => {\n      const datePicker = document.querySelector('.date-picker-hidden');\n      if (datePicker) {\n        datePicker.click();\n      }\n    }\n\n    // Add openHistoryDatePicker function\n    const openHistoryDatePicker = () => {\n      showHistoryDatePicker.value = true;\n    }\n    \n    // Add applyHistoryDateFilter function\n    const applyHistoryDateFilter = () => {\n      if (selectedStudent.value) {\n        fetchStudentAttendanceHistory(selectedStudent.value);\n      }\n      showHistoryDatePicker.value = false;\n    }\n\n    // Add openCalendarPopup function\n    const openCalendarPopup = () => {\n      showCalendarPopup.value = true;\n    }\n\n    // Add pagination state\n    const currentPage = ref(1)\n    const itemsPerPage = 25\n\n    // Compute total pages\n    const totalPages = computed(() => Math.ceil(sortedStudents.value.length / itemsPerPage))\n\n    // Get paginated students\n    const paginatedStudents = computed(() => {\n      const start = (currentPage.value - 1) * itemsPerPage\n      const end = start + itemsPerPage\n      return sortedStudents.value.slice(start, end)\n    })\n\n    // Compute pagination info\n    const paginationInfo = computed(() => {\n      const start = sortedStudents.value.length === 0 ? 0 : (currentPage.value - 1) * itemsPerPage + 1\n      const end = Math.min(start + itemsPerPage - 1, sortedStudents.value.length)\n      return { start, end }\n    })\n\n    // Pagination methods\n    const nextPage = () => {\n      if (currentPage.value < totalPages.value) {\n        currentPage.value++\n      }\n    }\n\n    const previousPage = () => {\n      if (currentPage.value > 1) {\n        currentPage.value--\n      }\n    }\n\n    // Reset pagination when filters change\n    watch([searchQuery, selectedYear, selectedSection, selectedSubject], () => {\n      currentPage.value = 1\n    })\n\n    // Add clearSearch function if it doesn't exist\n    const clearSearch = () => {\n      searchQuery.value = ''\n      handleSearch()\n    }\n\n    // Add export related refs\n    const showExportModal = ref(false)\n    const exportDateRange = ref({\n      start: moment().subtract(30, 'days').format('YYYY-MM-DD'),\n      end: moment().format('YYYY-MM-DD')\n    })\n    const exportType = ref('excel')\n    const isExporting = ref(false)\n    \n    // Function to export attendance records\n    const exportRecords = async () => {\n      try {\n        isExporting.value = true\n        \n        // Validate date range\n        const startDate = new Date(exportDateRange.value.start)\n        const endDate = new Date(exportDateRange.value.end)\n        \n        if (startDate > endDate) {\n          alert('Start date cannot be after end date')\n          isExporting.value = false\n          return\n        }\n        \n        const teacherId = store.state.auth.user?._id\n        if (!teacherId) {\n          throw new Error('Teacher ID not available')\n        }\n        \n        // Fetch export data from API\n        const response = await api.get('/users/export/attendance', {\n          params: {\n            teacherId,\n            year: selectedYear.value,\n            section: selectedSection.value,\n            subject: selectedSubject.value,\n            startDate: exportDateRange.value.start,\n            endDate: exportDateRange.value.end\n          },\n          headers: {\n            'Authorization': `Bearer ${store.state.auth.token}`\n          }\n        })\n        \n        const data = response.data\n        \n        // Prepare worksheet data\n        const worksheetData = []\n        \n        // Add header rows with class information\n        worksheetData.push(['Attendance Records Export'])\n        worksheetData.push(['Teacher:', data.teacherName])\n        worksheetData.push(['Year:', data.year])\n        worksheetData.push(['Section:', data.section])\n        worksheetData.push(['Subject:', data.subject])\n        worksheetData.push(['Date Range:', data.dateRange])\n        worksheetData.push([]) // Empty row\n        \n        // Add table headers\n        const headers = ['Student Number', 'Last Name', 'First Name']\n        \n        // Add date headers\n        data.dates.forEach(date => {\n          headers.push(moment(date).format('MM/DD/YYYY'))\n        })\n        \n        worksheetData.push(headers)\n        \n        // Add student data rows\n        data.students.forEach(student => {\n          const row = [\n            student.studentNumber,\n            student.lastName,\n            student.firstName\n          ]\n          \n          // Add attendance status for each date\n          data.dates.forEach(date => {\n            const status = student.attendance[date] || 'none'\n            \n            // Capitalize first letter and handle 'none' specially\n            const formattedStatus = status === 'none' ? 'N/A' : \n              status.charAt(0).toUpperCase() + status.slice(1)\n            \n            row.push(formattedStatus)\n          })\n          \n          worksheetData.push(row)\n        })\n        \n        // Create worksheet and workbook\n        const worksheet = XLSX.utils.aoa_to_sheet(worksheetData)\n        const workbook = XLSX.utils.book_new()\n        XLSX.utils.book_append_sheet(workbook, worksheet, 'Attendance Records')\n        \n        // Set column widths\n        const colWidths = [\n          { wch: 15 }, // Student Number\n          { wch: 15 }, // Last Name\n          { wch: 15 }, // First Name\n        ]\n        \n        // Add widths for each date column\n        data.dates.forEach(() => {\n          colWidths.push({ wch: 12 })\n        })\n        \n        worksheet['!cols'] = colWidths\n        \n        // Export based on selected type\n        if (exportType.value === 'excel') {\n          XLSX.writeFile(workbook, `${data.subject}_${data.year}_${data.section}_Attendance.xlsx`)\n        } else {\n          XLSX.writeFile(workbook, `${data.subject}_${data.year}_${data.section}_Attendance.csv`, { bookType: 'csv' })\n        }\n        \n        closeExportModal()\n      } catch (error) {\n        console.error('Error exporting attendance records:', error)\n        alert('Failed to export attendance records. Please try again.')\n      } finally {\n        isExporting.value = false\n      }\n    }\n\n    // Function to open export modal\n    const openExportModal = () => {\n      // Set modal visibility\n      showExportModal.value = true\n      \n      // Add class to body to prevent scrolling when modal is open\n      document.body.classList.add('modal-open')\n      \n      // Reset date range to last 30 days by default\n      exportDateRange.value = {\n        start: moment().subtract(30, 'days').format('YYYY-MM-DD'),\n        end: moment().format('YYYY-MM-DD')\n      }\n      \n      // Log modal opening for debugging\n      console.log('Export modal opened')\n    }\n\n    // Function to close export modal\n    const closeExportModal = () => {\n      showExportModal.value = false\n      document.body.classList.remove('modal-open')\n    }\n\n    return {\n      students,\n      searchQuery,\n      sortedStudents,\n      selectedStudent,\n      currentDate,\n      formatDate,\n      formatDateForInput,\n      navigateDate,\n      isNextDayDisabled,\n      markAttendance,\n      slideDirection,\n      selectedYear,\n      selectedSection,\n      selectedSubject,\n      sortBy,\n      getSortIcon,\n      handleSearch,\n      viewStudentDetails,\n      fetchStudentAttendanceHistory,\n      historyStartDate,\n      historyEndDate,\n      availableYears,\n      availableSections,\n      sectionsByYear,\n      teacherSubjects,\n      filteredSections,\n      fetchAvailableYearsAndSections,\n      fetchTeacherSubjects,\n      applyFilters,\n      clearFilters,\n      getAttendanceStatus,\n      setCurrentDate,\n      resetHistoryDateFilter,\n      setHistoryDateRange,\n      openDatePicker,\n      showHistoryDatePicker,\n      openHistoryDatePicker,\n      applyHistoryDateFilter,\n      showCalendarPopup,\n      openCalendarPopup,\n      refreshAttendance,\n      currentPage,\n      totalPages,\n      paginatedStudents,\n      paginationInfo,\n      nextPage,\n      previousPage,\n      clearSearch,\n      showExportModal,\n      exportDateRange,\n      exportType,\n      isExporting,\n      exportRecords,\n      openExportModal,\n      closeExportModal,\n    }\n  }\n}\n</script>\n\n<style scoped>\n/* Base z-index hierarchy - using ClassRecords approach */\n:root {\n  --z-base: 1;\n  --z-table: 10;\n  --z-controls: 2000;\n  --z-dropdown: 3000;\n  --z-modal-backdrop: 8000;\n  --z-modal-wrapper: 8500;\n  --z-modal-content: 9000;\n  --z-table-header: 20;\n}\n\n/* Modal Styles */\n.modal-overlay {\n  position: fixed;\n  top: 0;\n  left: 0;\n  width: 100vw;\n  height: 100vh;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  z-index: var(--z-modal-wrapper);\n  background-color: rgba(0, 0, 0, 0.5);\n  backdrop-filter: blur(4px);\n}\n\n.modal-wrapper {\n  position: relative;\n  width: 100%;\n  height: 100%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  z-index: var(--z-modal-wrapper);\n}\n\n.modal-dialog {\n  position: relative;\n  width: 90%;\n  max-width: 600px;\n  margin: 1.75rem auto;\n  pointer-events: auto;\n  z-index: var(--z-modal-content);\n}\n\n.modal-content {\n  position: relative;\n  display: flex;\n  flex-direction: column;\n  width: 100%;\n  pointer-events: auto;\n  background-color: #fff;\n  background-clip: padding-box;\n  border: none;\n  border-radius: 0.5rem;\n  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);\n  outline: 0;\n  max-height: calc(100vh - 3.5rem);\n  overflow-y: auto;\n  z-index: var(--z-modal-content);\n}\n\n.modal-backdrop {\n  position: fixed;\n  top: 0;\n  left: 0;\n  width: 100vw;\n  height: 100vh;\n  background-color: rgba(0, 0, 0, 0.5);\n  z-index: var(--z-modal-backdrop);\n}\n\n/* Teleported modals need higher z-index */\n:deep(body > .modal-overlay) {\n  z-index: 9999999 !important;\n  position: fixed !important;\n  top: 0 !important;\n  left: 0 !important;\n  width: 100vw !important;\n  height: 100vh !important;\n  background-color: rgba(0, 0, 0, 0.5) !important;\n}\n\n:deep(body > .modal-wrapper) {\n  z-index: 10000000 !important;\n  position: relative !important;\n  width: 100% !important;\n  height: 100% !important;\n  display: flex !important;\n  align-items: center !important;\n  justify-content: center !important;\n}\n\n:deep(body > .modal-dialog) {\n  z-index: 10000001 !important;\n  position: relative !important;\n  max-width: 600px !important;\n  width: 90% !important;\n  margin: 1.75rem auto !important;\n  pointer-events: auto !important;\n}\n\n:deep(body > .modal-content) {\n  z-index: 10000002 !important;\n  position: relative !important;\n}\n\n/* The rest of the existing styles */\n.attendance-view {\n  max-width: 100%;\n  margin: 0 auto;\n  padding: 0;\n  position: relative;\n}\n\n/* Controls container */\n.controls-container {\n  position: relative;\n  z-index: var(--z-controls);\n  background: white;\n  padding: 1rem;\n  border-radius: 12px;\n  margin-bottom: 1rem;\n}\n\n/* Dropdown styles */\n.dropdown {\n  position: relative;\n  z-index: var(--z-dropdown);\n}\n\n.dropdown-menu {\n  position: absolute;\n  z-index: var(--z-dropdown);\n  transform: none;\n  top: 100%;\n  left: 0;\n  float: none;\n  min-width: 10rem;\n  background-color: #fff;\n  border: none;\n  border-radius: 12px;\n  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);\n  padding: 0.5rem 0;\n  margin-top: 0.5rem;\n}\n\n/* Table container - lower z-index than controls */\n.table-responsive {\n  position: relative;\n  z-index: var(--z-table);\n  background: white;\n  border-radius: 12px;\n  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);\n  overflow: visible;\n  margin-top: 1rem;\n}\n\n.card {\n  border: none;\n  border-radius: 12px;\n  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);\n  overflow: visible !important;\n  position: relative;\n}\n\n.card-body {\n  padding: 1.5rem;\n  position: relative;\n}\n\n/* Table controls container */\n.table-controls {\n  position: relative;\n  z-index: 2000;\n  background: white;\n  padding: 1rem;\n  border-radius: 12px;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n  margin-bottom: 1rem;\n  overflow: visible;\n}\n\n/* Dropdown button */\n.btn-control {\n  position: relative;\n  background: #f8fafc;\n  border: 1px solid #e2e8f0;\n  color: #4a5568;\n  font-size: 0.9rem;\n  padding: 0.5rem 1rem;\n  display: flex;\n  align-items: center;\n  gap: 0.5rem;\n  border-radius: 8px;\n  transition: all 0.2s ease;\n  z-index: var(--z-controls);\n}\n\n.btn-control:hover {\n  background: #f1f5f9;\n  border-color: #cbd5e1;\n  color: #2d3748;\n}\n\n/* Dropdown menu */\n.control-menu {\n  border: none;\n  border-radius: 12px;\n  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);\n  padding: 0.5rem 0;\n  margin-top: 0.5rem;\n  z-index: var(--z-dropdown);\n  position: absolute;\n  min-width: 10rem;\n  background-color: #fff;\n}\n\n/* Override Bootstrap's dropdown styles */\n.dropdown-menu.show {\n  display: block;\n  z-index: var(--z-dropdown);\n  position: absolute;\n}\n\n.dropdown-item {\n  padding: 0.6rem 1rem;\n  font-size: 0.9rem;\n  color: #4a5568;\n  display: flex;\n  align-items: center;\n  gap: 0.5rem;\n}\n\n.dropdown-item:hover {\n  background-color: #f8fafc;\n  color: #2d3748;\n}\n\n.dropdown-header {\n  color: #2d3748;\n  font-weight: 600;\n  font-size: 1rem;\n}\n\n.filter-badge {\n  position: absolute;\n  top: -6px;\n  right: -6px;\n  background: #e53e3e;\n  color: white;\n  width: 18px;\n  height: 18px;\n  border-radius: 50%;\n  font-size: 0.7rem;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  border: 2px solid white;\n}\n\n.search-control {\n  position: relative;\n  z-index: var(--z-controls);\n}\n\n/* Table styles from ClassRecords */\n.table {\n  width: 100%;\n  margin-bottom: 0;\n  color: #4a5568;\n  vertical-align: top;\n  border-color: #e2e8f0;\n}\n\n.table th {\n  position: sticky;\n  top: 0;\n  z-index: var(--z-table-header);\n  background-color: #f8f9fa;\n  color: #666;\n  font-weight: 600;\n  padding: 0.75rem 1rem;\n  border-top: none;\n  white-space: nowrap;\n  vertical-align: bottom;\n  border-bottom: 2px solid #e2e8f0;\n}\n\n.table td {\n  padding: 0.75rem 1rem;\n  vertical-align: middle;\n  border-color: #eee;\n  border-top: 1px solid #e2e8f0;\n}\n\n.table tbody tr:hover {\n  background-color: #f8f9fa;\n}\n\n.table-hover tbody tr:hover {\n  background-color: rgba(0, 0, 0, 0.02);\n}\n\n.clickable-row {\n  cursor: pointer;\n  transition: background-color 0.2s;\n}\n\n.clickable-row:hover {\n  background-color: rgba(0, 0, 0, 0.02);\n}\n\n.date-display {\n  font-size: 1.1rem;\n  font-weight: 500;\n  color: #495057;\n  padding: 0.5rem 1rem;\n  background: #fff;\n  border-radius: 0.5rem;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n  min-width: 200px;\n  text-align: center;\n  cursor: pointer;\n  transition: all 0.2s;\n}\n\n.date-display:hover {\n  background: #f8fafc;\n}\n\n.empty-state-message {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  gap: 0.5rem;\n  padding: 2rem;\n  color: #6c757d;\n}\n\n.empty-state-message i {\n  font-size: 2rem;\n}\n\n.pagination-controls {\n  background: white;\n  padding: 1rem;\n  border-top: 1px solid #e2e8f0;\n}\n\n.pagination-info {\n  color: #4a5568;\n  font-size: 0.9rem;\n}\n\n.pagination-buttons .btn {\n  min-width: 100px;\n}\n\n.status-badge {\n  padding: 0.5em 0.75em;\n  border-radius: 0.375rem;\n  font-weight: 500;\n  font-size: 0.875rem;\n  text-transform: capitalize;\n}\n\n.status-present {\n  background-color: #48bb78;\n  color: white;\n}\n\n.status-absent {\n  background-color: #f56565;\n  color: white;\n}\n\n.status-late {\n  background-color: #ed8936;\n  color: white;\n}\n\n.status-excused {\n  background-color: #4299e1;\n  color: white;\n}\n\n.calendar-popup {\n  position: fixed;\n  top: 0;\n  left: 0;\n  width: 100vw;\n  height: 100vh;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  z-index: var(--z-modal-wrapper);\n  background-color: rgba(0, 0, 0, 0.5);\n}\n\n.calendar-container {\n  position: relative;\n  background: white;\n  border-radius: 12px;\n  padding: 1.5rem;\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n  z-index: var(--z-modal-content);\n  max-width: 400px;\n  width: 100%;\n}\n\n.calendar-header {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  margin-bottom: 1rem;\n}\n\n.calendar-body {\n  margin-bottom: 1rem;\n}\n\n.quick-date-buttons {\n  display: flex;\n  gap: 0.5rem;\n  flex-wrap: wrap;\n  justify-content: space-between;\n}\n\n.student-details {\n  display: grid;\n  grid-template-columns: 350px 1fr;\n  gap: 1.5rem;\n}\n\n.chart-section {\n  position: relative;\n  z-index: var(--z-modal-content);\n  background: white;\n  border-radius: 12px;\n  padding: 2rem;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n}\n\n.chart-section h6 {\n  color: #2d3748;\n  font-size: 1.4rem;\n  font-weight: 600;\n  margin-bottom: 2rem;\n  padding-bottom: 1rem;\n  border-bottom: 2px solid #e2e8f0;\n}\n\n.attendance-table {\n  margin-top: 1rem;\n  font-size: 1.1rem;\n}\n\n.attendance-table th {\n  font-size: 1.1rem;\n  font-weight: 600;\n  color: #2d3748;\n  background: white;\n  position: sticky;\n  top: 0;\n  z-index: var(--z-table-header);\n}\n\n.attendance-table td {\n  font-size: 1.1rem;\n  color: #4a5568;\n}\n\n.badge {\n  font-size: 1rem;\n  padding: 0.5em 1em;\n}\n\n/* Chart container */\n.chart-container {\n  position: relative;\n  width: 100%;\n  height: 300px;\n}\n\n/* Add these styles for attendance status */\n.attendance-status-container {\n  display: flex;\n  align-items: center;\n  gap: 10px;\n  position: relative;\n}\n\n.attendance-select {\n  flex: 1;\n  padding-right: 2.5rem;\n  border-radius: 6px;\n  border: 1px solid #e2e8f0;\n  transition: all 0.2s;\n}\n\n.select-present {\n  border-color: #48bb78;\n  background-color: rgba(72, 187, 120, 0.1);\n}\n\n.select-absent {\n  border-color: #f56565;\n  background-color: rgba(245, 101, 101, 0.1);\n}\n\n.select-late {\n  border-color: #ed8936;\n  background-color: rgba(237, 137, 54, 0.1);\n}\n\n.select-none {\n  border-color: #a0aec0;\n  background-color: rgba(160, 174, 192, 0.1);\n}\n\n.status-indicator {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  width: 28px;\n  height: 28px;\n  border-radius: 50%;\n  font-size: 1rem;\n  color: white;\n}\n\n.indicator-present {\n  background-color: #48bb78;\n}\n\n.indicator-absent {\n  background-color: #f56565;\n}\n\n.indicator-late {\n  background-color: #ed8936;\n}\n\n.indicator-none {\n  background-color: #a0aec0;\n}\n\n/* Add these styles for status row highlighting */\n.status-row-present {\n  background-color: rgba(72, 187, 120, 0.05);\n}\n\n.status-row-absent {\n  background-color: rgba(245, 101, 101, 0.05);\n}\n\n.status-row-late {\n  background-color: rgba(237, 137, 54, 0.05);\n}\n</style> \n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}