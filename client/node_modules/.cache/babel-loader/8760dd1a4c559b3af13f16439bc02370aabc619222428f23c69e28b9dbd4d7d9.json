{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.filter.js\";\nimport \"core-js/modules/es.iterator.for-each.js\";\nimport \"core-js/modules/es.iterator.map.js\";\nimport \"core-js/modules/es.set.difference.v2.js\";\nimport \"core-js/modules/es.set.intersection.v2.js\";\nimport \"core-js/modules/es.set.is-disjoint-from.v2.js\";\nimport \"core-js/modules/es.set.is-subset-of.v2.js\";\nimport \"core-js/modules/es.set.is-superset-of.v2.js\";\nimport \"core-js/modules/es.set.symmetric-difference.v2.js\";\nimport \"core-js/modules/es.set.union.v2.js\";\nimport { ref, computed, onMounted, onUnmounted, watch, nextTick } from 'vue';\nimport { useStore } from 'vuex';\nimport { useRoute, useRouter } from 'vue-router';\nimport axios from 'axios';\nimport moment from 'moment-timezone';\nimport Chart from 'chart.js/auto';\nimport 'chartjs-adapter-moment';\nimport StudentDetailsModal from '@/components/modals/StudentDetailsModal.vue';\n\n// Create axios instance with base URL\nconst api = axios.create({\n  baseURL: 'http://localhost:8000/api',\n  headers: {\n    'Content-Type': 'application/json'\n  },\n  timeout: 10000,\n  // 10 seconds timeout\n  validateStatus: function (status) {\n    return status >= 200 && status < 500; // Accept all status codes from 200-499\n  }\n});\n\n// Add request interceptor for logging\napi.interceptors.request.use(config => {\n  console.log(`API Request: ${config.method.toUpperCase()} ${config.url}`, config.data || config.params);\n  return config;\n}, error => {\n  console.error('API Request Error:', error);\n  return Promise.reject(error);\n});\n\n// Add response interceptor for logging\napi.interceptors.response.use(response => {\n  console.log(`API Response: ${response.status} ${response.config.url}`, response.data);\n  return response;\n}, error => {\n  if (error.response) {\n    console.error(`API Error Response: ${error.response.status} ${error.config?.url}`, error.response.data);\n  } else if (error.request) {\n    console.error('API No Response:', error.request);\n  } else {\n    console.error('API Error:', error.message);\n  }\n  return Promise.reject(error);\n});\nexport default {\n  name: 'ClassRecords',\n  components: {\n    StudentDetailsModal\n  },\n  setup() {\n    const store = useStore();\n    const router = useRouter();\n    const user = ref(store.state.auth.user || null);\n\n    // Add user profile fetching\n    const fetchUserProfile = async () => {\n      try {\n        console.log('Fetching user profile...');\n        const response = await api.get('/users/profile', {\n          headers: {\n            'Authorization': `Bearer ${store.state.auth.token}`\n          }\n        });\n        console.log('User profile response:', response.data);\n        user.value = response.data;\n\n        // Check if user is a teacher\n        if (!user.value || user.value.role !== 'teacher') {\n          console.log('User is not a teacher:', user.value?.role);\n          router.push('/dashboard');\n          return;\n        }\n\n        // Log teaching year and subjects\n        console.log('Teaching year:', user.value.teachingYear);\n        console.log('Subjects:', user.value.subjects);\n\n        // If teaching year is not set, default to '1st'\n        if (!user.value.teachingYear) {\n          console.log('Teaching year not set, defaulting to 1st');\n          user.value.teachingYear = '1st';\n        }\n      } catch (error) {\n        console.error('Error fetching user profile:', error);\n        router.push('/login');\n      }\n    };\n\n    // Call fetchUserProfile when component mounts\n    onMounted(async () => {\n      try {\n        console.log('Component mounted, fetching user profile and subjects');\n        await fetchUserProfile();\n        console.log('User profile fetched, now fetching user preferences');\n\n        // First check localStorage for preferences\n        const localPrefs = localStorage.getItem('classRecordPreferences');\n        if (localPrefs) {\n          try {\n            const prefs = JSON.parse(localPrefs);\n            console.log('Found preferences in localStorage:', prefs);\n\n            // Apply local preferences immediately\n            if (prefs.selectedYear) selectedYear.value = prefs.selectedYear;\n            if (prefs.selectedSection) selectedSection.value = prefs.selectedSection;\n            if (prefs.selectedSubject) selectedSubject.value = prefs.selectedSubject;\n            if (prefs.currentPage) currentPage.value = parseInt(prefs.currentPage) || 1;\n          } catch (parseError) {\n            console.error('Error parsing localStorage preferences:', parseError);\n          }\n        } else {\n          // If no preferences in localStorage, try to load last used filters\n          await loadLastUsedFilters();\n        }\n\n        // Then fetch from API\n        await fetchUserPreferences();\n\n        // Ensure we have the necessary data to fetch records\n        if (selectedYear.value && selectedSection.value && selectedSubject.value) {\n          console.log('Fetching available sections for year:', selectedYear.value);\n          await fetchAvailableSections();\n          console.log('Updating teacher subjects for section:', selectedSection.value);\n          await updateTeacherSubjects();\n          console.log('Fetching class data for subject:', selectedSubject.value);\n          await fetchClassData();\n        } else {\n          console.log('Missing required filters, cannot fetch class data');\n          // Try to load last used filters if we still don't have them\n          if (!selectedYear.value || !selectedSection.value || !selectedSubject.value) {\n            await loadLastUsedFilters();\n\n            // Try again with the loaded filters\n            if (selectedYear.value) {\n              await fetchAvailableSections();\n              if (selectedSection.value) {\n                await updateTeacherSubjects();\n                if (selectedSubject.value) {\n                  await fetchClassData();\n                }\n              }\n            }\n          }\n        }\n        console.log('Initial data loading complete');\n      } catch (error) {\n        console.error('Error during component initialization:', error);\n      }\n    });\n    const selectedYear = ref('');\n    const selectedSection = ref('');\n    const selectedSubject = ref('');\n    const searchQuery = ref('');\n    const students = ref([]);\n    const assessments = ref([]);\n    const currentDate = ref(moment().tz('Asia/Manila').startOf('day').toDate());\n    const showAddAssessmentModal = ref(false);\n    const selectedStudent = ref(null);\n    const quizChart = ref(null);\n    const activityChart = ref(null);\n    const performanceChart = ref(null);\n    const showAddStudentRecordModal = ref(false);\n    const showSearch = ref(false);\n    const sortField = ref('');\n    const sortOrder = ref('asc');\n    const newStudentRecord = ref({\n      year: '',\n      section: '',\n      subject: ''\n    });\n\n    // Add new refs for filters\n    const selectedAssessmentType = ref('');\n    const showChartDateFilter = ref(false);\n    const showHistoryDateFilter = ref(false);\n    const chartDateRange = ref({\n      start: moment().subtract(30, 'days').format('YYYY-MM-DD'),\n      end: moment().format('YYYY-MM-DD')\n    });\n    const historyDateRange = ref({\n      start: moment().subtract(30, 'days').format('YYYY-MM-DD'),\n      end: moment().format('YYYY-MM-DD')\n    });\n    const newAssessment = ref({\n      type: '',\n      number: '',\n      maxScore: ''\n    });\n\n    // State for available years, sections, and subjects\n    const availableYears = ref([]);\n    const availableSections = ref([]);\n    const sectionsByYear = ref({});\n    const teacherSubjects = ref([]);\n    const teachingYear = computed(() => {\n      console.log('User object:', user.value);\n      console.log('Teaching year:', user.value?.teachingYear);\n      return user.value?.teachingYear || 'N/A';\n    });\n\n    // Get available subjects based on teaching year\n    const availableSubjects = computed(() => {\n      const year = teachingYear.value;\n      switch (year) {\n        case '1st':\n          return ['ITE 100', 'ITE 101', 'ITE 102', 'ITE 103'];\n        case '2nd':\n          return ['ITE 200', 'ITE 201', 'ITE 202', 'ITE 203'];\n        case '3rd':\n          return ['ITE 301', 'ITE 302', 'ITE 303', 'ITE 304'];\n        case '4th':\n          return ['ITE 400', 'ITE 401', 'ITE 402', 'ITE 403', 'ITE 404'];\n        default:\n          return [];\n      }\n    });\n\n    // Filter students\n    const filteredStudents = computed(() => {\n      return students.value.filter(student => {\n        const searchLower = searchQuery.value.toLowerCase();\n        return student.studentNumber.toLowerCase().includes(searchLower) || student.firstName.toLowerCase().includes(searchLower) || student.lastName.toLowerCase().includes(searchLower);\n      });\n    });\n\n    // Sort students\n    const sortedStudents = computed(() => {\n      let sortedList = [...filteredStudents.value];\n      if (sortField.value) {\n        sortedList.sort((a, b) => {\n          let aVal = a[sortField.value];\n          let bVal = b[sortField.value];\n\n          // Handle case-insensitive string comparison\n          if (typeof aVal === 'string') aVal = aVal.toLowerCase();\n          if (typeof bVal === 'string') bVal = bVal.toLowerCase();\n          if (aVal < bVal) return sortOrder.value === 'asc' ? -1 : 1;\n          if (aVal > bVal) return sortOrder.value === 'asc' ? 1 : -1;\n          return 0;\n        });\n      }\n      return sortedList;\n    });\n\n    // Sort functions\n    const sortBy = field => {\n      if (sortField.value === field) {\n        sortOrder.value = sortOrder.value === 'asc' ? 'desc' : 'asc';\n      } else {\n        sortField.value = field;\n        sortOrder.value = 'asc';\n      }\n    };\n    const getSortIcon = field => {\n      if (sortField.value !== field) return 'fas fa-sort';\n      return sortOrder.value === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';\n    };\n\n    // Search functions\n    const toggleSearch = () => {\n      showSearch.value = !showSearch.value;\n      if (!showSearch.value) {\n        searchQuery.value = '';\n      }\n    };\n    const handleSearch = () => {\n      // Additional search logic can be added here if needed\n      console.log('Searching for:', searchQuery.value);\n    };\n\n    // Filter functions\n    const applyFilters = async () => {\n      try {\n        console.log('Applying filters:', {\n          year: selectedYear.value,\n          section: selectedSection.value,\n          subject: selectedSubject.value\n        });\n\n        // Save the applied filters as preferences first\n        await saveUserPreferences();\n\n        // Save to recent filters\n        if (selectedYear.value && selectedSection.value && selectedSubject.value) {\n          saveToRecentFilters({\n            year: selectedYear.value,\n            section: selectedSection.value,\n            subject: selectedSubject.value,\n            timestamp: new Date().toISOString()\n          });\n        }\n\n        // Record the timestamp for this filter combination\n        try {\n          const token = store.state.auth.token;\n          const userId = store.state.auth.user?._id;\n          if (userId && selectedYear.value && selectedSection.value && selectedSubject.value) {\n            await api.post('/users/record-filter-usage', {\n              userId,\n              year: selectedYear.value,\n              section: selectedSection.value,\n              subject: selectedSubject.value,\n              timestamp: new Date().toISOString()\n            }, {\n              headers: {\n                'Authorization': `Bearer ${token}`\n              }\n            });\n            console.log('Filter usage recorded');\n          }\n        } catch (recordError) {\n          console.error('Error recording filter usage:', recordError);\n          // Non-critical error, continue with the rest of the function\n        }\n\n        // Always fetch data when filters are applied, regardless of whether all filters are selected\n        await fetchClassData();\n\n        // Only fetch assessments if we have all the necessary filters\n        if (selectedYear.value && selectedSection.value && selectedSubject.value) {\n          await fetchAssessments();\n        }\n      } catch (error) {\n        console.error('Error applying filters:', error);\n        console.error('Error details:', {\n          message: error.message,\n          response: error.response?.data,\n          status: error.response?.status\n        });\n\n        // Try to recover by using localStorage values\n        try {\n          const localPrefs = localStorage.getItem('classRecordPreferences');\n          if (localPrefs) {\n            const prefs = JSON.parse(localPrefs);\n            console.log('Recovering with localStorage preferences:', prefs);\n\n            // Only update if values are different to avoid infinite loops\n            let changed = false;\n            if (prefs.selectedYear && prefs.selectedYear !== selectedYear.value) {\n              selectedYear.value = prefs.selectedYear;\n              changed = true;\n            }\n            if (prefs.selectedSection && prefs.selectedSection !== selectedSection.value) {\n              selectedSection.value = prefs.selectedSection;\n              changed = true;\n            }\n            if (prefs.selectedSubject && prefs.selectedSubject !== selectedSubject.value) {\n              selectedSubject.value = prefs.selectedSubject;\n              changed = true;\n            }\n\n            // If we made changes, try to fetch data again\n            if (changed) {\n              console.log('Recovered with localStorage values, fetching data again');\n              await fetchClassData();\n              if (selectedYear.value && selectedSection.value && selectedSubject.value) {\n                await fetchAssessments();\n              }\n            }\n          }\n        } catch (recoveryError) {\n          console.error('Failed to recover with localStorage:', recoveryError);\n        }\n      }\n    };\n\n    // Computed property to check if record can be added\n    const canAddStudentRecord = computed(() => {\n      return newStudentRecord.value.year && newStudentRecord.value.section && newStudentRecord.value.subject;\n    });\n\n    // Fetch class data\n    const fetchClassData = async () => {\n      try {\n        if (!selectedYear.value || !selectedSection.value || !selectedSubject.value) {\n          console.log('Missing required filters for fetchClassData:', {\n            year: selectedYear.value || 'missing',\n            section: selectedSection.value || 'missing',\n            subject: selectedSubject.value || 'missing'\n          });\n          students.value = [];\n          return;\n        }\n\n        // Create a params object with the teacher ID\n        const teacherId = store.state.auth.user?._id;\n        if (!teacherId) {\n          console.error('Teacher ID not available');\n          return;\n        }\n        const params = {\n          teacherId,\n          year: selectedYear.value,\n          section: selectedSection.value,\n          subject: selectedSubject.value\n        };\n        console.log('Fetching class data with filters:', params);\n\n        // Make the API call with the available filters\n        const response = await api.get('/teacher-class-records/students', {\n          params,\n          headers: {\n            'Authorization': `Bearer ${store.state.auth.token}`\n          }\n        });\n        if (!response.data || !Array.isArray(response.data) || response.data.length === 0) {\n          console.log('No students found for the selected filters');\n          students.value = [];\n          return;\n        }\n\n        // Map the students and initialize scores\n        students.value = response.data.map(student => ({\n          ...student,\n          scores: {}\n        }));\n\n        // Fetch assessments after loading students\n        await fetchAssessments();\n        console.log('Fetched students:', students.value.length);\n      } catch (error) {\n        console.error('Failed to fetch class data:', error);\n        console.error('Error details:', {\n          message: error.message,\n          response: error.response?.data,\n          status: error.response?.status\n        });\n\n        // Don't show alert for every error to avoid overwhelming the user\n        if (error.response?.status !== 400) {\n          alert('Failed to load class data. Please try again.');\n        }\n        students.value = [];\n      }\n    };\n\n    // Handle adding new assessment\n    const handleAddAssessment = async () => {\n      try {\n        if (!selectedSection.value || !selectedSubject.value) {\n          alert('Please select a section and subject first');\n          return;\n        }\n        const teacherId = store.state.auth.user?._id;\n        if (!teacherId) {\n          console.error('Teacher ID not available');\n          return;\n        }\n\n        // Use the current table date for the assessment\n        const assessment = {\n          type: newAssessment.value.type,\n          number: parseInt(newAssessment.value.number),\n          maxScore: parseInt(newAssessment.value.maxScore),\n          teacherId,\n          section: selectedSection.value,\n          subject: selectedSubject.value,\n          date: currentDate.value.toISOString()\n        };\n        const response = await api.post('/assessments', assessment, {\n          headers: {\n            'Authorization': `Bearer ${store.state.auth.token}`,\n            'Content-Type': 'application/json'\n          }\n        });\n\n        // Add the new assessment to the list\n        assessments.value.push(response.data);\n\n        // Reset form and close modal\n        newAssessment.value = {\n          type: '',\n          number: '',\n          maxScore: ''\n        };\n        showAddAssessmentModal.value = false;\n      } catch (error) {\n        console.error('Failed to add assessment:', error);\n        alert('Failed to add assessment. ' + (error.response?.data?.message || 'Please try again.'));\n      }\n    };\n\n    // Update the fetchAssessments function\n    const fetchAssessments = async () => {\n      try {\n        if (!selectedSection.value || !selectedSubject.value) {\n          console.log('Missing required filters for fetching assessments');\n          return;\n        }\n        const teacherId = store.state.auth.user?._id || user.value?._id;\n        const date = moment(currentDate.value).format('YYYY-MM-DD');\n        console.log('Fetching assessments for:', {\n          teacherId,\n          section: selectedSection.value,\n          subject: selectedSubject.value,\n          date\n        });\n\n        // Show loading indicator\n        const loadingToast = showToast('Loading assessments...', 'info', 0);\n        const response = await api.get('/assessments', {\n          params: {\n            teacherId,\n            section: selectedSection.value,\n            subject: selectedSubject.value,\n            date\n          },\n          headers: {\n            'Authorization': `Bearer ${store.state.auth.token}`\n          }\n        });\n\n        // Hide loading indicator\n        hideToast(loadingToast);\n        if (!response.data || !Array.isArray(response.data)) {\n          console.error('Invalid response data:', response.data);\n          showToast('Failed to load assessments', 'error', 3000);\n          return;\n        }\n        console.log(`Loaded ${response.data.length} assessments`);\n\n        // Sort assessments by date and type\n        const sortedAssessments = response.data.sort((a, b) => {\n          // First sort by date\n          const dateA = new Date(a.date);\n          const dateB = new Date(b.date);\n          if (dateA.getTime() !== dateB.getTime()) {\n            return dateA - dateB;\n          }\n\n          // If dates are equal, sort by type\n          const typeOrder = {\n            'Quiz': 1,\n            'Activity': 2,\n            'Performance Task': 3\n          };\n          if (typeOrder[a.type] !== typeOrder[b.type]) {\n            return typeOrder[a.type] - typeOrder[b.type];\n          }\n\n          // If types are equal, sort by number\n          return a.number - b.number;\n        });\n\n        // Map the assessments and initialize scores\n        assessments.value = sortedAssessments.map(assessment => {\n          // Create a title if it doesn't exist\n          const title = assessment.title || `${assessment.type} ${assessment.number}`;\n          return {\n            ...assessment,\n            id: assessment._id,\n            title,\n            scores: assessment.scores || {},\n            date: assessment.date ? new Date(assessment.date) : new Date()\n          };\n        });\n        console.log('Processed assessments:', assessments.value);\n\n        // If a student is selected, update their assessment data\n        if (selectedStudent.value) {\n          await viewStudentDetails(selectedStudent.value);\n        }\n\n        // Show success message if assessments were loaded\n        if (assessments.value.length > 0) {\n          showToast(`Loaded ${assessments.value.length} assessments`, 'success', 2000);\n        } else {\n          showToast('No assessments found for the selected filters', 'info', 3000);\n        }\n      } catch (error) {\n        console.error('Error fetching assessments:', error);\n        showToast('Failed to load assessments: ' + (error.message || 'Unknown error'), 'error', 3000);\n      }\n    };\n\n    // Update the computed property for filtered assessments\n    const filteredAssessmentsByDate = computed(() => {\n      return assessments.value.filter(assessment => {\n        const assessmentDate = new Date(assessment.date);\n        const currentDateStart = new Date(currentDate.value);\n        currentDateStart.setUTCHours(0, 0, 0, 0);\n        currentDateStart.setHours(currentDateStart.getHours() + 8); // Adjust for Philippine timezone\n\n        const currentDateEnd = new Date(currentDate.value);\n        currentDateEnd.setUTCHours(23, 59, 59, 999);\n        currentDateEnd.setHours(currentDateEnd.getHours() + 8); // Adjust for Philippine timezone\n\n        return assessmentDate >= currentDateStart && assessmentDate <= currentDateEnd;\n      }).sort((a, b) => {\n        // Sort by type first\n        const typeOrder = {\n          'Quiz': 1,\n          'Activity': 2,\n          'Performance Task': 3\n        };\n        if (typeOrder[a.type] !== typeOrder[b.type]) {\n          return typeOrder[a.type] - typeOrder[b.type];\n        }\n\n        // Then by number\n        return a.number - b.number;\n      });\n    });\n\n    // Add watcher for currentDate to refresh assessments\n    watch(currentDate, async () => {\n      await fetchAssessments();\n    });\n\n    // Update student score\n    const updateScore = async (student, assessment, inputValue) => {\n      try {\n        const token = store.state.auth.token;\n        const teacherId = store.state.auth.user?._id;\n        if (!teacherId) {\n          console.error('Teacher ID not available');\n          showToast('Teacher ID not available. Please log in again.', 'error', 3000);\n          return;\n        }\n\n        // Get the assessment ID\n        const assessmentId = assessment._id || assessment.id;\n        if (!assessmentId) {\n          console.error('Assessment ID not available');\n          showToast('Assessment ID not available. Please try again.', 'error', 3000);\n          return;\n        }\n\n        // Get the score from the input field or parameter\n        let scoreValue = inputValue;\n        if (scoreValue === undefined) {\n          scoreValue = student.scores?.[assessmentId];\n        }\n\n        // Validate score\n        if (scoreValue === null || scoreValue === '') {\n          // Handle empty score\n          scoreValue = null;\n          console.log(`Removing score for student ${student.studentNumber}, assessment ${assessmentId}`);\n        } else {\n          const scoreNum = parseInt(scoreValue);\n          if (isNaN(scoreNum) || scoreNum < 0 || scoreNum > assessment.maxScore) {\n            showToast(`Please enter a valid score between 0 and ${assessment.maxScore}`, 'error', 3000);\n            return;\n          }\n          scoreValue = scoreNum; // Ensure it's a number\n        }\n        console.log(`Updating score for student ${student.studentNumber}, assessment ${assessmentId}: ${scoreValue}`);\n\n        // Create the request payload for the new endpoint\n        const payload = {\n          assessmentId,\n          teacherId,\n          studentNumber: student.studentNumber,\n          score: scoreValue\n        };\n        console.log('Sending score update request with payload:', payload);\n\n        // Show loading indicator\n        const loadingToast = showToast('Updating score...', 'info', 0);\n\n        // Use the new direct score update endpoint\n        const response = await api.post(`/assessments/update-score-direct`, payload, {\n          headers: {\n            'Authorization': `Bearer ${token}`,\n            'Content-Type': 'application/json'\n          }\n        });\n\n        // Hide loading indicator\n        hideToast(loadingToast);\n        console.log('Score update response:', response.data);\n        if (!response.data || !response.data.success) {\n          console.error('Error updating score:', response.data?.message || 'Unknown error');\n          showToast(response.data?.message || 'Failed to update score', 'error', 3000);\n          return;\n        }\n\n        // Show success message\n        showToast('Score updated successfully', 'success', 2000);\n\n        // Update the local assessment scores\n        const updatedAssessment = response.data.assessment;\n        if (!updatedAssessment) {\n          console.error('No assessment returned from server');\n          return;\n        }\n        console.log('Updated assessment:', updatedAssessment);\n        console.log('Updated scores:', updatedAssessment.scores);\n\n        // Find the assessment in the local array\n        const assessmentIndex = assessments.value.findIndex(a => a._id === assessmentId || a.id === assessmentId);\n        if (assessmentIndex !== -1) {\n          // Update the assessment in the array with the new scores\n          assessments.value[assessmentIndex] = {\n            ...assessments.value[assessmentIndex],\n            scores: updatedAssessment.scores || {}\n          };\n\n          // Force a UI update\n          assessments.value = [...assessments.value];\n\n          // Update the student's scores in the UI\n          if (students.value) {\n            const studentIndex = students.value.findIndex(s => s.studentNumber === student.studentNumber);\n            if (studentIndex !== -1) {\n              // Make sure the scores object exists\n              if (!students.value[studentIndex].scores) {\n                students.value[studentIndex].scores = {};\n              }\n\n              // Update the score\n              students.value[studentIndex].scores[assessmentId] = scoreValue;\n\n              // Force a UI update\n              students.value = [...students.value];\n            }\n          }\n\n          // If the student is currently selected in the details modal, update their chart\n          if (selectedStudent.value && selectedStudent.value.studentNumber === student.studentNumber) {\n            // Update the chart on the next tick to ensure the DOM is updated\n            nextTick(() => {\n              createPerformanceChart();\n              updateAssessmentHistoryTable();\n            });\n          }\n        }\n      } catch (error) {\n        console.error('Error updating score:', error);\n        showToast('Failed to update score. Please try again.', 'error', 3000);\n      }\n    };\n\n    // Helper function to show toast messages\n    const showToast = (message, type = 'info', duration = 3000) => {\n      const toast = document.createElement('div');\n      toast.className = `toast toast-${type}`;\n      toast.innerHTML = message;\n      document.body.appendChild(toast);\n\n      // Add styles if they don't exist\n      if (!document.getElementById('toast-styles')) {\n        const style = document.createElement('style');\n        style.id = 'toast-styles';\n        style.innerHTML = `\n          .toast {\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            padding: 12px 20px;\n            border-radius: 4px;\n            color: white;\n            font-weight: bold;\n            z-index: 9999;\n            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n            animation: toast-in 0.3s ease-out;\n          }\n          .toast-info {\n            background-color: #3498db;\n          }\n          .toast-success {\n            background-color: #2ecc71;\n          }\n          .toast-warning {\n            background-color: #f39c12;\n          }\n          .toast-error {\n            background-color: #e74c3c;\n          }\n          @keyframes toast-in {\n            from { transform: translateY(-20px); opacity: 0; }\n            to { transform: translateY(0); opacity: 1; }\n          }\n        `;\n        document.head.appendChild(style);\n      }\n\n      // Remove toast after duration (if not 0)\n      if (duration > 0) {\n        setTimeout(() => {\n          hideToast(toast);\n        }, duration);\n      }\n      return toast;\n    };\n\n    // Helper function to hide toast\n    const hideToast = toast => {\n      if (!toast || !document.body.contains(toast)) return;\n      toast.style.opacity = '0';\n      toast.style.transform = 'translateY(-20px)';\n      toast.style.transition = 'all 0.3s ease-out';\n      setTimeout(() => {\n        if (document.body.contains(toast)) {\n          document.body.removeChild(toast);\n        }\n      }, 300);\n    };\n\n    // View student details\n    const viewStudentDetails = async student => {\n      try {\n        if (!student) {\n          console.error('Invalid student data provided to viewStudentDetails');\n          return;\n        }\n\n        // Clean up existing charts if any\n        if (selectedStudent.value) {\n          const chartIdBase = `performanceChart-${selectedStudent.value.studentNumber}`;\n          const chartIds = [`all-${chartIdBase}`, `quiz-${chartIdBase}`, `activity-${chartIdBase}`, `performance-${chartIdBase}`];\n          chartIds.forEach(id => {\n            const chartElement = document.getElementById(id);\n            if (chartElement) {\n              const chart = Chart.getChart(chartElement);\n              if (chart) {\n                chart.destroy();\n              }\n            }\n          });\n        }\n\n        // Reset assessment type to 'All'\n        selectedAssessmentType.value = 'All';\n\n        // Get all assessments for this student\n        const response = await api.get('/assessments', {\n          params: {\n            teacherId: store.state.auth.user?._id,\n            section: selectedSection.value,\n            subject: selectedSubject.value\n          },\n          headers: {\n            'Authorization': `Bearer ${store.state.auth.token}`\n          }\n        });\n        if (!response.data) {\n          throw new Error('Failed to fetch assessment data');\n        }\n\n        // Map the assessments to include scores\n        const assessmentsData = response.data.map(assessment => ({\n          ...assessment,\n          id: assessment._id,\n          scores: assessment.scores || {}\n        }));\n\n        // Update the selected student with assessment data\n        selectedStudent.value = {\n          ...student,\n          assessments: assessmentsData\n        };\n\n        // Set default date ranges if not already set\n        const today = moment().format('YYYY-MM-DD');\n        const thirtyDaysAgo = moment().subtract(30, 'days').format('YYYY-MM-DD');\n        chartDateRange.value = {\n          start: thirtyDaysAgo,\n          end: today\n        };\n        historyDateRange.value = {\n          start: thirtyDaysAgo,\n          end: today\n        };\n\n        // Create charts on next tick to ensure DOM is ready\n        nextTick(() => {\n          createPerformanceChart();\n        });\n      } catch (error) {\n        console.error('Error fetching student details:', error);\n        alert('Failed to load student details. Please try again.');\n      }\n    };\n\n    // Add watch for currentDate to update student details when date changes\n    watch(currentDate, async () => {\n      if (selectedStudent.value) {\n        await viewStudentDetails(selectedStudent.value);\n      }\n    });\n\n    // Format date\n    const formatDate = date => {\n      if (!date) return '';\n      return moment(date).tz('Asia/Manila').format('MMMM D, YYYY');\n    };\n\n    // Function to update teacher subjects\n    const updateTeacherSubjects = async () => {\n      try {\n        if (!selectedYear.value || !selectedSection.value) {\n          console.log('Missing year or section for fetching subjects');\n          teacherSubjects.value = [];\n          return;\n        }\n        const teacherId = store.state.auth.user?._id;\n        const response = await api.get('/teacher-class-records/available-subjects', {\n          params: {\n            teacherId,\n            year: selectedYear.value,\n            section: selectedSection.value\n          },\n          headers: {\n            'Authorization': `Bearer ${store.state.auth.token}`\n          }\n        });\n        if (response.data && response.data.subjects) {\n          teacherSubjects.value = response.data.subjects.sort();\n          console.log('Fetched teacher subjects:', teacherSubjects.value);\n\n          // If no subject is selected but we have subjects available, select the first one\n          if (!selectedSubject.value && teacherSubjects.value.length > 0) {\n            selectedSubject.value = teacherSubjects.value[0];\n          }\n        } else {\n          teacherSubjects.value = [];\n        }\n      } catch (error) {\n        console.error('Failed to fetch teacher subjects:', error);\n        teacherSubjects.value = [];\n      }\n    };\n\n    // Handle adding new student record\n    const handleAddStudentRecord = async () => {\n      console.log('handleAddStudentRecord function called');\n      try {\n        const token = store.state.auth.token;\n        const teacherId = store.state.auth.user?._id || user.value?._id;\n        console.log('Adding student record with:', {\n          year: newStudentRecord.value.year,\n          section: newStudentRecord.value.section,\n          subject: newStudentRecord.value.subject\n        });\n        if (!teacherId) {\n          console.error('Teacher ID not available');\n          alert('Teacher information is not available. Please try logging in again.');\n          store.dispatch('logout');\n          router.push('/login');\n          return;\n        }\n\n        // First get students from the selected section\n        console.log('Fetching students for section:', newStudentRecord.value.year, newStudentRecord.value.section);\n        const studentsResponse = await api.get(`/students/by-section`, {\n          params: {\n            year: newStudentRecord.value.year,\n            section: newStudentRecord.value.section\n          },\n          headers: {\n            'Authorization': `Bearer ${token}`\n          }\n        });\n        console.log('Students response:', studentsResponse.data);\n        if (!studentsResponse.data || studentsResponse.data.length === 0) {\n          alert('No students found in the selected section.');\n          return;\n        }\n\n        // Map students to the required format\n        const mappedStudents = studentsResponse.data.map(student => ({\n          studentId: student._id,\n          studentNumber: student.studentId,\n          firstName: student.firstName,\n          lastName: student.lastName,\n          year: student.year,\n          section: student.section\n        }));\n        console.log('Mapped students:', mappedStudents);\n\n        // Create the class record\n        const classRecordData = {\n          teacherId,\n          year: newStudentRecord.value.year,\n          section: newStudentRecord.value.section,\n          subject: newStudentRecord.value.subject,\n          students: mappedStudents\n        };\n        console.log('Creating class record with data:', classRecordData);\n\n        // Save the class record\n        const createResponse = await api.post('/teacher-class-records/create', classRecordData, {\n          headers: {\n            'Authorization': `Bearer ${token}`,\n            'Content-Type': 'application/json'\n          }\n        });\n        console.log('Create response:', createResponse.data);\n        if (createResponse.data) {\n          try {\n            // Initialize attendance records for all students\n            // Get the current date in Philippine timezone\n            const today = moment().tz('Asia/Manila').startOf('day').format('YYYY-MM-DD');\n            console.log('Creating attendance records for date:', today);\n\n            // Create attendance records for each student\n            const attendancePromises = mappedStudents.map(student => {\n              console.log(`Creating attendance record for student ${student.firstName} ${student.lastName} (${student.studentNumber})`);\n              return api.post('/attendance', {\n                studentId: student.studentId,\n                teacherId,\n                date: today,\n                subject: newStudentRecord.value.subject,\n                section: newStudentRecord.value.section,\n                status: 'present' // Default status\n              }, {\n                headers: {\n                  'Authorization': `Bearer ${token}`,\n                  'Content-Type': 'application/json'\n                }\n              }).then(response => {\n                console.log(`Successfully created attendance record for student ${student.studentNumber}:`, response.data);\n                return response;\n              }).catch(error => {\n                console.warn(`Failed to create attendance record for student ${student.studentNumber}:`, error);\n\n                // If the endpoint doesn't exist, log a more specific message\n                if (error.response && error.response.status === 404) {\n                  console.warn('Attendance API endpoint not found. This is expected if the attendance service is not yet implemented.');\n                }\n\n                // Return a resolved promise to prevent Promise.all from failing\n                return Promise.resolve();\n              });\n            });\n\n            // Wait for all attendance records to be created\n            await Promise.all(attendancePromises);\n            console.log('Attendance records creation completed');\n          } catch (attendanceError) {\n            console.warn('Error creating attendance records:', attendanceError);\n            // Continue with the process even if attendance creation fails\n          }\n\n          // Close modal and reset form\n          showAddStudentRecordModal.value = false;\n          newStudentRecord.value = {\n            year: '',\n            section: '',\n            subject: ''\n          };\n\n          // Update the selected filters to show the new record\n          selectedYear.value = classRecordData.year;\n          selectedSection.value = classRecordData.section;\n          selectedSubject.value = classRecordData.subject;\n          console.log('Selected filters updated to:', {\n            year: selectedYear.value,\n            section: selectedSection.value,\n            subject: selectedSubject.value\n          });\n\n          // Refresh the data\n          console.log('Refreshing class data and attendance...');\n          await fetchClassData();\n\n          // Check if data was loaded correctly\n          if (students.value.length === 0) {\n            console.log('No students loaded after fetchClassData, trying again...');\n            // Try again with a slight delay\n            setTimeout(async () => {\n              await fetchClassData();\n              console.log('Second attempt to fetch class data complete, students:', students.value.length);\n            }, 500);\n          }\n          try {\n            await fetchAttendance();\n            console.log('Attendance data refreshed successfully');\n          } catch (attendanceError) {\n            console.warn('Error fetching attendance:', attendanceError);\n            // Continue with the process even if attendance fetching fails\n          }\n          console.log('Data refresh complete');\n          alert('Student records added successfully!');\n        }\n      } catch (error) {\n        console.error('Failed to add student record:', error);\n        if (error.response) {\n          console.error('Error response:', error.response.data);\n        }\n\n        // Check if the class record was created successfully\n        let classRecordCreated = false;\n        try {\n          // Try to fetch the class record to see if it was created\n          if (newStudentRecord.value.year && newStudentRecord.value.section && newStudentRecord.value.subject) {\n            const checkResponse = await api.get('/teacher-class-records', {\n              params: {\n                teacherId: store.state.auth.user?._id || user.value?._id,\n                year: newStudentRecord.value.year,\n                section: newStudentRecord.value.section,\n                subject: newStudentRecord.value.subject\n              },\n              headers: {\n                'Authorization': `Bearer ${store.state.auth.token}`\n              }\n            });\n            if (checkResponse.data && checkResponse.data.length > 0) {\n              classRecordCreated = true;\n              console.log('Class record was created successfully despite errors');\n            }\n          }\n        } catch (checkError) {\n          console.error('Error checking if class record was created:', checkError);\n        }\n        if (classRecordCreated) {\n          // If the class record was created, consider it a success\n          showAddStudentRecordModal.value = false;\n\n          // Store the values before resetting the form\n          const year = newStudentRecord.value.year;\n          const section = newStudentRecord.value.section;\n          const subject = newStudentRecord.value.subject;\n\n          // Reset the form\n          newStudentRecord.value = {\n            year: '',\n            section: '',\n            subject: ''\n          };\n\n          // Update the selected filters to show the new record\n          selectedYear.value = year;\n          selectedSection.value = section;\n          selectedSubject.value = subject;\n\n          // Refresh the data\n          await fetchClassData();\n          try {\n            await fetchAttendance();\n            console.log('Attendance data refreshed successfully after recovery');\n          } catch (attendanceError) {\n            console.warn('Error fetching attendance after recovery:', attendanceError);\n          }\n          alert('Student records added successfully, but there was an issue with attendance records. You may need to set attendance separately.');\n        } else if (error.response?.data?.message === 'A class record already exists for this combination') {\n          alert('A class record already exists for this combination of teacher, year, section, and subject.');\n        } else {\n          alert('Failed to add student record. Please try again.');\n        }\n      }\n    };\n\n    // Watch for changes in year selection\n    watch(selectedYear, async newYear => {\n      if (newYear) {\n        selectedSection.value = ''; // Reset section\n        selectedSubject.value = ''; // Reset subject\n        await fetchAvailableSections(); // Fetch sections based on selected year\n        await saveUserPreferences(); // Save the updated preference\n      } else {\n        availableSections.value = [];\n      }\n    });\n\n    // Watch for changes in section selection\n    watch(selectedSection, async newSection => {\n      if (newSection) {\n        selectedSubject.value = ''; // Reset subject\n        await updateTeacherSubjects(); // Fetch subjects based on selected year and section\n        await saveUserPreferences(); // Save the updated preference\n      } else {\n        teacherSubjects.value = [];\n      }\n    });\n\n    // Watch for changes in subject selection\n    watch(selectedSubject, async newSubject => {\n      if (newSubject) {\n        await fetchClassData(); // Fetch class data based on selected year, section, and subject\n        await saveUserPreferences(); // Save the updated preference\n      } else {\n        students.value = [];\n      }\n    });\n\n    // Add clearFilters function\n    const clearFilters = async () => {\n      // Reset all filter values\n      selectedYear.value = '';\n      selectedSection.value = '';\n      selectedSubject.value = '';\n      currentPage.value = 1;\n\n      // Clear students array to avoid showing stale data\n      students.value = [];\n      assessments.value = [];\n\n      // Remove preferences from localStorage\n      localStorage.removeItem('classRecordPreferences');\n      try {\n        // Then clear from backend\n        const token = store.state.auth.token;\n        const userId = store.state.auth.user?._id;\n        if (userId) {\n          const emptyPreferences = {\n            selectedYear: '',\n            selectedSection: '',\n            selectedSubject: '',\n            currentPage: 1\n          };\n          await api.post('/users/preferences', {\n            userId,\n            preferences: emptyPreferences\n          }, {\n            headers: {\n              'Authorization': `Bearer ${token}`\n            }\n          });\n          console.log('Preferences cleared successfully');\n        }\n      } catch (error) {\n        console.error('Error clearing preferences:', error);\n      }\n    };\n\n    // Add onMounted hook to fetch initial data\n    onMounted(async () => {\n      if (store.getters.isLoggedIn) {\n        try {\n          const token = store.state.auth.token;\n          if (!token) {\n            console.error('No auth token found');\n            router.push('/login');\n            return;\n          }\n          console.log('Fetching user profile...');\n          const response = await api.get('/users/profile', {\n            headers: {\n              'Authorization': `Bearer ${token}`\n            }\n          });\n          console.log('User profile response:', response.data);\n          if (response.data && response.data.role === 'teacher') {\n            user.value = response.data;\n            console.log('Teacher data loaded:', user.value);\n\n            // Fetch available years first\n            await fetchAvailableYears();\n\n            // If year is selected, fetch sections\n            if (selectedYear.value) {\n              await fetchAvailableSections();\n\n              // If section is selected, fetch subjects\n              if (selectedSection.value) {\n                await updateTeacherSubjects();\n\n                // If subject is selected, fetch class data and assessments\n                if (selectedSubject.value) {\n                  await Promise.all([fetchClassData(), fetchAssessments()]);\n                }\n              }\n            }\n          } else {\n            console.error('User is not a teacher:', response.data);\n            router.push('/login');\n          }\n        } catch (error) {\n          handleApiError(error, 'onMounted');\n        }\n      } else {\n        console.log('User not logged in, redirecting to login');\n        router.push('/login');\n      }\n    });\n\n    // Add these new methods in the setup function\n    const getAssessmentBadgeClass = type => {\n      switch (type) {\n        case 'Quiz':\n          return 'badge-quiz';\n        case 'Activity':\n          return 'badge-activity';\n        case 'Performance Task':\n          return 'badge-performance';\n        default:\n          return '';\n      }\n    };\n    const getScoreClass = percentage => {\n      if (percentage >= 90) return 'score-excellent';\n      if (percentage >= 80) return 'score-good';\n      if (percentage >= 75) return 'score-average';\n      return 'score-poor';\n    };\n\n    // Watch for changes in section or subject\n    watch([selectedSection, selectedSubject], async () => {\n      if (selectedSection.value && selectedSubject.value) {\n        await fetchClassData();\n        await fetchAssessments();\n      }\n    });\n    const createChart = (chartRef, data) => {\n      // Destroy existing chart if it exists\n      if (chartRef.value) {\n        const existingChart = Chart.getChart(chartRef.value);\n        if (existingChart) {\n          existingChart.destroy();\n        }\n      }\n      const chartColors = {\n        Quiz: '#4e73df',\n        Activity: '#1cc88a',\n        'Performance Task': '#f6c23e'\n      };\n      const chartConfig = {\n        type: 'bar',\n        data: {\n          labels: data.labels,\n          datasets: [{\n            data: data.scores,\n            backgroundColor: chartColors[data.type],\n            borderRadius: 6,\n            maxBarThickness: 40,\n            borderSkipped: false\n          }]\n        },\n        options: {\n          responsive: true,\n          maintainAspectRatio: false,\n          plugins: {\n            legend: {\n              display: false\n            },\n            tooltip: {\n              backgroundColor: '#fff',\n              titleColor: '#203464',\n              bodyColor: '#203464',\n              borderColor: '#e9ecef',\n              borderWidth: 1,\n              padding: 12,\n              displayColors: false,\n              callbacks: {\n                label: function (context) {\n                  return `Score: ${context.parsed.y}%`;\n                }\n              }\n            }\n          },\n          scales: {\n            x: {\n              grid: {\n                display: false\n              },\n              ticks: {\n                color: '#6c757d',\n                font: {\n                  size: 11\n                }\n              }\n            },\n            y: {\n              beginAtZero: true,\n              max: 100,\n              grid: {\n                color: '#f8f9fa',\n                drawBorder: false\n              },\n              ticks: {\n                color: '#6c757d',\n                font: {\n                  size: 11,\n                  callback: function (value) {\n                    return value + '%';\n                  }\n                }\n              }\n            }\n          }\n        }\n      };\n      return new Chart(chartRef.value, chartConfig);\n    };\n    const updateCharts = () => {\n      // Destroy existing charts\n      [quizChart, activityChart, performanceChart].forEach(chartRef => {\n        if (chartRef.value) {\n          const existingChart = Chart.getChart(chartRef.value);\n          if (existingChart) {\n            existingChart.destroy();\n          }\n        }\n      });\n      if (!selectedStudent.value) return;\n      const chartTypes = {\n        Quiz: quizChart,\n        Activity: activityChart,\n        'Performance Task': performanceChart\n      };\n\n      // Create new charts for each assessment type\n      Object.entries(chartTypes).forEach(([type, chartRef]) => {\n        const assessments = selectedStudent.value.assessments.filter(a => a.type === type).sort((a, b) => new Date(a.date) - new Date(b.date));\n        if (assessments.length > 0) {\n          const data = {\n            type,\n            labels: assessments.map(a => formatDate(a.date)),\n            scores: assessments.map(a => (a.score / a.maxScore * 100).toFixed(1))\n          };\n          createChart(chartRef, data);\n        }\n      });\n    };\n\n    // Add these to the setup function\n    const showEditAssessmentModal = ref(false);\n    const editingAssessment = ref({\n      type: '',\n      number: '',\n      maxScore: ''\n    });\n    const editAssessment = assessment => {\n      editingAssessment.value = {\n        ...assessment\n      };\n      showEditAssessmentModal.value = true;\n    };\n    const handleEditAssessment = async () => {\n      try {\n        const token = store.state.auth.token;\n        const response = await api.put(`/assessments/${editingAssessment.value._id}`, {\n          type: editingAssessment.value.type,\n          number: editingAssessment.value.number,\n          maxScore: editingAssessment.value.maxScore\n        }, {\n          headers: {\n            'Authorization': `Bearer ${token}`\n          }\n        });\n        if (response.data) {\n          // Update the assessment in the local state\n          const index = assessments.value.findIndex(a => a._id === editingAssessment.value._id);\n          if (index !== -1) {\n            assessments.value[index] = {\n              ...response.data,\n              id: response.data._id\n            };\n          }\n\n          // Close modal and show success message\n          showEditAssessmentModal.value = false;\n          alert('Assessment updated successfully!');\n        }\n      } catch (error) {\n        console.error('Failed to update assessment:', error);\n        alert('Failed to update assessment. Please try again.');\n      }\n    };\n    const handleDeleteAssessment = async () => {\n      if (!confirm('Are you sure you want to delete this assessment? This action cannot be undone.')) {\n        return;\n      }\n      try {\n        const token = store.state.auth.token;\n        await api.delete(`/assessments/${editingAssessment.value._id}`, {\n          headers: {\n            'Authorization': `Bearer ${token}`\n          }\n        });\n\n        // Remove the assessment from the local state\n        assessments.value = assessments.value.filter(a => a._id !== editingAssessment.value._id);\n\n        // Close modal and show success message\n        showEditAssessmentModal.value = false;\n        alert('Assessment deleted successfully!');\n      } catch (error) {\n        console.error('Failed to delete assessment:', error);\n        alert('Failed to delete assessment. Please try again.');\n      }\n    };\n\n    // Fetch available years for the teacher\n    const fetchAvailableYears = async () => {\n      try {\n        console.log('Starting fetchAvailableYears...');\n        const token = store.state.auth.token;\n        const teacherId = store.state.auth.user?._id;\n        if (!teacherId) {\n          console.error('No teacherId available');\n          return;\n        }\n        console.log('Making API request for available years...');\n        const response = await api.get('/teacher-class-records', {\n          params: {\n            teacherId\n          },\n          headers: {\n            'Authorization': `Bearer ${token}`\n          }\n        });\n        console.log('Available years response:', response.data);\n        // Extract unique years from teacher's records\n        const years = [...new Set(response.data.map(record => record.year))];\n        availableYears.value = years.sort();\n\n        // If no year is selected but we have years available, select the first one\n        if (!selectedYear.value && availableYears.value.length > 0) {\n          selectedYear.value = availableYears.value[0];\n        }\n      } catch (error) {\n        handleApiError(error, 'fetchAvailableYears');\n      }\n    };\n\n    // Fetch available sections for the selected year\n    const fetchAvailableSections = async () => {\n      try {\n        if (!selectedYear.value) {\n          console.log('No year selected for fetching sections');\n          availableSections.value = [];\n          return;\n        }\n        const teacherId = store.state.auth.user?._id;\n        const response = await api.get('/teacher-class-records/available-sections', {\n          params: {\n            teacherId,\n            year: selectedYear.value\n          },\n          headers: {\n            'Authorization': `Bearer ${store.state.auth.token}`\n          }\n        });\n\n        // Extract unique sections from teacher's records for the selected year\n        const sections = [...new Set(response.data.map(record => record.section))];\n        availableSections.value = sections.sort();\n        console.log('Fetched available sections:', availableSections.value);\n      } catch (error) {\n        console.error('Failed to fetch available sections:', error);\n        availableSections.value = [];\n      }\n    };\n\n    // Disable section and subject until year is selected\n    const canSelectSection = computed(() => !!selectedYear.value);\n    const canSelectSubject = computed(() => !!selectedSection.value);\n\n    // Add computed property for filtered assessments\n    const filteredAssessments = computed(() => {\n      if (!selectedStudent.value?.assessments) return [];\n      return selectedStudent.value.assessments.filter(assessment => {\n        // Apply type filter\n        if (selectedAssessmentType.value && assessment.type !== selectedAssessmentType.value) {\n          return false;\n        }\n\n        // Apply date filter\n        if (historyDateRange.value.start && historyDateRange.value.end) {\n          const assessmentDate = new Date(assessment.date);\n          const startDate = new Date(historyDateRange.value.start);\n          startDate.setUTCHours(0, 0, 0, 0);\n          startDate.setHours(startDate.getHours() + 8);\n          const endDate = new Date(historyDateRange.value.end);\n          endDate.setUTCHours(23, 59, 59, 999);\n          endDate.setHours(endDate.getHours() + 8); // Adjust for Philippine timezone\n\n          if (assessmentDate < startDate || assessmentDate > endDate) {\n            return false;\n          }\n        }\n        return true;\n      }).sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date, newest first\n    });\n\n    // Add filter handling functions\n    const applyChartDateFilter = () => {\n      if (chartDateRange.value.start && chartDateRange.value.end) {\n        // Create charts with the new date range\n        nextTick(() => {\n          createPerformanceChart();\n        });\n      }\n      showChartDateFilter = false;\n    };\n    const clearChartDateFilter = () => {\n      chartDateRange.value = {\n        start: moment().subtract(30, 'days').format('YYYY-MM-DD'),\n        end: moment().format('YYYY-MM-DD')\n      };\n\n      // Create charts with the reset date range\n      nextTick(() => {\n        createPerformanceChart();\n      });\n      showChartDateFilter = false;\n    };\n    const applyHistoryDateFilter = () => {\n      // The filteredAssessments computed property will automatically update\n      // based on the new date range\n      showHistoryDateFilter = false;\n    };\n    const clearHistoryDateFilter = () => {\n      historyDateRange.value = {\n        start: moment().subtract(30, 'days').format('YYYY-MM-DD'),\n        end: moment().format('YYYY-MM-DD')\n      };\n      showHistoryDateFilter = false;\n    };\n\n    // Watch for assessment type changes\n    watch(selectedAssessmentType, () => {\n      // The computed filteredAssessments will automatically update\n    });\n    const handleLogout = async () => {\n      try {\n        await store.dispatch('logout');\n        router.push('/login');\n      } catch (error) {\n        console.error('Logout failed:', error);\n      }\n    };\n\n    // Add date navigation function\n    const navigateDate = direction => {\n      const now = moment().tz('Asia/Manila').startOf('day');\n      const newDate = moment(currentDate.value).tz('Asia/Manila').startOf('day').add(direction, 'days');\n\n      // Only allow navigation to past dates or current date\n      if (direction < 0 || direction > 0 && !newDate.isAfter(now, 'day')) {\n        slideDirection.value = direction > 0 ? 'slide-left' : 'slide-right';\n        currentDate.value = newDate.toDate();\n\n        // Refresh data for the new date\n        fetchClassData();\n        fetchAttendance();\n        setTimeout(() => {\n          slideDirection.value = '';\n        }, 300);\n      }\n    };\n\n    // Format date for display\n    const formatDateForDisplay = dateString => {\n      if (!dateString) return '';\n      const date = new Date(dateString);\n      // Adjust for Philippine timezone\n      date.setHours(date.getHours() + 8);\n      return date.toLocaleDateString('en-US', {\n        year: 'numeric',\n        month: 'short',\n        day: 'numeric',\n        timeZone: 'Asia/Manila'\n      });\n    };\n    const openChartDateFilter = () => {\n      showChartDateFilter.value = true;\n      // Close other modals if open\n      showHistoryDateFilter.value = false;\n    };\n    const openHistoryDateFilter = () => {\n      showHistoryDateFilter.value = true;\n      // Close other modals if open\n      showChartDateFilter.value = false;\n    };\n    const slideDirection = ref('');\n\n    // Add computed property for next day button\n    const isNextDayDisabled = computed(() => {\n      const now = moment().tz('Asia/Manila').startOf('day');\n      const selected = moment(currentDate.value).tz('Asia/Manila').startOf('day');\n      return selected.isSameOrAfter(now, 'day');\n    });\n\n    // Add this near the top of the setup function\n    const handleApiError = (error, context) => {\n      console.error(`Error in ${context}:`, error);\n      console.error('Error details:', {\n        message: error.message,\n        response: error.response?.data,\n        status: error.response?.status\n      });\n      if (error.response?.status === 401) {\n        store.dispatch('logout');\n        router.push('/login');\n      }\n    };\n\n    // Add new method to fetch available years and sections\n    const fetchAvailableYearsAndSections = async () => {\n      try {\n        const token = store.state.auth.token;\n        console.log('Fetching available years and sections...');\n\n        // Use the available-years-sections endpoint\n        const response = await api.get('/students/available-years-sections', {\n          headers: {\n            'Authorization': `Bearer ${token}`\n          }\n        });\n        console.log('API Response:', response.data);\n        if (response.data) {\n          // Set available years and sections from the response\n          availableYears.value = response.data.years || [];\n          availableSections.value = response.data.sections || [];\n\n          // Use sectionsByYear from the API response\n          if (response.data.sectionsByYear) {\n            sectionsByYear.value = response.data.sectionsByYear;\n          } else {\n            sectionsByYear.value = {};\n          }\n\n          // If no years are available, add default values\n          if (availableYears.value.length === 0) {\n            availableYears.value = ['1st', '2nd', '3rd', '4th'];\n            console.log('No years found, using default values:', availableYears.value);\n          }\n\n          // If no sections are available, add default values\n          if (availableSections.value.length === 0) {\n            availableSections.value = ['South 1', 'South 2', 'South 3'];\n            console.log('No sections found, using default values:', availableSections.value);\n          }\n\n          // If sectionsByYear is empty, create a default mapping\n          if (Object.keys(sectionsByYear.value).length === 0) {\n            const defaultYears = ['1st', '2nd', '3rd', '4th'];\n            const defaultSections = ['South 1', 'South 2', 'South 3'];\n            defaultYears.forEach(year => {\n              sectionsByYear.value[year] = defaultSections;\n            });\n            console.log('No sections by year found, using default mapping:', sectionsByYear.value);\n          }\n          console.log('Available years:', availableYears.value);\n          console.log('Available sections:', availableSections.value);\n          console.log('Sections by year:', sectionsByYear.value);\n        }\n      } catch (error) {\n        console.error('Failed to fetch available years and sections:', error);\n\n        // Set default values in case of error\n        availableYears.value = ['1st', '2nd', '3rd', '4th'];\n        availableSections.value = ['South 1', 'South 2', 'South 3'];\n\n        // Create default sectionsByYear mapping\n        sectionsByYear.value = {\n          '1st': ['South 1', 'South 2', 'South 3'],\n          '2nd': ['South 1', 'South 2', 'South 3'],\n          '3rd': ['South 1', 'South 2', 'South 3'],\n          '4th': ['South 1', 'South 2', 'South 3']\n        };\n        console.log('Using default values due to error');\n      }\n    };\n\n    // Add method to fetch teacher subjects\n    const fetchTeacherSubjects = async () => {\n      try {\n        const token = store.state.auth.token;\n        const teacherId = store.state.auth.user?._id;\n        console.log('Fetching teacher subjects...');\n        if (!teacherId) {\n          console.error('Teacher ID not available');\n          teacherSubjects.value = [];\n          return;\n        }\n        const response = await api.get('/users/profile', {\n          headers: {\n            'Authorization': `Bearer ${token}`\n          }\n        });\n        console.log('Teacher profile response:', response.data);\n        if (response.data && response.data.subjects && response.data.subjects.length > 0) {\n          teacherSubjects.value = response.data.subjects.sort();\n          console.log('Fetched teacher subjects:', teacherSubjects.value);\n        } else {\n          console.log('No subjects found in teacher profile');\n          teacherSubjects.value = [];\n        }\n      } catch (error) {\n        console.error('Failed to fetch teacher subjects:', error);\n        teacherSubjects.value = [];\n      }\n    };\n\n    // Helper function to set default subjects based on teaching year\n    const setDefaultSubjects = () => {\n      const year = user.value?.teachingYear || '1st';\n      console.log('Setting default subjects for teaching year:', year);\n      switch (year) {\n        case '1st':\n          teacherSubjects.value = ['ITE 100', 'ITE 101', 'ITE 102', 'ITE 103'];\n          break;\n        case '2nd':\n          teacherSubjects.value = ['ITE 200', 'ITE 201', 'ITE 202', 'ITE 203'];\n          break;\n        case '3rd':\n          teacherSubjects.value = ['ITE 301', 'ITE 302', 'ITE 303', 'ITE 304'];\n          break;\n        case '4th':\n          teacherSubjects.value = ['ITE 400', 'ITE 401', 'ITE 402', 'ITE 403', 'ITE 404'];\n          break;\n        default:\n          teacherSubjects.value = ['ITE 100', 'ITE 101', 'ITE 102', 'ITE 103', 'ITE 200', 'ITE 201', 'ITE 202', 'ITE 203', 'ITE 301', 'ITE 302', 'ITE 303', 'ITE 304', 'ITE 400', 'ITE 401', 'ITE 402', 'ITE 403', 'ITE 404'];\n      }\n      console.log('Default subjects set:', teacherSubjects.value);\n    };\n\n    // Modify the existing showAddStudentRecordModal watcher or toggle function\n    const openAddStudentRecordModal = async () => {\n      // Reset form fields\n      newStudentRecord.value = {\n        year: '',\n        section: '',\n        subject: ''\n      };\n      console.log('Opening Add Student Record modal');\n      try {\n        // Fetch available options\n        await fetchAvailableYearsAndSections();\n        await fetchTeacherSubjects();\n        console.log('Form reset and data fetched, opening modal');\n\n        // Log available options for debugging\n        console.log('- Years:', availableYears.value);\n        console.log('- Sections by year:', sectionsByYear.value);\n        console.log('- Subjects:', teacherSubjects.value);\n\n        // Always open the modal, even if no options are available\n        showAddStudentRecordModal.value = true;\n      } catch (error) {\n        console.error('Error preparing Add Student Record modal:', error);\n        alert('Failed to prepare the Add Student Record form. Please try again.');\n      }\n    };\n\n    // Add computed property for filtered sections based on selected year\n    const filteredSections = computed(() => {\n      if (!newStudentRecord.value.year) return [];\n      console.log('Filtering sections for year:', newStudentRecord.value.year);\n      console.log('Available sections by year:', sectionsByYear.value);\n      const sections = sectionsByYear.value[newStudentRecord.value.year] || [];\n      console.log('Filtered sections:', sections);\n      return sections;\n    });\n\n    // Watch for year changes to reset section\n    watch(() => newStudentRecord.value.year, newYear => {\n      newStudentRecord.value.section = '';\n    });\n\n    // Add auto date update interval\n    let dateUpdateInterval = null;\n\n    // Add function to check and update date at midnight\n    const setupDateAutoUpdate = () => {\n      const checkAndUpdateDate = () => {\n        const now = moment().tz('Asia/Manila');\n        const current = moment(currentDate.value).tz('Asia/Manila');\n\n        // If it's past midnight and we're showing yesterday's date\n        if (now.isAfter(current, 'day')) {\n          currentDate.value = now.toDate();\n          fetchClassData();\n          fetchAttendance();\n        }\n      };\n\n      // Clear existing interval if any\n      if (dateUpdateInterval) {\n        clearInterval(dateUpdateInterval);\n      }\n\n      // Check every minute\n      dateUpdateInterval = setInterval(checkAndUpdateDate, 60000);\n    };\n\n    // Add attendance-related state and functions\n    const attendanceRecords = ref([]);\n    const attendanceStatistics = ref(null);\n    const fetchAttendance = async () => {\n      try {\n        if (!selectedSection.value || !selectedSubject.value) {\n          console.log('fetchAttendance: Missing required filters', {\n            section: selectedSection.value,\n            subject: selectedSubject.value\n          });\n          return;\n        }\n        console.log('fetchAttendance: Fetching attendance data with filters', {\n          section: selectedSection.value,\n          subject: selectedSubject.value,\n          date: moment(currentDate.value).tz('Asia/Manila').format('YYYY-MM-DD')\n        });\n        const date = moment(currentDate.value).tz('Asia/Manila').format('YYYY-MM-DD');\n        const response = await api.get(`/attendance/date/${date}`, {\n          params: {\n            subject: selectedSubject.value,\n            section: selectedSection.value\n          },\n          headers: {\n            'Authorization': `Bearer ${store.state.auth.token}`\n          }\n        });\n        attendanceRecords.value = response.data;\n      } catch (error) {\n        console.error('Error fetching attendance:', error);\n      }\n    };\n\n    // Add attendance chart creation\n    const createAttendanceChart = () => {\n      // This function is no longer needed as attendance is handled in the Attendance.vue page\n      console.log('Attendance functionality moved to Attendance.vue page');\n    };\n\n    // Add cleanup on component unmount\n    onUnmounted(() => {\n      if (dateUpdateInterval) {\n        clearInterval(dateUpdateInterval);\n      }\n    });\n\n    // Update onMounted to include new initialization\n    onMounted(async () => {\n      if (store.getters.isLoggedIn) {\n        try {\n          await fetchUserProfile();\n          await fetchTeacherSubjects();\n          setupDateAutoUpdate();\n        } catch (error) {\n          handleApiError(error, 'component mount');\n        }\n      } else {\n        router.push('/login');\n      }\n    });\n    const syncStudentRecords = async () => {\n      try {\n        if (!selectedYear.value || !selectedSection.value) {\n          alert('Please select a year and section first');\n          return;\n        }\n        const response = await api.post('/teacher-class-records/sync-records', {\n          year: selectedYear.value,\n          section: selectedSection.value\n        }, {\n          headers: {\n            'Authorization': `Bearer ${store.state.auth.token}`,\n            'Content-Type': 'application/json'\n          }\n        });\n        if (response.data.success) {\n          // Refresh the data after sync\n          await fetchClassData();\n          await fetchAttendance();\n          alert('Student records synchronized successfully!');\n        }\n      } catch (error) {\n        console.error('Failed to sync student records:', error);\n        alert('Failed to sync student records. Please try again.');\n      }\n    };\n\n    // Add redirection method\n    const redirectToAttendance = () => {\n      if (!selectedYear.value || !selectedSection.value || !selectedSubject.value) {\n        alert('Please select a year, section, and subject first');\n        return;\n      }\n      router.push({\n        name: 'Attendance',\n        query: {\n          year: selectedYear.value,\n          section: selectedSection.value,\n          subject: selectedSubject.value\n        }\n      });\n    };\n\n    // Add pagination state\n    const currentPage = ref(1);\n    const itemsPerPage = 25;\n\n    // Compute total pages\n    const totalPages = computed(() => Math.ceil(sortedStudents.value.length / itemsPerPage));\n\n    // Get paginated students\n    const paginatedStudents = computed(() => {\n      const start = (currentPage.value - 1) * itemsPerPage;\n      const end = start + itemsPerPage;\n      return sortedStudents.value.slice(start, end);\n    });\n\n    // Compute pagination info\n    const paginationInfo = computed(() => {\n      const start = sortedStudents.value.length === 0 ? 0 : (currentPage.value - 1) * itemsPerPage + 1;\n      const end = Math.min(start + itemsPerPage - 1, sortedStudents.value.length);\n      return {\n        start,\n        end\n      };\n    });\n\n    // Pagination methods\n    const nextPage = () => {\n      if (currentPage.value < totalPages.value) {\n        currentPage.value++;\n        saveUserPreferences(); // Save the updated page\n      }\n    };\n    const previousPage = () => {\n      if (currentPage.value > 1) {\n        currentPage.value--;\n        saveUserPreferences(); // Save the updated page\n      }\n    };\n\n    // Reset pagination when filters change\n    watch([searchQuery, selectedYear, selectedSection, selectedSubject], () => {\n      currentPage.value = 1;\n      // No need to save here as the filter change will trigger the filter watcher\n    });\n\n    // Add chart instances\n    let quizChartInstance = null;\n    let activityChartInstance = null;\n    let performanceChartInstance = null;\n\n    // Helper function to destroy chart\n    const destroyChart = (chartInstance, canvasRef) => {\n      try {\n        // Destroy the chart instance if it exists\n        if (chartInstance) {\n          chartInstance.destroy();\n        }\n\n        // Clear any existing chart from the canvas\n        if (canvasRef && canvasRef.value) {\n          const existingChart = Chart.getChart(canvasRef.value);\n          if (existingChart) {\n            existingChart.destroy();\n          }\n\n          // Clear any \"no data\" messages\n          const container = canvasRef.value.parentElement;\n          if (container) {\n            // Preserve the canvas but remove other elements\n            const canvas = canvasRef.value;\n            container.innerHTML = '';\n            if (canvas) {\n              container.appendChild(canvas);\n            }\n          }\n        }\n      } catch (error) {\n        console.error('Error destroying chart:', error);\n      }\n    };\n\n    // Handle date filter change from the modal\n    const handleDateFilterChange = dateFilter => {\n      console.log('Date filter changed:', dateFilter);\n\n      // Update chart date range\n      if (dateFilter.start) {\n        chartDateRange.value.start = dateFilter.start;\n        historyDateRange.value.start = dateFilter.start;\n      }\n      if (dateFilter.end) {\n        chartDateRange.value.end = dateFilter.end;\n        historyDateRange.value.end = dateFilter.end;\n      }\n\n      // Recreate charts with the new date range\n      nextTick(() => {\n        createPerformanceChart();\n        // The assessment history table will be updated by createPerformanceChart\n      });\n    };\n\n    // Handle assessment type change from the modal\n    const handleAssessmentTypeChange = type => {\n      console.log('Assessment type changed:', type);\n\n      // Update the selected assessment type\n      selectedAssessmentType.value = type;\n\n      // Recreate charts with the new assessment type\n      nextTick(() => {\n        createPerformanceChart();\n      });\n    };\n\n    // Create performance chart function\n    const createPerformanceChart = () => {\n      if (!selectedStudent.value) {\n        console.error('No student selected, cannot create performance chart');\n        return;\n      }\n      console.log('Creating performance charts for student:', selectedStudent.value.studentNumber);\n      console.log('Selected assessment type:', selectedAssessmentType.value);\n      console.log('Date range:', chartDateRange.value);\n\n      // Group assessments by type\n      const assessmentsByType = {\n        'Quiz': [],\n        'Activity': [],\n        'Performance Task': []\n      };\n\n      // Process assessments if they exist\n      if (selectedStudent.value.assessments && selectedStudent.value.assessments.length > 0) {\n        console.log(`Processing ${selectedStudent.value.assessments.length} assessments for charts`);\n        selectedStudent.value.assessments.forEach(assessment => {\n          if (assessment && assessment.type in assessmentsByType) {\n            // Get the score for this student\n            const studentNumber = selectedStudent.value.studentNumber;\n            let scoreValue = null;\n\n            // Check if scores is a Map or an object\n            if (assessment.scores) {\n              if (assessment.scores instanceof Map) {\n                scoreValue = assessment.scores.get(studentNumber);\n              } else if (typeof assessment.scores === 'object') {\n                scoreValue = assessment.scores[studentNumber];\n              }\n            }\n\n            // If score is not found in assessment.scores, check student.scores\n            if ((scoreValue === null || scoreValue === undefined) && selectedStudent.value.scores && (assessment._id in selectedStudent.value.scores || assessment.id in selectedStudent.value.scores)) {\n              scoreValue = selectedStudent.value.scores[assessment._id] || selectedStudent.value.scores[assessment.id];\n            }\n\n            // Only include assessments with scores\n            if (scoreValue !== null && scoreValue !== undefined) {\n              const maxScore = assessment.maxScore || 100;\n              const scorePercentage = scoreValue / maxScore * 100;\n\n              // Apply date filter if set\n              const assessmentDate = new Date(assessment.date);\n              const startDate = chartDateRange.value.start ? new Date(chartDateRange.value.start) : null;\n              const endDate = chartDateRange.value.end ? new Date(chartDateRange.value.end) : null;\n\n              // Skip if outside date range\n              if (startDate && assessmentDate < startDate || endDate && assessmentDate > endDate) {\n                console.log(`Skipping assessment ${assessment.type} #${assessment.number} due to date filter`);\n                return;\n              }\n              console.log(`Including assessment ${assessment.type} #${assessment.number}: Score=${scoreValue}/${maxScore} (${scorePercentage.toFixed(1)}%)`);\n              assessmentsByType[assessment.type].push({\n                date: assessment.date,\n                score: scorePercentage,\n                rawScore: scoreValue,\n                maxScore: maxScore,\n                number: assessment.number,\n                title: `${assessment.type} #${assessment.number}`\n              });\n            }\n          }\n        });\n      }\n\n      // Log the grouped assessments for debugging\n      Object.keys(assessmentsByType).forEach(type => {\n        console.log(`${type} assessments: ${assessmentsByType[type].length}`);\n      });\n\n      // Create charts for each type using the new chart IDs\n      const chartIdBase = `performanceChart-${selectedStudent.value.studentNumber}`;\n\n      // First, clean up any existing charts\n      const chartIds = [`all-${chartIdBase}`, `quiz-${chartIdBase}`, `activity-${chartIdBase}`, `performance-${chartIdBase}`];\n      chartIds.forEach(id => {\n        const chartElement = document.getElementById(id);\n        if (chartElement) {\n          const existingChart = Chart.getChart(chartElement);\n          if (existingChart) {\n            console.log(`Destroying existing chart: ${id}`);\n            existingChart.destroy();\n          }\n        }\n      });\n\n      // Update the assessment history table with the filtered data\n      updateAssessmentHistoryTable(assessmentsByType);\n\n      // Create \"All\" chart that combines all assessment types\n      if (selectedAssessmentType.value === 'All') {\n        const allChartElement = document.getElementById(`all-${chartIdBase}`);\n        if (allChartElement) {\n          const ctx = allChartElement.getContext('2d');\n          if (ctx) {\n            // Combine all assessment types into one dataset\n            const allAssessments = [...assessmentsByType['Quiz'].map(item => ({\n              ...item,\n              type: 'Quiz'\n            })), ...assessmentsByType['Activity'].map(item => ({\n              ...item,\n              type: 'Activity'\n            })), ...assessmentsByType['Performance Task'].map(item => ({\n              ...item,\n              type: 'Performance Task'\n            }))].sort((a, b) => new Date(a.date) - new Date(b.date));\n            if (allAssessments.length === 0) {\n              // Display no data message\n              const container = allChartElement.parentElement;\n              if (container) {\n                container.innerHTML = '';\n                const noDataMessage = document.createElement('div');\n                noDataMessage.className = 'text-center py-5 text-muted';\n                noDataMessage.innerHTML = '<i class=\"fas fa-info-circle me-2\"></i>No assessment data available for this student in the selected date range.';\n                container.appendChild(noDataMessage);\n              }\n            } else {\n              // Create datasets for each type\n              const datasets = [{\n                label: 'Quiz',\n                data: allAssessments.filter(item => item.type === 'Quiz').map(item => ({\n                  x: new Date(item.date),\n                  y: item.score\n                })),\n                borderColor: '#4285F4',\n                backgroundColor: 'rgba(66, 133, 244, 0.1)',\n                borderWidth: 2,\n                tension: 0.4,\n                pointBackgroundColor: '#4285F4',\n                pointBorderColor: '#fff',\n                pointRadius: 5\n              }, {\n                label: 'Activity',\n                data: allAssessments.filter(item => item.type === 'Activity').map(item => ({\n                  x: new Date(item.date),\n                  y: item.score\n                })),\n                borderColor: '#34A853',\n                backgroundColor: 'rgba(52, 168, 83, 0.1)',\n                borderWidth: 2,\n                tension: 0.4,\n                pointBackgroundColor: '#34A853',\n                pointBorderColor: '#fff',\n                pointRadius: 5\n              }, {\n                label: 'Performance Task',\n                data: allAssessments.filter(item => item.type === 'Performance Task').map(item => ({\n                  x: new Date(item.date),\n                  y: item.score\n                })),\n                borderColor: '#FBBC05',\n                backgroundColor: 'rgba(251, 188, 5, 0.1)',\n                borderWidth: 2,\n                tension: 0.4,\n                pointBackgroundColor: '#FBBC05',\n                pointBorderColor: '#fff',\n                pointRadius: 5\n              }].filter(dataset => dataset.data.length > 0); // Only include datasets with data\n\n              // Create the combined chart\n              new Chart(ctx, {\n                type: 'line',\n                data: {\n                  datasets\n                },\n                options: {\n                  responsive: true,\n                  maintainAspectRatio: false,\n                  scales: {\n                    x: {\n                      type: 'time',\n                      time: {\n                        unit: 'day',\n                        displayFormats: {\n                          day: 'MMM D, YYYY'\n                        },\n                        tooltipFormat: 'MMM D, YYYY'\n                      },\n                      adapters: {\n                        date: {\n                          locale: 'en'\n                        }\n                      },\n                      title: {\n                        display: true,\n                        text: 'Date'\n                      },\n                      grid: {\n                        display: false\n                      },\n                      ticks: {\n                        font: {\n                          size: 12,\n                          weight: 'bold'\n                        },\n                        padding: 10\n                      }\n                    },\n                    y: {\n                      beginAtZero: true,\n                      max: 100,\n                      title: {\n                        display: true,\n                        text: 'Score (%)'\n                      },\n                      ticks: {\n                        callback: value => value + '%'\n                      }\n                    }\n                  },\n                  plugins: {\n                    tooltip: {\n                      callbacks: {\n                        title: context => {\n                          return moment(context[0].parsed.x).format('MMMM D, YYYY');\n                        },\n                        label: context => {\n                          const datasetLabel = context.dataset.label;\n                          const value = context.parsed.y;\n                          return `${datasetLabel}: ${value.toFixed(1)}%`;\n                        }\n                      }\n                    },\n                    legend: {\n                      position: 'top'\n                    }\n                  }\n                }\n              });\n            }\n          }\n        }\n      }\n\n      // Create Quiz chart\n      if (selectedAssessmentType.value === 'Quiz') {\n        const quizChartElement = document.getElementById(`quiz-${chartIdBase}`);\n        if (quizChartElement) {\n          const ctx = quizChartElement.getContext('2d');\n          if (ctx) {\n            const data = assessmentsByType['Quiz'].sort((a, b) => new Date(a.date) - new Date(b.date));\n            if (data.length === 0) {\n              // Display no data message\n              const container = quizChartElement.parentElement;\n              if (container) {\n                container.innerHTML = '';\n                const noDataMessage = document.createElement('div');\n                noDataMessage.className = 'text-center py-5 text-muted';\n                noDataMessage.innerHTML = '<i class=\"fas fa-info-circle me-2\"></i>No quiz data available for this student in the selected date range.';\n                container.appendChild(noDataMessage);\n              }\n            } else {\n              // Create time series data\n              const timeSeriesData = data.map(item => ({\n                x: new Date(item.date),\n                y: item.score,\n                rawScore: item.rawScore,\n                maxScore: item.maxScore,\n                number: item.number\n              }));\n\n              // Create chart\n              new Chart(ctx, {\n                type: 'line',\n                data: {\n                  datasets: [{\n                    label: 'Quiz Scores',\n                    data: timeSeriesData,\n                    borderColor: '#4285F4',\n                    backgroundColor: 'rgba(66, 133, 244, 0.1)',\n                    borderWidth: 2,\n                    tension: 0.4,\n                    fill: true,\n                    pointBackgroundColor: '#4285F4',\n                    pointBorderColor: '#fff',\n                    pointRadius: 5\n                  }]\n                },\n                options: {\n                  responsive: true,\n                  maintainAspectRatio: false,\n                  scales: {\n                    x: {\n                      type: 'time',\n                      time: {\n                        unit: 'day',\n                        displayFormats: {\n                          day: 'MMM D, YYYY'\n                        },\n                        tooltipFormat: 'MMM D, YYYY'\n                      },\n                      adapters: {\n                        date: {\n                          locale: 'en'\n                        }\n                      },\n                      title: {\n                        display: true,\n                        text: 'Date'\n                      },\n                      grid: {\n                        display: false\n                      }\n                    },\n                    y: {\n                      beginAtZero: true,\n                      max: 100,\n                      title: {\n                        display: true,\n                        text: 'Score (%)'\n                      },\n                      ticks: {\n                        callback: value => value + '%'\n                      }\n                    }\n                  },\n                  plugins: {\n                    tooltip: {\n                      callbacks: {\n                        title: context => {\n                          return moment(context[0].parsed.x).format('MMMM D, YYYY');\n                        },\n                        label: context => {\n                          const item = context.raw;\n                          return [`Quiz #${item.number}`, `Score: ${item.rawScore}/${item.maxScore} (${item.y.toFixed(1)}%)`];\n                        }\n                      }\n                    }\n                  }\n                }\n              });\n            }\n          }\n        }\n      }\n\n      // Create Activity chart\n      if (selectedAssessmentType.value === 'Activity') {\n        const activityChartElement = document.getElementById(`activity-${chartIdBase}`);\n        if (activityChartElement) {\n          const ctx = activityChartElement.getContext('2d');\n          if (ctx) {\n            const data = assessmentsByType['Activity'].sort((a, b) => new Date(a.date) - new Date(b.date));\n            if (data.length === 0) {\n              // Display no data message\n              const container = activityChartElement.parentElement;\n              if (container) {\n                container.innerHTML = '';\n                const noDataMessage = document.createElement('div');\n                noDataMessage.className = 'text-center py-5 text-muted';\n                noDataMessage.innerHTML = '<i class=\"fas fa-info-circle me-2\"></i>No activity data available for this student in the selected date range.';\n                container.appendChild(noDataMessage);\n              }\n            } else {\n              // Create time series data\n              const timeSeriesData = data.map(item => ({\n                x: new Date(item.date),\n                y: item.score,\n                rawScore: item.rawScore,\n                maxScore: item.maxScore,\n                number: item.number\n              }));\n\n              // Create chart\n              new Chart(ctx, {\n                type: 'line',\n                data: {\n                  datasets: [{\n                    label: 'Activity Scores',\n                    data: timeSeriesData,\n                    borderColor: '#34A853',\n                    backgroundColor: 'rgba(52, 168, 83, 0.1)',\n                    borderWidth: 2,\n                    tension: 0.4,\n                    fill: true,\n                    pointBackgroundColor: '#34A853',\n                    pointBorderColor: '#fff',\n                    pointRadius: 5\n                  }]\n                },\n                options: {\n                  responsive: true,\n                  maintainAspectRatio: false,\n                  scales: {\n                    x: {\n                      type: 'time',\n                      time: {\n                        unit: 'day',\n                        displayFormats: {\n                          day: 'MMM D, YYYY'\n                        },\n                        tooltipFormat: 'MMM D, YYYY'\n                      },\n                      adapters: {\n                        date: {\n                          locale: 'en'\n                        }\n                      },\n                      title: {\n                        display: true,\n                        text: 'Date'\n                      },\n                      grid: {\n                        display: false\n                      }\n                    },\n                    y: {\n                      beginAtZero: true,\n                      max: 100,\n                      title: {\n                        display: true,\n                        text: 'Score (%)'\n                      },\n                      ticks: {\n                        callback: value => value + '%'\n                      }\n                    }\n                  },\n                  plugins: {\n                    tooltip: {\n                      callbacks: {\n                        title: context => {\n                          return moment(context[0].parsed.x).format('MMMM D, YYYY');\n                        },\n                        label: context => {\n                          const item = context.raw;\n                          return [`Activity #${item.number}`, `Score: ${item.rawScore}/${item.maxScore} (${item.y.toFixed(1)}%)`];\n                        }\n                      }\n                    }\n                  }\n                }\n              });\n            }\n          }\n        }\n      }\n\n      // Create Performance Task chart\n      if (selectedAssessmentType.value === 'Performance Task') {\n        const performanceChartElement = document.getElementById(`performance-${chartIdBase}`);\n        if (performanceChartElement) {\n          const ctx = performanceChartElement.getContext('2d');\n          if (ctx) {\n            const data = assessmentsByType['Performance Task'].sort((a, b) => new Date(a.date) - new Date(b.date));\n            if (data.length === 0) {\n              // Display no data message\n              const container = performanceChartElement.parentElement;\n              if (container) {\n                container.innerHTML = '';\n                const noDataMessage = document.createElement('div');\n                noDataMessage.className = 'text-center py-5 text-muted';\n                noDataMessage.innerHTML = '<i class=\"fas fa-info-circle me-2\"></i>No performance task data available for this student in the selected date range.';\n                container.appendChild(noDataMessage);\n              }\n            } else {\n              // Create time series data\n              const timeSeriesData = data.map(item => ({\n                x: new Date(item.date),\n                y: item.score,\n                rawScore: item.rawScore,\n                maxScore: item.maxScore,\n                number: item.number\n              }));\n\n              // Create chart\n              new Chart(ctx, {\n                type: 'line',\n                data: {\n                  datasets: [{\n                    label: 'Performance Task Scores',\n                    data: timeSeriesData,\n                    borderColor: '#FBBC05',\n                    backgroundColor: 'rgba(251, 188, 5, 0.1)',\n                    borderWidth: 2,\n                    tension: 0.4,\n                    fill: true,\n                    pointBackgroundColor: '#FBBC05',\n                    pointBorderColor: '#fff',\n                    pointRadius: 5\n                  }]\n                },\n                options: {\n                  responsive: true,\n                  maintainAspectRatio: false,\n                  scales: {\n                    x: {\n                      type: 'time',\n                      time: {\n                        unit: 'day',\n                        displayFormats: {\n                          day: 'MMM D, YYYY'\n                        },\n                        tooltipFormat: 'MMM D, YYYY'\n                      },\n                      adapters: {\n                        date: {\n                          locale: 'en'\n                        }\n                      },\n                      title: {\n                        display: true,\n                        text: 'Date'\n                      },\n                      grid: {\n                        display: false\n                      }\n                    },\n                    y: {\n                      beginAtZero: true,\n                      max: 100,\n                      title: {\n                        display: true,\n                        text: 'Score (%)'\n                      },\n                      ticks: {\n                        callback: value => value + '%'\n                      }\n                    }\n                  },\n                  plugins: {\n                    tooltip: {\n                      callbacks: {\n                        title: context => {\n                          return moment(context[0].parsed.x).format('MMMM D, YYYY');\n                        },\n                        label: context => {\n                          const item = context.raw;\n                          return [`Performance Task #${item.number}`, `Score: ${item.rawScore}/${item.maxScore} (${item.y.toFixed(1)}%)`];\n                        }\n                      }\n                    }\n                  }\n                }\n              });\n            }\n          }\n        }\n      }\n    };\n\n    // Helper function to create individual charts\n    const createChartInstance = (ctx, type, data) => {\n      if (!ctx) return null;\n\n      // Generate a unique ID for the chart\n      const chartId = `${type.toLowerCase()}-${Date.now()}`;\n      ctx.canvas.id = chartId;\n      if (data.length === 0) {\n        try {\n          // Find the parent container safely\n          const canvas = ctx.canvas;\n          if (!canvas) return null;\n          const container = canvas.parentElement;\n          if (!container) return null;\n\n          // Create a wrapper div for the message\n          const messageWrapper = document.createElement('div');\n          messageWrapper.className = 'text-center py-4 text-muted';\n          messageWrapper.innerHTML = `<i class=\"fas fa-info-circle me-2\"></i>No ${type.toLowerCase()} data available`;\n\n          // Clear the container and append the message\n          container.innerHTML = '';\n          container.appendChild(messageWrapper);\n          return null;\n        } catch (error) {\n          console.error('Error displaying no data message:', error);\n          return null;\n        }\n      }\n\n      // Define chart colors based on type\n      const getChartColors = type => {\n        switch (type) {\n          case 'Quiz':\n            return {\n              gradient: ['rgba(66, 133, 244, 0.8)', 'rgba(66, 133, 244, 0.1)'],\n              border: '#4285F4',\n              point: '#4285F4',\n              pointHover: '#3367D6'\n            };\n          case 'Activity':\n            return {\n              gradient: ['rgba(52, 168, 83, 0.8)', 'rgba(52, 168, 83, 0.1)'],\n              border: '#34A853',\n              point: '#34A853',\n              pointHover: '#2E7D32'\n            };\n          case 'Performance Task':\n            return {\n              gradient: ['rgba(251, 188, 5, 0.8)', 'rgba(251, 188, 5, 0.1)'],\n              border: '#FBBC05',\n              point: '#FBBC05',\n              pointHover: '#F57F17'\n            };\n          default:\n            return {\n              gradient: ['rgba(66, 133, 244, 0.8)', 'rgba(66, 133, 244, 0.1)'],\n              border: '#4285F4',\n              point: '#4285F4',\n              pointHover: '#3367D6'\n            };\n        }\n      };\n      const colors = getChartColors(type);\n\n      // Create gradient for background\n      const gradient = ctx.createLinearGradient(0, 0, 0, 400);\n      gradient.addColorStop(0, colors.gradient[0]);\n      gradient.addColorStop(1, colors.gradient[1]);\n\n      // Convert data to time series format\n      const timeSeriesData = data.map(item => ({\n        x: new Date(item.date),\n        y: item.score\n      }));\n      return new Chart(ctx, {\n        type: 'line',\n        data: {\n          datasets: [{\n            label: `${type} Scores`,\n            data: timeSeriesData,\n            borderColor: colors.border,\n            backgroundColor: gradient,\n            borderWidth: 3,\n            tension: 0.4,\n            fill: true,\n            pointBackgroundColor: colors.point,\n            pointBorderColor: '#fff',\n            pointBorderWidth: 2,\n            pointRadius: 5,\n            pointHoverRadius: 7,\n            pointHoverBackgroundColor: colors.pointHover,\n            pointHoverBorderColor: '#fff',\n            pointHoverBorderWidth: 2\n          }]\n        },\n        options: {\n          responsive: true,\n          maintainAspectRatio: false,\n          animations: {\n            tension: {\n              duration: 1000,\n              easing: 'linear',\n              from: 0.4,\n              to: 0.4,\n              loop: false\n            }\n          },\n          scales: {\n            x: {\n              type: 'time',\n              time: {\n                unit: 'day',\n                displayFormats: {\n                  day: 'MMM D, YYYY'\n                },\n                tooltipFormat: 'MMM D, YYYY'\n              },\n              adapters: {\n                date: {\n                  locale: 'en'\n                }\n              },\n              title: {\n                display: true,\n                text: 'Date'\n              },\n              grid: {\n                display: false\n              },\n              ticks: {\n                font: {\n                  size: 12,\n                  weight: 'bold'\n                },\n                padding: 10\n              }\n            },\n            y: {\n              beginAtZero: true,\n              max: 100,\n              grid: {\n                color: 'rgba(0, 0, 0, 0.05)',\n                borderDash: [5, 5]\n              },\n              ticks: {\n                font: {\n                  size: 12,\n                  weight: 'bold'\n                },\n                padding: 10,\n                callback: value => value + '%'\n              },\n              title: {\n                display: true,\n                text: 'Score (%)'\n              }\n            }\n          },\n          plugins: {\n            legend: {\n              display: true,\n              position: 'top',\n              labels: {\n                boxWidth: 15,\n                padding: 15,\n                font: {\n                  size: 14,\n                  weight: 'bold'\n                }\n              }\n            },\n            tooltip: {\n              backgroundColor: 'rgba(0, 0, 0, 0.8)',\n              titleFont: {\n                size: 14,\n                weight: 'bold'\n              },\n              bodyFont: {\n                size: 13\n              },\n              padding: 15,\n              cornerRadius: 8,\n              displayColors: false,\n              callbacks: {\n                title: tooltipItems => {\n                  return moment(tooltipItems[0].parsed.x).format('MMMM D, YYYY');\n                },\n                label: context => {\n                  const index = context.dataIndex;\n                  const item = data[index];\n                  return [`${type} #${item.number}`, `Score: ${item.rawScore}/${item.maxScore} (${item.score.toFixed(1)}%)`];\n                }\n              }\n            }\n          }\n        }\n      });\n    };\n\n    // Clean up charts when component unmounts\n    onUnmounted(() => {\n      // Clean up all charts\n      const chartIdBase = selectedStudent.value ? `performanceChart-${selectedStudent.value.studentNumber}` : '';\n      if (chartIdBase) {\n        // Destroy all charts\n        const chartIds = [`all-${chartIdBase}`, `quiz-${chartIdBase}`, `activity-${chartIdBase}`, `performance-${chartIdBase}`];\n        chartIds.forEach(id => {\n          const chartElement = document.getElementById(id);\n          if (chartElement) {\n            const chart = Chart.getChart(chartElement);\n            if (chart) {\n              chart.destroy();\n            }\n          }\n        });\n      }\n    });\n\n    // Watch for changes in selected student to update charts\n    watch(selectedStudent, () => {\n      if (selectedStudent.value) {\n        nextTick(() => {\n          createPerformanceChart();\n        });\n      } else {\n        // Clean up all charts when student is deselected\n        const chartIdBase = `performanceChart-${selectedStudent.value?.studentNumber}`;\n        if (chartIdBase) {\n          // Destroy all charts\n          const chartIds = [`all-${chartIdBase}`, `quiz-${chartIdBase}`, `activity-${chartIdBase}`, `performance-${chartIdBase}`];\n          chartIds.forEach(id => {\n            const chartElement = document.getElementById(id);\n            if (chartElement) {\n              const chart = Chart.getChart(chartElement);\n              if (chart) {\n                chart.destroy();\n              }\n            }\n          });\n        }\n      }\n    });\n\n    // Watch for changes in date range to update charts\n    watch([chartDateRange, historyDateRange], () => {\n      if (selectedStudent.value) {\n        nextTick(() => {\n          createPerformanceChart();\n        });\n      }\n    });\n\n    // Watch for changes in current date to refresh data\n    watch(currentDate, async () => {\n      await fetchAssessments();\n      if (selectedStudent.value) {\n        await viewStudentDetails(selectedStudent.value);\n      }\n    });\n\n    // Function to fetch user preferences from the API\n    const fetchUserPreferences = async () => {\n      try {\n        console.log('Fetching user preferences...');\n\n        // First try to get from localStorage\n        const localPrefs = localStorage.getItem('classRecordPreferences');\n        let localPrefsObj = null;\n        if (localPrefs) {\n          try {\n            localPrefsObj = JSON.parse(localPrefs);\n            console.log('Found preferences in localStorage:', localPrefsObj);\n\n            // Apply local preferences first\n            if (localPrefsObj.selectedYear) selectedYear.value = localPrefsObj.selectedYear;\n            if (localPrefsObj.selectedSection) selectedSection.value = localPrefsObj.selectedSection;\n            if (localPrefsObj.selectedSubject) selectedSubject.value = localPrefsObj.selectedSubject;\n            if (localPrefsObj.currentPage) currentPage.value = parseInt(localPrefsObj.currentPage) || 1;\n          } catch (parseError) {\n            console.error('Error parsing localStorage preferences:', parseError);\n            localStorage.removeItem('classRecordPreferences');\n          }\n        } else {\n          console.log('No preferences found in localStorage');\n        }\n\n        // Then try to get from backend\n        const token = store.state.auth.token;\n        const userId = store.state.auth.user?._id;\n        if (!userId) {\n          console.error('User ID not available for fetching preferences');\n          return;\n        }\n        console.log('Fetching preferences from backend for user:', userId);\n        const response = await api.get('/users/preferences', {\n          params: {\n            userId\n          },\n          headers: {\n            'Authorization': `Bearer ${token}`\n          }\n        });\n        console.log('Backend preferences response:', response.data);\n        if (response.data && response.data.preferences) {\n          const prefs = response.data.preferences;\n\n          // Update preferences if available\n          if (prefs.selectedYear) selectedYear.value = prefs.selectedYear;\n          if (prefs.selectedSection) selectedSection.value = prefs.selectedSection;\n          if (prefs.selectedSubject) selectedSubject.value = prefs.selectedSubject;\n          if (prefs.currentPage) currentPage.value = parseInt(prefs.currentPage) || 1;\n\n          // Save to localStorage to ensure consistency\n          localStorage.setItem('classRecordPreferences', JSON.stringify(prefs));\n          console.log('Updated preferences from backend:', prefs);\n        } else {\n          console.log('No preferences found in backend, using localStorage values');\n\n          // If we have local preferences but none from backend, save local to backend\n          if (localPrefsObj) {\n            await saveUserPreferences();\n          }\n        }\n        console.log('Final preferences after fetching:', {\n          year: selectedYear.value,\n          section: selectedSection.value,\n          subject: selectedSubject.value,\n          page: currentPage.value\n        });\n\n        // Fetch data based on preferences in a specific order\n        if (selectedYear.value) {\n          console.log('Fetching sections for year:', selectedYear.value);\n          await fetchAvailableSections();\n          if (selectedSection.value) {\n            console.log('Updating teacher subjects for section:', selectedSection.value);\n            await updateTeacherSubjects();\n            if (selectedSubject.value) {\n              console.log('Fetching class data for subject:', selectedSubject.value);\n              // Ensure we fetch the data with the current filters\n              await fetchClassData();\n\n              // Ensure the current page is applied after data is loaded\n              console.log('Applying saved page number:', currentPage.value);\n            }\n          }\n        }\n      } catch (error) {\n        console.error('Error fetching user preferences:', error);\n        console.error('Error details:', {\n          message: error.message,\n          response: error.response?.data,\n          status: error.response?.status\n        });\n\n        // Try to use localStorage preferences if API call fails\n        const localPrefs = localStorage.getItem('classRecordPreferences');\n        if (localPrefs) {\n          try {\n            const prefs = JSON.parse(localPrefs);\n            console.log('Falling back to localStorage preferences:', prefs);\n            selectedYear.value = prefs.selectedYear || '';\n            selectedSection.value = prefs.selectedSection || '';\n            selectedSubject.value = prefs.selectedSubject || '';\n            if (prefs.currentPage) currentPage.value = parseInt(prefs.currentPage) || 1;\n\n            // Try to fetch data with these preferences\n            if (selectedYear.value) {\n              await fetchAvailableSections();\n              if (selectedSection.value) {\n                await updateTeacherSubjects();\n                if (selectedSubject.value) {\n                  await fetchClassData();\n                }\n              }\n            }\n          } catch (parseError) {\n            console.error('Error parsing localStorage preferences during fallback:', parseError);\n          }\n        }\n      }\n    };\n\n    // Function to save user preferences to the API\n    const saveUserPreferences = async () => {\n      try {\n        const token = store.state.auth.token;\n        const userId = store.state.auth.user?._id;\n        if (!userId) {\n          console.error('User ID not available for saving preferences');\n          return;\n        }\n        const preferences = {\n          selectedYear: selectedYear.value,\n          selectedSection: selectedSection.value,\n          selectedSubject: selectedSubject.value,\n          currentPage: currentPage.value\n        };\n        console.log('Saving preferences:', preferences);\n\n        // Save to localStorage first for immediate persistence\n        localStorage.setItem('classRecordPreferences', JSON.stringify(preferences));\n\n        // Then save to backend\n        const response = await api.post('/users/preferences', {\n          userId,\n          preferences\n        }, {\n          headers: {\n            'Authorization': `Bearer ${token}`\n          }\n        });\n        console.log('User preferences saved successfully:', response.data);\n      } catch (error) {\n        console.error('Error saving user preferences:', error);\n        console.error('Error details:', {\n          message: error.message,\n          response: error.response?.data,\n          status: error.response?.status\n        });\n\n        // Ensure localStorage is still updated even if API call fails\n        try {\n          const preferences = {\n            selectedYear: selectedYear.value,\n            selectedSection: selectedSection.value,\n            selectedSubject: selectedSubject.value,\n            currentPage: currentPage.value\n          };\n          localStorage.setItem('classRecordPreferences', JSON.stringify(preferences));\n          console.log('Preferences saved to localStorage as fallback');\n        } catch (localStorageError) {\n          console.error('Failed to save preferences to localStorage:', localStorageError);\n        }\n      }\n    };\n\n    // Update the watchers for filter changes\n    watch([selectedYear, selectedSection, selectedSubject], async ([newYear, newSection, newSubject], [oldYear, oldSection, oldSubject]) => {\n      // Save preferences whenever they change\n      await saveUserPreferences();\n\n      // Handle year changes\n      if (newYear !== oldYear) {\n        selectedSection.value = '';\n        selectedSubject.value = '';\n        if (newYear) {\n          await fetchAvailableSections();\n        }\n      }\n\n      // Handle section changes\n      if (newSection !== oldSection) {\n        selectedSubject.value = '';\n        if (newSection) {\n          await updateTeacherSubjects();\n        }\n      }\n\n      // Handle subject changes\n      if (newSubject !== oldSubject && newSubject) {\n        await fetchClassData();\n      }\n    });\n\n    // Add watcher for currentPage\n    watch(currentPage, () => {\n      console.log('Current page changed to:', currentPage.value);\n      saveUserPreferences();\n    });\n\n    // Add cleanup on component unmount\n    onUnmounted(() => {\n      // Save preferences before unmounting\n      saveUserPreferences();\n\n      // Clear intervals if any\n      if (dateUpdateInterval) {\n        clearInterval(dateUpdateInterval);\n      }\n    });\n\n    // Add a function to load the last used filters\n    const loadLastUsedFilters = async () => {\n      try {\n        console.log('Attempting to load last used filters');\n        const token = store.state.auth.token;\n        const userId = store.state.auth.user?._id;\n        if (!userId) {\n          console.error('User ID not available for loading last used filters');\n          return false;\n        }\n\n        // First check if we have any recent filters in localStorage\n        const recentFilters = localStorage.getItem('recentFilters');\n        if (recentFilters) {\n          try {\n            const filters = JSON.parse(recentFilters);\n            console.log('Found recent filters in localStorage:', filters);\n            if (filters.length > 0) {\n              // Get the most recent filter\n              const mostRecent = filters[0];\n\n              // Apply the values\n              if (mostRecent.year) selectedYear.value = mostRecent.year;\n              if (mostRecent.section) selectedSection.value = mostRecent.section;\n              if (mostRecent.subject) selectedSubject.value = mostRecent.subject;\n\n              // Save to classRecordPreferences\n              const preferences = {\n                selectedYear: selectedYear.value,\n                selectedSection: selectedSection.value,\n                selectedSubject: selectedSubject.value,\n                currentPage: currentPage.value\n              };\n              localStorage.setItem('classRecordPreferences', JSON.stringify(preferences));\n              console.log('Recent filters applied from localStorage:', preferences);\n              return true;\n            }\n          } catch (parseError) {\n            console.error('Error parsing recent filters from localStorage:', parseError);\n          }\n        }\n\n        // If no recent filters in localStorage, try to get from API\n        try {\n          // First try to get the user's teaching assignments\n          const response = await api.get('/users/teaching-assignments', {\n            params: {\n              userId\n            },\n            headers: {\n              'Authorization': `Bearer ${token}`\n            }\n          });\n          if (response.data && response.data.assignments && response.data.assignments.length > 0) {\n            // Sort by last accessed timestamp if available\n            const sortedAssignments = [...response.data.assignments].sort((a, b) => {\n              // If lastAccessed is available, use it for sorting\n              if (a.lastAccessed && b.lastAccessed) {\n                return new Date(b.lastAccessed) - new Date(a.lastAccessed);\n              }\n              return 0;\n            });\n\n            // Use the most recently accessed assignment\n            const mostRecent = sortedAssignments[0];\n            console.log('Most recently used assignment from API:', mostRecent);\n\n            // Apply the values\n            if (mostRecent.year) selectedYear.value = mostRecent.year;\n            if (mostRecent.section) selectedSection.value = mostRecent.section;\n            if (mostRecent.subject) selectedSubject.value = mostRecent.subject;\n\n            // Save to localStorage\n            const preferences = {\n              selectedYear: selectedYear.value,\n              selectedSection: selectedSection.value,\n              selectedSubject: selectedSubject.value,\n              currentPage: currentPage.value\n            };\n            localStorage.setItem('classRecordPreferences', JSON.stringify(preferences));\n            console.log('Last used filters applied from API:', preferences);\n\n            // Also save to recentFilters\n            saveToRecentFilters({\n              year: selectedYear.value,\n              section: selectedSection.value,\n              subject: selectedSubject.value,\n              timestamp: new Date().toISOString()\n            });\n            return true;\n          } else {\n            console.log('No teaching assignments found in API');\n            return false;\n          }\n        } catch (apiError) {\n          console.error('Error fetching teaching assignments from API:', apiError);\n          return false;\n        }\n      } catch (error) {\n        console.error('Error loading last used filters:', error);\n        return false;\n      }\n    };\n\n    // Function to save a filter combination to the recent filters list\n    const saveToRecentFilters = filter => {\n      try {\n        // Get existing recent filters or initialize empty array\n        const recentFiltersStr = localStorage.getItem('recentFilters');\n        let recentFilters = [];\n        if (recentFiltersStr) {\n          try {\n            recentFilters = JSON.parse(recentFiltersStr);\n          } catch (parseError) {\n            console.error('Error parsing recent filters, resetting:', parseError);\n          }\n        }\n\n        // Check if this filter combination already exists\n        const existingIndex = recentFilters.findIndex(f => f.year === filter.year && f.section === filter.section && f.subject === filter.subject);\n\n        // If it exists, remove it (we'll add it back at the top)\n        if (existingIndex !== -1) {\n          recentFilters.splice(existingIndex, 1);\n        }\n\n        // Add the new filter at the beginning\n        recentFilters.unshift(filter);\n\n        // Keep only the 5 most recent filters\n        if (recentFilters.length > 5) {\n          recentFilters = recentFilters.slice(0, 5);\n        }\n\n        // Save back to localStorage\n        localStorage.setItem('recentFilters', JSON.stringify(recentFilters));\n        console.log('Updated recent filters:', recentFilters);\n      } catch (error) {\n        console.error('Error saving to recent filters:', error);\n      }\n    };\n\n    // Update assessment history table\n    const updateAssessmentHistoryTable = assessmentsByType => {\n      if (!selectedStudent.value) return;\n      console.log('Updating assessment history table with date range:', historyDateRange.value);\n\n      // If assessmentsByType is not provided, use the current assessments\n      if (!assessmentsByType) {\n        // Group assessments by type\n        assessmentsByType = {\n          'Quiz': [],\n          'Activity': [],\n          'Performance Task': []\n        };\n\n        // Filter assessments for the selected student\n        if (selectedStudent.value.assessments && selectedStudent.value.assessments.length > 0) {\n          selectedStudent.value.assessments.forEach(assessment => {\n            // Get the score for this student\n            const studentNumber = selectedStudent.value.studentNumber;\n            let scoreValue = null;\n\n            // Check if scores is a Map or an object\n            if (assessment.scores) {\n              if (assessment.scores instanceof Map) {\n                scoreValue = assessment.scores.get(studentNumber);\n              } else if (typeof assessment.scores === 'object') {\n                scoreValue = assessment.scores[studentNumber];\n              }\n            }\n\n            // If score is not found in assessment.scores, check student.scores\n            if ((scoreValue === null || scoreValue === undefined) && selectedStudent.value.scores && (assessment._id in selectedStudent.value.scores || assessment.id in selectedStudent.value.scores)) {\n              scoreValue = selectedStudent.value.scores[assessment._id] || selectedStudent.value.scores[assessment.id];\n            }\n            if (scoreValue !== null && scoreValue !== undefined) {\n              const maxScore = assessment.maxScore || 100;\n              const scorePercentage = scoreValue / maxScore * 100;\n\n              // Apply date filter if set\n              const assessmentDate = new Date(assessment.date);\n              const startDate = historyDateRange.value.start ? new Date(historyDateRange.value.start) : null;\n              const endDate = historyDateRange.value.end ? new Date(historyDateRange.value.end) : null;\n\n              // Skip if outside date range\n              if (startDate && assessmentDate < startDate || endDate && assessmentDate > endDate) {\n                return;\n              }\n              const type = assessment.type || 'Quiz'; // Default to Quiz if type is not specified\n\n              assessmentsByType[type].push({\n                ...assessment,\n                date: assessment.date,\n                rawScore: scoreValue,\n                score: scorePercentage,\n                maxScore: maxScore,\n                number: assessment.number,\n                title: `${assessment.type} #${assessment.number}`\n              });\n            }\n          });\n        }\n      }\n\n      // Get all assessments across all types\n      const allAssessments = [...(assessmentsByType['Quiz'] || []), ...(assessmentsByType['Activity'] || []), ...(assessmentsByType['Performance Task'] || [])];\n\n      // Apply date filter to the history table\n      const filteredAssessments = allAssessments.filter(assessment => {\n        const assessmentDate = new Date(assessment.date);\n        const startDate = historyDateRange.value.start ? new Date(historyDateRange.value.start) : null;\n        const endDate = historyDateRange.value.end ? new Date(historyDateRange.value.end) : null;\n        return (!startDate || assessmentDate >= startDate) && (!endDate || assessmentDate <= endDate);\n      });\n\n      // Sort by date (newest first)\n      filteredAssessments.sort((a, b) => new Date(b.date) - new Date(a.date));\n\n      // Store in the selected student object\n      selectedStudent.value.assessmentHistory = filteredAssessments.map(assessment => ({\n        date: assessment.date,\n        type: assessment.title || `${assessment.type} #${assessment.number}`,\n        score: assessment.rawScore,\n        maxScore: assessment.maxScore,\n        percentage: assessment.score\n      }));\n      console.log(`Updated assessment history with ${selectedStudent.value.assessmentHistory.length} records`);\n    };\n\n    // Helper function to get the student's score for an assessment\n    const getStudentScore = (student, assessment) => {\n      // Get the assessment ID\n      const assessmentId = assessment._id || assessment.id;\n\n      // Check if the student has a score for this assessment\n      if (student.scores && assessmentId in student.scores) {\n        return student.scores[assessmentId];\n      }\n\n      // Check if the assessment has a score for this student\n      if (assessment.scores) {\n        let score;\n\n        // Handle both Map and plain object\n        if (assessment.scores instanceof Map) {\n          score = assessment.scores.get(student.studentNumber);\n        } else if (typeof assessment.scores === 'object') {\n          score = assessment.scores[student.studentNumber];\n        }\n        if (score !== undefined) {\n          // Store the score in the student object for future reference\n          if (!student.scores) {\n            student.scores = {};\n          }\n          student.scores[assessmentId] = score;\n          return score;\n        }\n      }\n\n      // No score found\n      return '';\n    };\n    return {\n      selectedYear,\n      selectedSection,\n      selectedSubject,\n      searchQuery,\n      students,\n      assessments,\n      filteredAssessmentsByDate,\n      currentDate,\n      showAddAssessmentModal,\n      newAssessment,\n      selectedStudent,\n      quizChart,\n      activityChart,\n      performanceChart,\n      handleAddAssessment,\n      updateScore,\n      viewStudentDetails,\n      formatDate,\n      formatDateForDisplay,\n      navigateDate,\n      user,\n      showAddStudentRecordModal,\n      newStudentRecord,\n      canAddStudentRecord,\n      handleAddStudentRecord,\n      clearFilters,\n      sortField,\n      sortOrder,\n      sortBy,\n      getSortIcon,\n      sortedStudents,\n      showSearch,\n      toggleSearch,\n      handleSearch,\n      applyFilters,\n      getAssessmentBadgeClass,\n      getScoreClass,\n      updateCharts,\n      showEditAssessmentModal,\n      editingAssessment,\n      editAssessment,\n      handleEditAssessment,\n      handleDeleteAssessment,\n      selectedAssessmentType,\n      showChartDateFilter,\n      showHistoryDateFilter,\n      chartDateRange,\n      historyDateRange,\n      filteredAssessments,\n      applyChartDateFilter,\n      clearChartDateFilter,\n      applyHistoryDateFilter,\n      clearHistoryDateFilter,\n      handleLogout,\n      availableYears,\n      availableSections,\n      teacherSubjects,\n      openChartDateFilter,\n      openHistoryDateFilter,\n      slideDirection,\n      isNextDayDisabled,\n      openAddStudentRecordModal,\n      filteredSections,\n      canSelectSection,\n      canSelectSubject,\n      attendanceRecords,\n      attendanceStatistics,\n      fetchAttendance,\n      syncStudentRecords,\n      redirectToAttendance,\n      currentPage,\n      totalPages,\n      paginatedStudents,\n      paginationInfo,\n      nextPage,\n      previousPage,\n      createPerformanceChart,\n      loadLastUsedFilters,\n      // Add the new function\n      saveToRecentFilters,\n      // Add the new function\n      getStudentScore\n    };\n  }\n};","map":{"version":3,"names":["ref","computed","onMounted","onUnmounted","watch","nextTick","useStore","useRoute","useRouter","axios","moment","Chart","StudentDetailsModal","api","create","baseURL","headers","timeout","validateStatus","status","interceptors","request","use","config","console","log","method","toUpperCase","url","data","params","error","Promise","reject","response","message","name","components","setup","store","router","user","state","auth","fetchUserProfile","get","token","value","role","push","teachingYear","subjects","localPrefs","localStorage","getItem","prefs","JSON","parse","selectedYear","selectedSection","selectedSubject","currentPage","parseInt","parseError","loadLastUsedFilters","fetchUserPreferences","fetchAvailableSections","updateTeacherSubjects","fetchClassData","searchQuery","students","assessments","currentDate","tz","startOf","toDate","showAddAssessmentModal","selectedStudent","quizChart","activityChart","performanceChart","showAddStudentRecordModal","showSearch","sortField","sortOrder","newStudentRecord","year","section","subject","selectedAssessmentType","showChartDateFilter","showHistoryDateFilter","chartDateRange","start","subtract","format","end","historyDateRange","newAssessment","type","number","maxScore","availableYears","availableSections","sectionsByYear","teacherSubjects","availableSubjects","filteredStudents","filter","student","searchLower","toLowerCase","studentNumber","includes","firstName","lastName","sortedStudents","sortedList","sort","a","b","aVal","bVal","sortBy","field","getSortIcon","toggleSearch","handleSearch","applyFilters","saveUserPreferences","saveToRecentFilters","timestamp","Date","toISOString","userId","_id","post","recordError","fetchAssessments","changed","recoveryError","canAddStudentRecord","teacherId","Array","isArray","length","map","scores","alert","handleAddAssessment","assessment","date","loadingToast","showToast","hideToast","sortedAssessments","dateA","dateB","getTime","typeOrder","title","id","viewStudentDetails","filteredAssessmentsByDate","assessmentDate","currentDateStart","setUTCHours","setHours","getHours","currentDateEnd","updateScore","inputValue","assessmentId","scoreValue","undefined","scoreNum","isNaN","payload","score","success","updatedAssessment","assessmentIndex","findIndex","studentIndex","s","createPerformanceChart","updateAssessmentHistoryTable","duration","toast","document","createElement","className","innerHTML","body","appendChild","getElementById","style","head","setTimeout","contains","opacity","transform","transition","removeChild","chartIdBase","chartIds","forEach","chartElement","chart","getChart","destroy","Error","assessmentsData","today","thirtyDaysAgo","formatDate","handleAddStudentRecord","dispatch","studentsResponse","mappedStudents","studentId","classRecordData","createResponse","attendancePromises","then","catch","warn","resolve","all","attendanceError","fetchAttendance","classRecordCreated","checkResponse","checkError","newYear","newSection","newSubject","clearFilters","removeItem","emptyPreferences","preferences","getters","isLoggedIn","fetchAvailableYears","handleApiError","getAssessmentBadgeClass","getScoreClass","percentage","createChart","chartRef","existingChart","chartColors","Quiz","Activity","chartConfig","labels","datasets","backgroundColor","borderRadius","maxBarThickness","borderSkipped","options","responsive","maintainAspectRatio","plugins","legend","display","tooltip","titleColor","bodyColor","borderColor","borderWidth","padding","displayColors","callbacks","label","context","parsed","y","scales","x","grid","ticks","color","font","size","beginAtZero","max","drawBorder","callback","updateCharts","chartTypes","Object","entries","toFixed","showEditAssessmentModal","editingAssessment","editAssessment","handleEditAssessment","put","index","handleDeleteAssessment","confirm","delete","years","Set","record","sections","canSelectSection","canSelectSubject","filteredAssessments","startDate","endDate","applyChartDateFilter","clearChartDateFilter","applyHistoryDateFilter","clearHistoryDateFilter","handleLogout","navigateDate","direction","now","newDate","add","isAfter","slideDirection","formatDateForDisplay","dateString","toLocaleDateString","month","day","timeZone","openChartDateFilter","openHistoryDateFilter","isNextDayDisabled","selected","isSameOrAfter","fetchAvailableYearsAndSections","keys","defaultYears","defaultSections","fetchTeacherSubjects","setDefaultSubjects","openAddStudentRecordModal","filteredSections","dateUpdateInterval","setupDateAutoUpdate","checkAndUpdateDate","current","clearInterval","setInterval","attendanceRecords","attendanceStatistics","createAttendanceChart","syncStudentRecords","redirectToAttendance","query","itemsPerPage","totalPages","Math","ceil","paginatedStudents","slice","paginationInfo","min","nextPage","previousPage","quizChartInstance","activityChartInstance","performanceChartInstance","destroyChart","chartInstance","canvasRef","container","parentElement","canvas","handleDateFilterChange","dateFilter","handleAssessmentTypeChange","assessmentsByType","Map","scorePercentage","rawScore","allChartElement","ctx","getContext","allAssessments","item","noDataMessage","tension","pointBackgroundColor","pointBorderColor","pointRadius","dataset","time","unit","displayFormats","tooltipFormat","adapters","locale","text","weight","datasetLabel","position","quizChartElement","timeSeriesData","fill","raw","activityChartElement","performanceChartElement","createChartInstance","chartId","messageWrapper","getChartColors","gradient","border","point","pointHover","colors","createLinearGradient","addColorStop","pointBorderWidth","pointHoverRadius","pointHoverBackgroundColor","pointHoverBorderColor","pointHoverBorderWidth","animations","easing","from","to","loop","borderDash","boxWidth","titleFont","bodyFont","cornerRadius","tooltipItems","dataIndex","localPrefsObj","setItem","stringify","page","localStorageError","oldYear","oldSection","oldSubject","recentFilters","filters","mostRecent","assignments","sortedAssignments","lastAccessed","apiError","recentFiltersStr","existingIndex","f","splice","unshift","assessmentHistory","getStudentScore"],"sources":["D:\\au_dev\\client\\src\\views\\ClassRecords.vue"],"sourcesContent":["<template>\n  <div class=\"class-records\">\n    <!-- Control Buttons and Date Navigation -->\n    <div class=\"d-flex justify-content-between align-items-center mb-4\">\n      <div class=\"d-flex gap-2\">\n        <button class=\"btn btn-primary\" @click=\"openAddStudentRecordModal\">\n          <i class=\"fas fa-user-plus\"></i> Add Student Record\n        </button>\n        <button class=\"btn btn-primary\" @click=\"showAddAssessmentModal = true\">\n          <i class=\"fas fa-plus\"></i> Add Assessment\n        </button>\n      </div>\n      <!-- Add date navigation controls -->\n      <div class=\"d-flex align-items-center gap-3\">\n        <button class=\"btn btn-outline-primary\" @click=\"navigateDate(-1)\">\n          <i class=\"fas fa-chevron-left\"></i>\n        </button>\n        <div class=\"date-display\">\n          {{ formatDateForDisplay(currentDate) }}\n        </div>\n        <button \n          class=\"btn btn-outline-primary\" \n          @click=\"navigateDate(1)\"\n          :disabled=\"isNextDayDisabled\"\n        >\n          <i class=\"fas fa-chevron-right\"></i>\n        </button>\n      </div>\n    </div>\n\n    <!-- Records Table -->\n    <div class=\"card\">\n      <div class=\"card-body\">\n        <!-- Table Controls -->\n        <div class=\"table-controls mb-4\">\n          <div class=\"d-flex gap-3 align-items-center\">\n            <div class=\"d-flex gap-3\">\n              <!-- Sort Dropdown -->\n              <div class=\"dropdown\">\n                <button class=\"btn btn-control\" type=\"button\" data-bs-toggle=\"dropdown\" aria-expanded=\"false\">\n                  <i class=\"fas fa-sort me-2\"></i> Sort by\n                </button>\n                <ul class=\"dropdown-menu control-menu\">\n                  <li>\n                    <a class=\"dropdown-item d-flex align-items-center\" href=\"#\" @click=\"sortBy('studentNumber')\">\n                      <i class=\"fas fa-sort me-2\"></i> Student Number\n                      <i :class=\"getSortIcon('studentNumber')\" class=\"ms-auto\"></i>\n                    </a>\n                  </li>\n                  <li>\n                    <a class=\"dropdown-item d-flex align-items-center\" href=\"#\" @click=\"sortBy('lastName')\">\n                      <i class=\"fas fa-sort-alpha-down me-2\"></i> Name\n                      <i :class=\"getSortIcon('lastName')\" class=\"ms-auto\"></i>\n                    </a>\n                  </li>\n                </ul>\n              </div>\n\n              <!-- Filter Dropdown -->\n              <div class=\"dropdown\">\n                <button class=\"btn btn-control\" type=\"button\" data-bs-toggle=\"dropdown\" aria-expanded=\"false\">\n                  <i class=\"fas fa-filter me-2\"></i> Filter\n                  <span v-if=\"hasActiveFilters\" class=\"filter-badge\">!</span>\n                </button>\n                <div class=\"dropdown-menu control-menu p-3\" style=\"width: 280px\">\n                  <h6 class=\"dropdown-header mb-2\">Filter Options</h6>\n                  <div class=\"mb-3\">\n                    <label class=\"form-label\">Year Level</label>\n                    <select class=\"form-select form-select-sm\" v-model=\"selectedYear\" @change=\"applyFilters\">\n                      <option value=\"\">All Years</option>\n                      <option v-for=\"year in availableYears\" :key=\"year\" :value=\"year\">{{ year }}</option>\n                    </select>\n                  </div>\n                  <div class=\"mb-3\">\n                    <label class=\"form-label\">Section</label>\n                    <select class=\"form-select form-select-sm\" v-model=\"selectedSection\" @change=\"applyFilters\" :disabled=\"!selectedYear\">\n                      <option value=\"\">All Sections</option>\n                      <option v-for=\"section in availableSections\" :key=\"section\" :value=\"section\">{{ section }}</option>\n                    </select>\n                  </div>\n                  <div class=\"mb-3\">\n                    <label class=\"form-label\">Subject</label>\n                    <select class=\"form-select form-select-sm\" v-model=\"selectedSubject\" @change=\"applyFilters\" :disabled=\"!selectedSection\">\n                      <option value=\"\">All Subjects</option>\n                      <option v-for=\"subject in teacherSubjects\" :key=\"subject\" :value=\"subject\">{{ subject }}</option>\n                    </select>\n                  </div>\n                  <div class=\"d-flex justify-content-end gap-2 mt-3\">\n                    <button class=\"btn btn-sm btn-light\" @click=\"clearFilters\">\n                      Clear All\n                    </button>\n                    <button class=\"btn btn-sm btn-primary\" @click=\"applyFilters\">\n                      Apply Filters\n                    </button>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            <!-- Search Control -->\n            <div class=\"search-control\">\n              <div class=\"input-group\">\n                <span class=\"input-group-text\">\n                  <i class=\"fas fa-search\"></i>\n                </span>\n                <input \n                  type=\"text\" \n                  class=\"form-control\" \n                  v-model=\"searchQuery\"\n                  placeholder=\"Search students...\"\n                  @input=\"handleSearch\"\n                >\n                <button \n                  v-if=\"searchQuery\"\n                  class=\"btn btn-outline-secondary\" \n                  type=\"button\"\n                  @click=\"clearSearch\"\n                >\n                  <i class=\"fas fa-times\"></i>\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        <div class=\"table-responsive\">\n            <table class=\"table table-hover\">\n              <thead>\n                <tr>\n                  <th>Student Number</th>\n                  <th>Last Name</th>\n                  <th>First Name</th>\n                  <th v-for=\"assessment in filteredAssessmentsByDate\" :key=\"assessment.id\">\n                    <div class=\"assessment-header\" @click=\"editAssessment(assessment)\">\n                        {{ assessment.type }} {{ assessment.number }}\n                        <br>\n                        <small>({{ assessment.maxScore }} pts)</small>\n                    </div>\n                  </th>\n                </tr>\n              </thead>\n              <tbody>\n              <template v-if=\"paginatedStudents.length > 0\">\n                  <tr \n                  v-for=\"student in paginatedStudents\" \n                    :key=\"student.studentNumber\"\n                    @click=\"viewStudentDetails(student)\"\n                    class=\"clickable-row\"\n                  >\n                    <td>{{ student.studentNumber }}</td>\n                    <td>{{ student.lastName }}</td>\n                    <td>{{ student.firstName }}</td>\n                    <td v-for=\"assessment in filteredAssessmentsByDate\" :key=\"assessment.id\">\n                      <input \n                        type=\"number\" \n                        class=\"form-control form-control-sm score-input\"\n                        :value=\"getStudentScore(student, assessment)\"\n                        :max=\"assessment.maxScore\"\n                        min=\"0\"\n                        @input=\"updateScore(student, assessment, $event.target.value)\"\n                        @click.stop\n                      >\n                    </td>\n                  </tr>\n                </template>\n                <tr v-else>\n                  <td colspan=\"5\" class=\"text-center py-4\">\n                    <div class=\"empty-state-message\">\n                      <i class=\"fas fa-users text-muted mb-2\"></i>\n                      <p class=\"mb-0\">No students found</p>\n                      <p class=\"text-muted small\" v-if=\"hasActiveFilters\">\n                        Try adjusting your filters\n                      </p>\n                    </div>\n                  </td>\n                </tr>\n              </tbody>\n            </table>\n          </div>\n\n        <!-- Pagination Controls -->\n        <div class=\"pagination-controls mt-3 d-flex justify-content-between align-items-center\">\n          <div class=\"pagination-info\">\n            Showing {{ paginationInfo.start }} to {{ paginationInfo.end }} of {{ sortedStudents.length }} entries\n          </div>\n          <div class=\"pagination-buttons\">\n            <button \n              class=\"btn btn-outline-primary me-2\" \n              @click=\"previousPage\" \n              :disabled=\"currentPage === 1\"\n            >\n              <i class=\"fas fa-chevron-left me-1\"></i> Previous\n            </button>\n            <button \n              class=\"btn btn-outline-primary\" \n              @click=\"nextPage\" \n              :disabled=\"currentPage >= totalPages\"\n            >\n              Next <i class=\"fas fa-chevron-right ms-1\"></i>\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n\n    <!-- Add Student Record Modal -->\n    <div v-if=\"showAddStudentRecordModal\" class=\"modal-overlay\">\n      <div class=\"modal-wrapper\" @click.stop>\n        <div class=\"modal-dialog\">\n          <div class=\"modal-content\">\n            <div class=\"modal-header\">\n              <h5 class=\"modal-title\">Add Student Record</h5>\n              <button type=\"button\" class=\"btn-close\" @click=\"showAddStudentRecordModal = false\"></button>\n            </div>\n            <div class=\"modal-body\">\n              <form @submit.prevent=\"handleAddStudentRecord\">\n                <!-- Year Selection -->\n                <div class=\"mb-3\">\n                  <label class=\"form-label\">Year</label>\n                  <select class=\"form-select\" v-model=\"newStudentRecord.year\" required>\n                    <option value=\"\">Select Year</option>\n                    <template v-if=\"availableYears.length > 0\">\n                      <option v-for=\"year in availableYears\" :key=\"year\" :value=\"year\">\n                        {{ year }}\n                      </option>\n                    </template>\n                    <option v-else disabled>No available years</option>\n                  </select>\n                </div>\n                <!-- Section Selection -->\n                <div class=\"mb-3\">\n                  <label class=\"form-label\">Section</label>\n                  <select class=\"form-select\" v-model=\"newStudentRecord.section\" :disabled=\"!newStudentRecord.year\" required>\n                    <option value=\"\">Select Section</option>\n                    <template v-if=\"filteredSections.length > 0\">\n                      <option v-for=\"section in filteredSections\" :key=\"section\" :value=\"section\">\n                        {{ section }}\n                      </option>\n                    </template>\n                    <option v-else disabled>No available sections</option>\n                  </select>\n                </div>\n                <!-- Subject Selection -->\n                <div class=\"mb-3\">\n                  <label class=\"form-label\">Subject</label>\n                  <select class=\"form-select\" v-model=\"newStudentRecord.subject\" :disabled=\"!newStudentRecord.section\" required>\n                    <option value=\"\">Select Subject</option>\n                    <template v-if=\"teacherSubjects.length > 0\">\n                      <option v-for=\"subject in teacherSubjects\" :key=\"subject\" :value=\"subject\">\n                        {{ subject }}\n                      </option>\n                    </template>\n                    <option v-else disabled>No available subjects</option>\n                  </select>\n                </div>\n                <div class=\"d-flex justify-content-end gap-2\">\n                  <button type=\"button\" class=\"btn btn-secondary\" @click=\"showAddStudentRecordModal = false\">\n                    Cancel\n                  </button>\n                  <button type=\"submit\" class=\"btn btn-primary\" :disabled=\"!canAddStudentRecord\">\n                    Add Record\n                  </button>\n                </div>\n              </form>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div class=\"modal-backdrop\" @click=\"showAddStudentRecordModal = false\"></div>\n    </div>\n\n    <!-- Add Assessment Modal -->\n    <div v-if=\"showAddAssessmentModal\" class=\"modal-overlay\">\n      <div class=\"modal-wrapper\">\n        <div class=\"modal-dialog\">\n          <div class=\"modal-content\">\n            <div class=\"modal-header\">\n              <h5 class=\"modal-title\">Add Assessment</h5>\n              <button type=\"button\" class=\"btn-close\" @click=\"showAddAssessmentModal = false\"></button>\n            </div>\n            <div class=\"modal-body\">\n              <form @submit.prevent=\"handleAddAssessment\">\n                <!-- Assessment Type -->\n                <div class=\"mb-3\">\n                  <label class=\"form-label\">Type</label>\n                  <select class=\"form-select\" v-model=\"newAssessment.type\" required>\n                    <option value=\"\">Select Type</option>\n                    <option value=\"Quiz\">Quiz</option>\n                    <option value=\"Activity\">Activity</option>\n                    <option value=\"Performance Task\">Performance Task</option>\n                  </select>\n                </div>\n\n                <!-- Assessment Number -->\n                <div class=\"mb-3\">\n                  <label class=\"form-label\">Number</label>\n                  <input \n                    type=\"number\" \n                    class=\"form-control\" \n                    v-model=\"newAssessment.number\"\n                    min=\"1\"\n                    required\n                  >\n                </div>\n\n                <!-- Max Score -->\n                <div class=\"mb-3\">\n                  <label class=\"form-label\">Maximum Score</label>\n                  <input \n                    type=\"number\" \n                    class=\"form-control\" \n                    v-model=\"newAssessment.maxScore\"\n                    min=\"1\"\n                    required\n                  >\n                </div>\n\n                <div class=\"text-end\">\n                  <button type=\"button\" class=\"btn btn-secondary me-2\" @click=\"showAddAssessmentModal = false\">\n                    Cancel\n                  </button>\n                  <button type=\"submit\" class=\"btn btn-primary\">\n                    Add Assessment\n                  </button>\n                </div>\n              </form>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div class=\"modal-backdrop\" @click=\"showAddAssessmentModal = false\"></div>\n    </div>\n\n    <!-- Student Details Modal -->\n    <StudentDetailsModal\n      :show=\"!!selectedStudent\"\n      :student=\"selectedStudent || {}\"\n      :year-level=\"selectedYear\"\n      :section=\"selectedSection\"\n      :subject=\"selectedSubject\"\n      title=\"Student Performance Details\"\n      chart-title=\"Assessment Performance\"\n      history-title=\"Assessment History\"\n      :table-headers=\"['Date', 'Assessment', 'Score', 'Percentage']\"\n      :chart-id=\"`performanceChart-${selectedStudent?.studentNumber}`\"\n      :is-class-record=\"true\"\n      @update:show=\"(value) => !value && (selectedStudent = null)\"\n      @close=\"selectedStudent = null\"\n      @date-filter-change=\"handleDateFilterChange\"\n      @assessment-type-change=\"handleAssessmentTypeChange\"\n    >\n      <template #history-table>\n        <table class=\"table\">\n          <thead>\n            <tr>\n              <th>Date</th>\n              <th>Assessment</th>\n              <th>Score</th>\n              <th>Percentage</th>\n            </tr>\n          </thead>\n          <tbody>\n            <tr v-if=\"!selectedStudent?.assessmentHistory || selectedStudent.assessmentHistory.length === 0\">\n              <td colspan=\"4\" class=\"text-center py-3 text-muted\">\n                <i class=\"fas fa-info-circle me-2\"></i>No assessment records found.\n              </td>\n            </tr>\n            <tr v-for=\"record in selectedStudent?.assessmentHistory\" :key=\"record.date + record.type\">\n              <td>{{ formatDate(record.date) }}</td>\n              <td>{{ record.type }}</td>\n              <td>{{ record.score }}/{{ record.maxScore }}</td>\n              <td>\n                <span \n                  class=\"badge\"\n                  :class=\"{\n                    'bg-success': record.percentage >= 90,\n                    'bg-primary': record.percentage >= 80 && record.percentage < 90,\n                    'bg-warning': record.percentage >= 75 && record.percentage < 80,\n                    'bg-danger': record.percentage < 75\n                  }\"\n                >\n                  {{ record.percentage.toFixed(1) }}%\n                </span>\n              </td>\n            </tr>\n          </tbody>\n        </table>\n      </template>\n    </StudentDetailsModal>\n\n    <!-- Chart Date Filter Modal -->\n    <teleport to=\"body\" v-if=\"showChartDateFilter\">\n      <div class=\"modal-overlay\">\n        <div class=\"modal-wrapper\">\n          <div class=\"modal-dialog modal-sm\">\n            <div class=\"modal-content\">\n              <div class=\"modal-header\">\n                <h5 class=\"modal-title\">Filter Chart Date Range</h5>\n                <button type=\"button\" class=\"btn-close\" @click=\"showChartDateFilter = false\"></button>\n              </div>\n              <div class=\"modal-body\">\n                <div class=\"mb-3\">\n                  <label class=\"form-label\">Start Date</label>\n                  <input type=\"date\" class=\"form-control\" v-model=\"chartDateRange.start\">\n                </div>\n                <div class=\"mb-3\">\n                  <label class=\"form-label\">End Date</label>\n                  <input type=\"date\" class=\"form-control\" v-model=\"chartDateRange.end\">\n                </div>\n                </div>\n              <div class=\"modal-footer\">\n                <button type=\"button\" class=\"btn btn-secondary\" @click=\"clearChartDateFilter\">Clear</button>\n                <button type=\"button\" class=\"btn btn-primary\" @click=\"applyChartDateFilter\">Apply</button>\n            </div>\n          </div>\n        </div>\n        <div class=\"modal-backdrop\" @click=\"showChartDateFilter = false\"></div>\n        </div>\n      </div>\n    </teleport>\n\n    <!-- History Date Filter Modal -->\n    <teleport to=\"body\" v-if=\"showHistoryDateFilter\">\n      <div class=\"modal-overlay\">\n        <div class=\"modal-wrapper\">\n          <div class=\"modal-dialog modal-sm\">\n            <div class=\"modal-content\">\n              <div class=\"modal-header\">\n                <h5 class=\"modal-title\">Filter History Date Range</h5>\n                <button type=\"button\" class=\"btn-close\" @click=\"showHistoryDateFilter = false\"></button>\n              </div>\n              <div class=\"modal-body\">\n                <div class=\"mb-3\">\n                  <label class=\"form-label\">Start Date</label>\n                  <input type=\"date\" class=\"form-control\" v-model=\"historyDateRange.start\">\n                </div>\n                <div class=\"mb-3\">\n                  <label class=\"form-label\">End Date</label>\n                  <input type=\"date\" class=\"form-control\" v-model=\"historyDateRange.end\">\n                </div>\n                </div>\n              <div class=\"modal-footer\">\n                <button type=\"button\" class=\"btn btn-secondary\" @click=\"clearHistoryDateFilter\">Clear</button>\n                <button type=\"button\" class=\"btn btn-primary\" @click=\"applyHistoryDateFilter\">Apply</button>\n            </div>\n          </div>\n        </div>\n        <div class=\"modal-backdrop\" @click=\"showHistoryDateFilter = false\"></div>\n        </div>\n      </div>\n    </teleport>\n  </div>\n</template>\n\n<script>\nimport { ref, computed, onMounted, onUnmounted, watch, nextTick } from 'vue'\nimport { useStore } from 'vuex'\nimport { useRoute, useRouter } from 'vue-router'\nimport axios from 'axios'\nimport moment from 'moment-timezone'\nimport Chart from 'chart.js/auto'\nimport 'chartjs-adapter-moment'\nimport StudentDetailsModal from '@/components/modals/StudentDetailsModal.vue'\n\n// Create axios instance with base URL\nconst api = axios.create({\n  baseURL: 'http://localhost:8000/api',\n  headers: {\n    'Content-Type': 'application/json'\n  },\n  timeout: 10000, // 10 seconds timeout\n  validateStatus: function (status) {\n    return status >= 200 && status < 500; // Accept all status codes from 200-499\n  }\n});\n\n// Add request interceptor for logging\napi.interceptors.request.use(\n  config => {\n    console.log(`API Request: ${config.method.toUpperCase()} ${config.url}`, config.data || config.params);\n    return config;\n  },\n  error => {\n    console.error('API Request Error:', error);\n    return Promise.reject(error);\n  }\n);\n\n// Add response interceptor for logging\napi.interceptors.response.use(\n  response => {\n    console.log(`API Response: ${response.status} ${response.config.url}`, response.data);\n    return response;\n  },\n  error => {\n    if (error.response) {\n      console.error(`API Error Response: ${error.response.status} ${error.config?.url}`, error.response.data);\n    } else if (error.request) {\n      console.error('API No Response:', error.request);\n    } else {\n      console.error('API Error:', error.message);\n    }\n    return Promise.reject(error);\n  }\n);\n\nexport default {\n  name: 'ClassRecords',\n  components: {\n    StudentDetailsModal\n  },\n  setup() {\n    const store = useStore()\n    const router = useRouter()\n    const user = ref(store.state.auth.user || null)\n    \n    // Add user profile fetching\n    const fetchUserProfile = async () => {\n      try {\n        console.log('Fetching user profile...');\n        const response = await api.get('/users/profile', {\n          headers: {\n            'Authorization': `Bearer ${store.state.auth.token}`\n          }\n        });\n        \n        console.log('User profile response:', response.data);\n        user.value = response.data;\n        \n        // Check if user is a teacher\n        if (!user.value || user.value.role !== 'teacher') {\n          console.log('User is not a teacher:', user.value?.role);\n          router.push('/dashboard');\n          return;\n        }\n        \n        // Log teaching year and subjects\n        console.log('Teaching year:', user.value.teachingYear);\n        console.log('Subjects:', user.value.subjects);\n        \n        // If teaching year is not set, default to '1st'\n        if (!user.value.teachingYear) {\n          console.log('Teaching year not set, defaulting to 1st');\n          user.value.teachingYear = '1st';\n        }\n      } catch (error) {\n        console.error('Error fetching user profile:', error);\n        router.push('/login');\n      }\n    };\n\n    // Call fetchUserProfile when component mounts\n    onMounted(async () => {\n      try {\n        console.log('Component mounted, fetching user profile and subjects');\n        await fetchUserProfile();\n        console.log('User profile fetched, now fetching user preferences');\n        \n        // First check localStorage for preferences\n        const localPrefs = localStorage.getItem('classRecordPreferences');\n        if (localPrefs) {\n          try {\n            const prefs = JSON.parse(localPrefs);\n            console.log('Found preferences in localStorage:', prefs);\n            \n            // Apply local preferences immediately\n            if (prefs.selectedYear) selectedYear.value = prefs.selectedYear;\n            if (prefs.selectedSection) selectedSection.value = prefs.selectedSection;\n            if (prefs.selectedSubject) selectedSubject.value = prefs.selectedSubject;\n            if (prefs.currentPage) currentPage.value = parseInt(prefs.currentPage) || 1;\n          } catch (parseError) {\n            console.error('Error parsing localStorage preferences:', parseError);\n          }\n        } else {\n          // If no preferences in localStorage, try to load last used filters\n          await loadLastUsedFilters();\n        }\n        \n        // Then fetch from API\n        await fetchUserPreferences();\n        \n        // Ensure we have the necessary data to fetch records\n        if (selectedYear.value && selectedSection.value && selectedSubject.value) {\n          console.log('Fetching available sections for year:', selectedYear.value);\n          await fetchAvailableSections();\n          \n          console.log('Updating teacher subjects for section:', selectedSection.value);\n          await updateTeacherSubjects();\n          \n          console.log('Fetching class data for subject:', selectedSubject.value);\n          await fetchClassData();\n        } else {\n          console.log('Missing required filters, cannot fetch class data');\n          // Try to load last used filters if we still don't have them\n          if (!selectedYear.value || !selectedSection.value || !selectedSubject.value) {\n            await loadLastUsedFilters();\n            \n            // Try again with the loaded filters\n            if (selectedYear.value) {\n              await fetchAvailableSections();\n              \n              if (selectedSection.value) {\n                await updateTeacherSubjects();\n                \n                if (selectedSubject.value) {\n                  await fetchClassData();\n                }\n              }\n            }\n          }\n        }\n        \n        console.log('Initial data loading complete');\n      } catch (error) {\n        console.error('Error during component initialization:', error);\n      }\n    });\n\n    const selectedYear = ref('');\n    const selectedSection = ref('');\n    const selectedSubject = ref('');\n    const searchQuery = ref('');\n    const students = ref([]);\n    const assessments = ref([]);\n    const currentDate = ref(moment().tz('Asia/Manila').startOf('day').toDate());\n    const showAddAssessmentModal = ref(false);\n    const selectedStudent = ref(null);\n    const quizChart = ref(null);\n    const activityChart = ref(null);\n    const performanceChart = ref(null);\n    const showAddStudentRecordModal = ref(false);\n    const showSearch = ref(false);\n    const sortField = ref('');\n    const sortOrder = ref('asc');\n    const newStudentRecord = ref({\n      year: '',\n      section: '',\n      subject: ''\n    });\n\n    // Add new refs for filters\n    const selectedAssessmentType = ref('');\n    const showChartDateFilter = ref(false);\n    const showHistoryDateFilter = ref(false);\n    const chartDateRange = ref({\n      start: moment().subtract(30, 'days').format('YYYY-MM-DD'),\n      end: moment().format('YYYY-MM-DD')\n    });\n    const historyDateRange = ref({\n      start: moment().subtract(30, 'days').format('YYYY-MM-DD'),\n      end: moment().format('YYYY-MM-DD')\n    });\n\n    const newAssessment = ref({\n      type: '',\n      number: '',\n      maxScore: ''\n    })\n\n    // State for available years, sections, and subjects\n    const availableYears = ref([])\n    const availableSections = ref([])\n    const sectionsByYear = ref({})\n    const teacherSubjects = ref([])\n\n    const teachingYear = computed(() => {\n      console.log('User object:', user.value);\n      console.log('Teaching year:', user.value?.teachingYear);\n      return user.value?.teachingYear || 'N/A';\n    });\n\n    // Get available subjects based on teaching year\n    const availableSubjects = computed(() => {\n      const year = teachingYear.value\n      switch (year) {\n        case '1st':\n          return ['ITE 100', 'ITE 101', 'ITE 102', 'ITE 103']\n        case '2nd':\n          return ['ITE 200', 'ITE 201', 'ITE 202', 'ITE 203']\n        case '3rd':\n          return ['ITE 301', 'ITE 302', 'ITE 303', 'ITE 304']\n        case '4th':\n          return ['ITE 400', 'ITE 401', 'ITE 402', 'ITE 403', 'ITE 404']\n        default:\n          return []\n      }\n    })\n\n    // Filter students\n    const filteredStudents = computed(() => {\n      return students.value.filter(student => {\n        const searchLower = searchQuery.value.toLowerCase()\n        return (\n          student.studentNumber.toLowerCase().includes(searchLower) ||\n          student.firstName.toLowerCase().includes(searchLower) ||\n          student.lastName.toLowerCase().includes(searchLower)\n        )\n      })\n    })\n\n    // Sort students\n    const sortedStudents = computed(() => {\n      let sortedList = [...filteredStudents.value]\n\n      if (sortField.value) {\n        sortedList.sort((a, b) => {\n          let aVal = a[sortField.value]\n          let bVal = b[sortField.value]\n\n          // Handle case-insensitive string comparison\n          if (typeof aVal === 'string') aVal = aVal.toLowerCase()\n          if (typeof bVal === 'string') bVal = bVal.toLowerCase()\n\n          if (aVal < bVal) return sortOrder.value === 'asc' ? -1 : 1\n          if (aVal > bVal) return sortOrder.value === 'asc' ? 1 : -1\n          return 0\n        })\n      }\n\n      return sortedList\n    })\n\n    // Sort functions\n    const sortBy = (field) => {\n      if (sortField.value === field) {\n        sortOrder.value = sortOrder.value === 'asc' ? 'desc' : 'asc'\n      } else {\n        sortField.value = field\n        sortOrder.value = 'asc'\n      }\n    }\n\n    const getSortIcon = (field) => {\n      if (sortField.value !== field) return 'fas fa-sort'\n      return sortOrder.value === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'\n    }\n\n    // Search functions\n    const toggleSearch = () => {\n      showSearch.value = !showSearch.value\n      if (!showSearch.value) {\n        searchQuery.value = ''\n      }\n    }\n\n    const handleSearch = () => {\n      // Additional search logic can be added here if needed\n      console.log('Searching for:', searchQuery.value)\n    }\n\n    // Filter functions\n    const applyFilters = async () => {\n      try {\n        console.log('Applying filters:', {\n          year: selectedYear.value,\n          section: selectedSection.value,\n          subject: selectedSubject.value\n        });\n        \n        // Save the applied filters as preferences first\n        await saveUserPreferences();\n        \n        // Save to recent filters\n        if (selectedYear.value && selectedSection.value && selectedSubject.value) {\n          saveToRecentFilters({\n            year: selectedYear.value,\n            section: selectedSection.value,\n            subject: selectedSubject.value,\n            timestamp: new Date().toISOString()\n          });\n        }\n        \n        // Record the timestamp for this filter combination\n        try {\n          const token = store.state.auth.token;\n          const userId = store.state.auth.user?._id;\n          \n          if (userId && selectedYear.value && selectedSection.value && selectedSubject.value) {\n            await api.post('/users/record-filter-usage', {\n              userId,\n              year: selectedYear.value,\n              section: selectedSection.value,\n              subject: selectedSubject.value,\n              timestamp: new Date().toISOString()\n            }, {\n              headers: { 'Authorization': `Bearer ${token}` }\n            });\n            \n            console.log('Filter usage recorded');\n          }\n        } catch (recordError) {\n          console.error('Error recording filter usage:', recordError);\n          // Non-critical error, continue with the rest of the function\n        }\n        \n        // Always fetch data when filters are applied, regardless of whether all filters are selected\n        await fetchClassData();\n        \n        // Only fetch assessments if we have all the necessary filters\n        if (selectedYear.value && selectedSection.value && selectedSubject.value) {\n          await fetchAssessments();\n        }\n      } catch (error) {\n        console.error('Error applying filters:', error);\n        console.error('Error details:', {\n          message: error.message,\n          response: error.response?.data,\n          status: error.response?.status\n        });\n        \n        // Try to recover by using localStorage values\n        try {\n          const localPrefs = localStorage.getItem('classRecordPreferences');\n          if (localPrefs) {\n            const prefs = JSON.parse(localPrefs);\n            console.log('Recovering with localStorage preferences:', prefs);\n            \n            // Only update if values are different to avoid infinite loops\n            let changed = false;\n            \n            if (prefs.selectedYear && prefs.selectedYear !== selectedYear.value) {\n              selectedYear.value = prefs.selectedYear;\n              changed = true;\n            }\n            \n            if (prefs.selectedSection && prefs.selectedSection !== selectedSection.value) {\n              selectedSection.value = prefs.selectedSection;\n              changed = true;\n            }\n            \n            if (prefs.selectedSubject && prefs.selectedSubject !== selectedSubject.value) {\n              selectedSubject.value = prefs.selectedSubject;\n              changed = true;\n            }\n            \n            // If we made changes, try to fetch data again\n            if (changed) {\n              console.log('Recovered with localStorage values, fetching data again');\n              await fetchClassData();\n              \n              if (selectedYear.value && selectedSection.value && selectedSubject.value) {\n                await fetchAssessments();\n              }\n            }\n          }\n        } catch (recoveryError) {\n          console.error('Failed to recover with localStorage:', recoveryError);\n        }\n      }\n    };\n\n    // Computed property to check if record can be added\n    const canAddStudentRecord = computed(() => {\n      return newStudentRecord.value.year && \n             newStudentRecord.value.section && \n             newStudentRecord.value.subject\n    })\n\n    // Fetch class data\n    const fetchClassData = async () => {\n      try {\n        if (!selectedYear.value || !selectedSection.value || !selectedSubject.value) {\n          console.log('Missing required filters for fetchClassData:', {\n            year: selectedYear.value || 'missing',\n            section: selectedSection.value || 'missing',\n            subject: selectedSubject.value || 'missing'\n          });\n          students.value = [];\n          return;\n        }\n\n        // Create a params object with the teacher ID\n        const teacherId = store.state.auth.user?._id;\n        if (!teacherId) {\n          console.error('Teacher ID not available');\n          return;\n        }\n        \n        const params = { \n          teacherId,\n          year: selectedYear.value,\n          section: selectedSection.value,\n          subject: selectedSubject.value\n        };\n        \n        console.log('Fetching class data with filters:', params);\n        \n        // Make the API call with the available filters\n        const response = await api.get('/teacher-class-records/students', { \n          params,\n          headers: {\n            'Authorization': `Bearer ${store.state.auth.token}`\n          }\n        });\n        \n        if (!response.data || !Array.isArray(response.data) || response.data.length === 0) {\n          console.log('No students found for the selected filters');\n          students.value = [];\n          return;\n        }\n        \n        // Map the students and initialize scores\n        students.value = response.data.map(student => ({\n            ...student,\n          scores: {}\n        }));\n\n        // Fetch assessments after loading students\n        await fetchAssessments();\n\n        console.log('Fetched students:', students.value.length);\n      } catch (error) {\n        console.error('Failed to fetch class data:', error);\n        console.error('Error details:', {\n          message: error.message,\n          response: error.response?.data,\n          status: error.response?.status\n        });\n        \n        // Don't show alert for every error to avoid overwhelming the user\n        if (error.response?.status !== 400) {\n        alert('Failed to load class data. Please try again.');\n        }\n        \n        students.value = [];\n      }\n    };\n\n    // Handle adding new assessment\n    const handleAddAssessment = async () => {\n      try {\n        if (!selectedSection.value || !selectedSubject.value) {\n          alert('Please select a section and subject first');\n          return;\n        }\n\n        const teacherId = store.state.auth.user?._id;\n        if (!teacherId) {\n          console.error('Teacher ID not available');\n          return;\n        }\n\n        // Use the current table date for the assessment\n        const assessment = {\n          type: newAssessment.value.type,\n          number: parseInt(newAssessment.value.number),\n          maxScore: parseInt(newAssessment.value.maxScore),\n          teacherId,\n          section: selectedSection.value,\n          subject: selectedSubject.value,\n          date: currentDate.value.toISOString()\n        };\n\n        const response = await api.post(\n          '/assessments',\n          assessment,\n          {\n            headers: {\n              'Authorization': `Bearer ${store.state.auth.token}`,\n              'Content-Type': 'application/json'\n            }\n          }\n        );\n\n        // Add the new assessment to the list\n        assessments.value.push(response.data);\n        \n        // Reset form and close modal\n        newAssessment.value = {\n          type: '',\n          number: '',\n          maxScore: ''\n        };\n        showAddAssessmentModal.value = false;\n      } catch (error) {\n        console.error('Failed to add assessment:', error);\n        alert('Failed to add assessment. ' + (error.response?.data?.message || 'Please try again.'));\n      }\n    };\n\n    // Update the fetchAssessments function\n    const fetchAssessments = async () => {\n      try {\n        if (!selectedSection.value || !selectedSubject.value) {\n          console.log('Missing required filters for fetching assessments');\n          return;\n        }\n\n        const teacherId = store.state.auth.user?._id || user.value?._id;\n        const date = moment(currentDate.value).format('YYYY-MM-DD');\n        \n        console.log('Fetching assessments for:', {\n          teacherId,\n          section: selectedSection.value,\n          subject: selectedSubject.value,\n          date\n        });\n\n        // Show loading indicator\n        const loadingToast = showToast('Loading assessments...', 'info', 0);\n\n        const response = await api.get('/assessments', {\n          params: {\n            teacherId,\n            section: selectedSection.value,\n            subject: selectedSubject.value,\n            date\n          },\n          headers: {\n            'Authorization': `Bearer ${store.state.auth.token}`\n          }\n        });\n\n        // Hide loading indicator\n        hideToast(loadingToast);\n\n        if (!response.data || !Array.isArray(response.data)) {\n          console.error('Invalid response data:', response.data);\n          showToast('Failed to load assessments', 'error', 3000);\n          return;\n        }\n\n        console.log(`Loaded ${response.data.length} assessments`);\n\n        // Sort assessments by date and type\n        const sortedAssessments = response.data.sort((a, b) => {\n          // First sort by date\n          const dateA = new Date(a.date);\n          const dateB = new Date(b.date);\n          if (dateA.getTime() !== dateB.getTime()) {\n            return dateA - dateB;\n          }\n          \n          // If dates are equal, sort by type\n          const typeOrder = { 'Quiz': 1, 'Activity': 2, 'Performance Task': 3 };\n          if (typeOrder[a.type] !== typeOrder[b.type]) {\n            return typeOrder[a.type] - typeOrder[b.type];\n          }\n          \n          // If types are equal, sort by number\n          return a.number - b.number;\n        });\n\n        // Map the assessments and initialize scores\n        assessments.value = sortedAssessments.map(assessment => {\n          // Create a title if it doesn't exist\n          const title = assessment.title || `${assessment.type} ${assessment.number}`;\n          \n          return {\n            ...assessment,\n            id: assessment._id,\n            title,\n            scores: assessment.scores || {},\n            date: assessment.date ? new Date(assessment.date) : new Date()\n          };\n        });\n\n        console.log('Processed assessments:', assessments.value);\n\n        // If a student is selected, update their assessment data\n        if (selectedStudent.value) {\n          await viewStudentDetails(selectedStudent.value);\n        }\n\n        // Show success message if assessments were loaded\n        if (assessments.value.length > 0) {\n          showToast(`Loaded ${assessments.value.length} assessments`, 'success', 2000);\n        } else {\n          showToast('No assessments found for the selected filters', 'info', 3000);\n        }\n      } catch (error) {\n        console.error('Error fetching assessments:', error);\n        showToast('Failed to load assessments: ' + (error.message || 'Unknown error'), 'error', 3000);\n      }\n    };\n\n    // Update the computed property for filtered assessments\n    const filteredAssessmentsByDate = computed(() => {\n      return assessments.value.filter(assessment => {\n        const assessmentDate = new Date(assessment.date);\n        const currentDateStart = new Date(currentDate.value);\n        currentDateStart.setUTCHours(0, 0, 0, 0);\n        currentDateStart.setHours(currentDateStart.getHours() + 8); // Adjust for Philippine timezone\n        \n        const currentDateEnd = new Date(currentDate.value);\n        currentDateEnd.setUTCHours(23, 59, 59, 999);\n        currentDateEnd.setHours(currentDateEnd.getHours() + 8); // Adjust for Philippine timezone\n        \n        return assessmentDate >= currentDateStart && assessmentDate <= currentDateEnd;\n      }).sort((a, b) => {\n        // Sort by type first\n        const typeOrder = { 'Quiz': 1, 'Activity': 2, 'Performance Task': 3 };\n        if (typeOrder[a.type] !== typeOrder[b.type]) {\n          return typeOrder[a.type] - typeOrder[b.type];\n        }\n        \n        // Then by number\n        return a.number - b.number;\n      });\n    });\n\n    // Add watcher for currentDate to refresh assessments\n    watch(currentDate, async () => {\n      await fetchAssessments();\n    });\n\n    // Update student score\n    const updateScore = async (student, assessment, inputValue) => {\n      try {\n        const token = store.state.auth.token;\n        const teacherId = store.state.auth.user?._id;\n\n        if (!teacherId) {\n          console.error('Teacher ID not available');\n          showToast('Teacher ID not available. Please log in again.', 'error', 3000);\n          return;\n        }\n\n        // Get the assessment ID\n        const assessmentId = assessment._id || assessment.id;\n        \n        if (!assessmentId) {\n          console.error('Assessment ID not available');\n          showToast('Assessment ID not available. Please try again.', 'error', 3000);\n          return;\n        }\n\n        // Get the score from the input field or parameter\n        let scoreValue = inputValue;\n        if (scoreValue === undefined) {\n          scoreValue = student.scores?.[assessmentId];\n        }\n        \n        // Validate score\n        if (scoreValue === null || scoreValue === '') {\n          // Handle empty score\n          scoreValue = null;\n          console.log(`Removing score for student ${student.studentNumber}, assessment ${assessmentId}`);\n        } else {\n          const scoreNum = parseInt(scoreValue);\n          if (isNaN(scoreNum) || scoreNum < 0 || scoreNum > assessment.maxScore) {\n            showToast(`Please enter a valid score between 0 and ${assessment.maxScore}`, 'error', 3000);\n            return;\n          }\n          scoreValue = scoreNum; // Ensure it's a number\n        }\n\n        console.log(`Updating score for student ${student.studentNumber}, assessment ${assessmentId}: ${scoreValue}`);\n\n        // Create the request payload for the new endpoint\n        const payload = {\n          assessmentId,\n          teacherId,\n          studentNumber: student.studentNumber,\n          score: scoreValue\n        };\n\n        console.log('Sending score update request with payload:', payload);\n\n        // Show loading indicator\n        const loadingToast = showToast('Updating score...', 'info', 0);\n\n        // Use the new direct score update endpoint\n        const response = await api.post(\n          `/assessments/update-score-direct`,\n          payload,\n          {\n            headers: {\n              'Authorization': `Bearer ${token}`,\n              'Content-Type': 'application/json'\n            }\n          }\n        );\n\n        // Hide loading indicator\n        hideToast(loadingToast);\n\n        console.log('Score update response:', response.data);\n\n        if (!response.data || !response.data.success) {\n          console.error('Error updating score:', response.data?.message || 'Unknown error');\n          showToast(response.data?.message || 'Failed to update score', 'error', 3000);\n          return;\n        }\n\n        // Show success message\n        showToast('Score updated successfully', 'success', 2000);\n\n        // Update the local assessment scores\n        const updatedAssessment = response.data.assessment;\n        \n        if (!updatedAssessment) {\n          console.error('No assessment returned from server');\n          return;\n        }\n        \n        console.log('Updated assessment:', updatedAssessment);\n        console.log('Updated scores:', updatedAssessment.scores);\n        \n        // Find the assessment in the local array\n        const assessmentIndex = assessments.value.findIndex(a => \n          a._id === assessmentId || a.id === assessmentId\n        );\n        \n        if (assessmentIndex !== -1) {\n          // Update the assessment in the array with the new scores\n          assessments.value[assessmentIndex] = {\n            ...assessments.value[assessmentIndex],\n            scores: updatedAssessment.scores || {}\n          };\n\n          // Force a UI update\n          assessments.value = [...assessments.value];\n          \n          // Update the student's scores in the UI\n          if (students.value) {\n            const studentIndex = students.value.findIndex(s => \n              s.studentNumber === student.studentNumber\n            );\n            \n            if (studentIndex !== -1) {\n              // Make sure the scores object exists\n              if (!students.value[studentIndex].scores) {\n                students.value[studentIndex].scores = {};\n              }\n              \n              // Update the score\n              students.value[studentIndex].scores[assessmentId] = scoreValue;\n              \n              // Force a UI update\n              students.value = [...students.value];\n            }\n          }\n          \n          // If the student is currently selected in the details modal, update their chart\n          if (selectedStudent.value && selectedStudent.value.studentNumber === student.studentNumber) {\n            // Update the chart on the next tick to ensure the DOM is updated\n            nextTick(() => {\n              createPerformanceChart();\n              updateAssessmentHistoryTable();\n            });\n          }\n        }\n      } catch (error) {\n        console.error('Error updating score:', error);\n        showToast('Failed to update score. Please try again.', 'error', 3000);\n      }\n    };\n    \n    // Helper function to show toast messages\n    const showToast = (message, type = 'info', duration = 3000) => {\n      const toast = document.createElement('div');\n      toast.className = `toast toast-${type}`;\n      toast.innerHTML = message;\n      document.body.appendChild(toast);\n      \n      // Add styles if they don't exist\n      if (!document.getElementById('toast-styles')) {\n        const style = document.createElement('style');\n        style.id = 'toast-styles';\n        style.innerHTML = `\n          .toast {\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            padding: 12px 20px;\n            border-radius: 4px;\n            color: white;\n            font-weight: bold;\n            z-index: 9999;\n            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n            animation: toast-in 0.3s ease-out;\n          }\n          .toast-info {\n            background-color: #3498db;\n          }\n          .toast-success {\n            background-color: #2ecc71;\n          }\n          .toast-warning {\n            background-color: #f39c12;\n          }\n          .toast-error {\n            background-color: #e74c3c;\n          }\n          @keyframes toast-in {\n            from { transform: translateY(-20px); opacity: 0; }\n            to { transform: translateY(0); opacity: 1; }\n          }\n        `;\n        document.head.appendChild(style);\n      }\n      \n      // Remove toast after duration (if not 0)\n      if (duration > 0) {\n        setTimeout(() => {\n          hideToast(toast);\n        }, duration);\n      }\n      \n      return toast;\n    };\n    \n    // Helper function to hide toast\n    const hideToast = (toast) => {\n      if (!toast || !document.body.contains(toast)) return;\n      \n      toast.style.opacity = '0';\n      toast.style.transform = 'translateY(-20px)';\n      toast.style.transition = 'all 0.3s ease-out';\n      \n      setTimeout(() => {\n        if (document.body.contains(toast)) {\n          document.body.removeChild(toast);\n        }\n      }, 300);\n    };\n\n    // View student details\n    const viewStudentDetails = async (student) => {\n      try {\n        if (!student) {\n          console.error('Invalid student data provided to viewStudentDetails');\n          return;\n        }\n\n        // Clean up existing charts if any\n        if (selectedStudent.value) {\n          const chartIdBase = `performanceChart-${selectedStudent.value.studentNumber}`;\n          const chartIds = [\n            `all-${chartIdBase}`,\n            `quiz-${chartIdBase}`,\n            `activity-${chartIdBase}`,\n            `performance-${chartIdBase}`\n          ];\n          \n          chartIds.forEach(id => {\n            const chartElement = document.getElementById(id);\n            if (chartElement) {\n              const chart = Chart.getChart(chartElement);\n              if (chart) {\n                chart.destroy();\n              }\n            }\n          });\n        }\n\n        // Reset assessment type to 'All'\n        selectedAssessmentType.value = 'All';\n\n        // Get all assessments for this student\n        const response = await api.get('/assessments', {\n          params: {\n            teacherId: store.state.auth.user?._id,\n            section: selectedSection.value,\n            subject: selectedSubject.value\n          },\n          headers: {\n            'Authorization': `Bearer ${store.state.auth.token}`\n          }\n        });\n\n        if (!response.data) {\n          throw new Error('Failed to fetch assessment data');\n        }\n\n        // Map the assessments to include scores\n        const assessmentsData = response.data.map(assessment => ({\n          ...assessment,\n          id: assessment._id,\n          scores: assessment.scores || {}\n        }));\n\n        // Update the selected student with assessment data\n        selectedStudent.value = {\n          ...student,\n          assessments: assessmentsData\n        };\n\n        // Set default date ranges if not already set\n        const today = moment().format('YYYY-MM-DD');\n        const thirtyDaysAgo = moment().subtract(30, 'days').format('YYYY-MM-DD');\n        \n        chartDateRange.value = {\n          start: thirtyDaysAgo,\n          end: today\n        };\n        \n        historyDateRange.value = {\n          start: thirtyDaysAgo,\n          end: today\n        };\n\n        // Create charts on next tick to ensure DOM is ready\n        nextTick(() => {\n          createPerformanceChart();\n        });\n      } catch (error) {\n        console.error('Error fetching student details:', error);\n        alert('Failed to load student details. Please try again.');\n      }\n    };\n\n    // Add watch for currentDate to update student details when date changes\n    watch(currentDate, async () => {\n      if (selectedStudent.value) {\n        await viewStudentDetails(selectedStudent.value);\n      }\n    });\n\n    // Format date\n    const formatDate = (date) => {\n      if (!date) return ''\n      return moment(date).tz('Asia/Manila').format('MMMM D, YYYY')\n    }\n\n    // Function to update teacher subjects\n    const updateTeacherSubjects = async () => {\n      try {\n        if (!selectedYear.value || !selectedSection.value) {\n          console.log('Missing year or section for fetching subjects');\n          teacherSubjects.value = [];\n          return;\n        }\n\n        const teacherId = store.state.auth.user?._id;\n        const response = await api.get('/teacher-class-records/available-subjects', {\n          params: {\n            teacherId,\n            year: selectedYear.value,\n            section: selectedSection.value\n          },\n          headers: { \n            'Authorization': `Bearer ${store.state.auth.token}` \n          }\n        });\n\n        if (response.data && response.data.subjects) {\n          teacherSubjects.value = response.data.subjects.sort();\n          console.log('Fetched teacher subjects:', teacherSubjects.value);\n\n          // If no subject is selected but we have subjects available, select the first one\n          if (!selectedSubject.value && teacherSubjects.value.length > 0) {\n            selectedSubject.value = teacherSubjects.value[0];\n          }\n        } else {\n          teacherSubjects.value = [];\n        }\n      } catch (error) {\n        console.error('Failed to fetch teacher subjects:', error);\n        teacherSubjects.value = [];\n      }\n    }\n\n    // Handle adding new student record\n    const handleAddStudentRecord = async () => {\n      console.log('handleAddStudentRecord function called');\n      try {\n        const token = store.state.auth.token;\n        const teacherId = store.state.auth.user?._id || user.value?._id;\n\n        console.log('Adding student record with:', {\n          year: newStudentRecord.value.year,\n          section: newStudentRecord.value.section,\n          subject: newStudentRecord.value.subject\n        });\n\n        if (!teacherId) {\n          console.error('Teacher ID not available');\n          alert('Teacher information is not available. Please try logging in again.');\n          store.dispatch('logout');\n          router.push('/login');\n          return;\n        }\n\n        // First get students from the selected section\n        console.log('Fetching students for section:', newStudentRecord.value.year, newStudentRecord.value.section);\n        const studentsResponse = await api.get(`/students/by-section`, {\n          params: {\n            year: newStudentRecord.value.year,\n            section: newStudentRecord.value.section\n          },\n          headers: {\n            'Authorization': `Bearer ${token}`\n          }\n        });\n\n        console.log('Students response:', studentsResponse.data);\n\n        if (!studentsResponse.data || studentsResponse.data.length === 0) {\n          alert('No students found in the selected section.');\n          return;\n        }\n\n        // Map students to the required format\n        const mappedStudents = studentsResponse.data.map(student => ({\n          studentId: student._id,\n          studentNumber: student.studentId,\n          firstName: student.firstName,\n          lastName: student.lastName,\n          year: student.year,\n          section: student.section\n        }));\n\n        console.log('Mapped students:', mappedStudents);\n\n        // Create the class record\n        const classRecordData = {\n          teacherId,\n          year: newStudentRecord.value.year,\n          section: newStudentRecord.value.section,\n          subject: newStudentRecord.value.subject,\n          students: mappedStudents\n        };\n\n        console.log('Creating class record with data:', classRecordData);\n\n        // Save the class record\n        const createResponse = await api.post(\n          '/teacher-class-records/create', \n          classRecordData,\n          {\n            headers: {\n              'Authorization': `Bearer ${token}`,\n              'Content-Type': 'application/json'\n            }\n          }\n        );\n\n        console.log('Create response:', createResponse.data);\n\n        if (createResponse.data) {\n          try {\n            // Initialize attendance records for all students\n            // Get the current date in Philippine timezone\n            const today = moment().tz('Asia/Manila').startOf('day').format('YYYY-MM-DD');\n            \n            console.log('Creating attendance records for date:', today);\n            \n            // Create attendance records for each student\n            const attendancePromises = mappedStudents.map(student => {\n              console.log(`Creating attendance record for student ${student.firstName} ${student.lastName} (${student.studentNumber})`);\n              return api.post('/attendance', {\n                studentId: student.studentId,\n                teacherId,\n                date: today,\n                subject: newStudentRecord.value.subject,\n                section: newStudentRecord.value.section,\n                status: 'present' // Default status\n              }, {\n                headers: {\n                  'Authorization': `Bearer ${token}`,\n                  'Content-Type': 'application/json'\n                }\n              }).then(response => {\n                console.log(`Successfully created attendance record for student ${student.studentNumber}:`, response.data);\n                return response;\n              }).catch(error => {\n                console.warn(`Failed to create attendance record for student ${student.studentNumber}:`, error);\n                \n                // If the endpoint doesn't exist, log a more specific message\n                if (error.response && error.response.status === 404) {\n                  console.warn('Attendance API endpoint not found. This is expected if the attendance service is not yet implemented.');\n                }\n                \n                // Return a resolved promise to prevent Promise.all from failing\n                return Promise.resolve();\n              });\n            });\n            \n            // Wait for all attendance records to be created\n            await Promise.all(attendancePromises);\n            console.log('Attendance records creation completed');\n          } catch (attendanceError) {\n            console.warn('Error creating attendance records:', attendanceError);\n            // Continue with the process even if attendance creation fails\n          }\n\n          // Close modal and reset form\n          showAddStudentRecordModal.value = false;\n          newStudentRecord.value = {\n            year: '',\n            section: '',\n            subject: ''\n          };\n\n          // Update the selected filters to show the new record\n          selectedYear.value = classRecordData.year;\n          selectedSection.value = classRecordData.section;\n          selectedSubject.value = classRecordData.subject;\n\n          console.log('Selected filters updated to:', {\n            year: selectedYear.value,\n            section: selectedSection.value,\n            subject: selectedSubject.value\n          });\n\n          // Refresh the data\n          console.log('Refreshing class data and attendance...');\n          await fetchClassData();\n          \n          // Check if data was loaded correctly\n          if (students.value.length === 0) {\n            console.log('No students loaded after fetchClassData, trying again...');\n            // Try again with a slight delay\n            setTimeout(async () => {\n              await fetchClassData();\n              console.log('Second attempt to fetch class data complete, students:', students.value.length);\n            }, 500);\n          }\n          \n          try {\n            await fetchAttendance();\n            console.log('Attendance data refreshed successfully');\n          } catch (attendanceError) {\n            console.warn('Error fetching attendance:', attendanceError);\n            // Continue with the process even if attendance fetching fails\n          }\n          console.log('Data refresh complete');\n\n          alert('Student records added successfully!');\n        }\n      } catch (error) {\n        console.error('Failed to add student record:', error);\n        if (error.response) {\n          console.error('Error response:', error.response.data);\n        }\n        \n        // Check if the class record was created successfully\n        let classRecordCreated = false;\n        try {\n          // Try to fetch the class record to see if it was created\n          if (newStudentRecord.value.year && newStudentRecord.value.section && newStudentRecord.value.subject) {\n            const checkResponse = await api.get('/teacher-class-records', {\n              params: {\n                teacherId: store.state.auth.user?._id || user.value?._id,\n                year: newStudentRecord.value.year,\n                section: newStudentRecord.value.section,\n                subject: newStudentRecord.value.subject\n              },\n              headers: {\n                'Authorization': `Bearer ${store.state.auth.token}`\n              }\n            });\n            \n            if (checkResponse.data && checkResponse.data.length > 0) {\n              classRecordCreated = true;\n              console.log('Class record was created successfully despite errors');\n            }\n          }\n        } catch (checkError) {\n          console.error('Error checking if class record was created:', checkError);\n        }\n        \n        if (classRecordCreated) {\n          // If the class record was created, consider it a success\n          showAddStudentRecordModal.value = false;\n          \n          // Store the values before resetting the form\n          const year = newStudentRecord.value.year;\n          const section = newStudentRecord.value.section;\n          const subject = newStudentRecord.value.subject;\n          \n          // Reset the form\n          newStudentRecord.value = {\n            year: '',\n            section: '',\n            subject: ''\n          };\n          \n          // Update the selected filters to show the new record\n          selectedYear.value = year;\n          selectedSection.value = section;\n          selectedSubject.value = subject;\n          \n          // Refresh the data\n          await fetchClassData();\n          try {\n            await fetchAttendance();\n            console.log('Attendance data refreshed successfully after recovery');\n          } catch (attendanceError) {\n            console.warn('Error fetching attendance after recovery:', attendanceError);\n          }\n          \n          alert('Student records added successfully, but there was an issue with attendance records. You may need to set attendance separately.');\n        } else if (error.response?.data?.message === 'A class record already exists for this combination') {\n          alert('A class record already exists for this combination of teacher, year, section, and subject.');\n        } else {\n          alert('Failed to add student record. Please try again.');\n        }\n      }\n    };\n\n    // Watch for changes in year selection\n    watch(selectedYear, async (newYear) => {\n      if (newYear) {\n        selectedSection.value = ''; // Reset section\n        selectedSubject.value = ''; // Reset subject\n        await fetchAvailableSections(); // Fetch sections based on selected year\n        await saveUserPreferences(); // Save the updated preference\n      } else {\n        availableSections.value = [];\n      }\n    });\n\n    // Watch for changes in section selection\n    watch(selectedSection, async (newSection) => {\n      if (newSection) {\n        selectedSubject.value = ''; // Reset subject\n        await updateTeacherSubjects(); // Fetch subjects based on selected year and section\n        await saveUserPreferences(); // Save the updated preference\n      } else {\n        teacherSubjects.value = [];\n      }\n    });\n\n    // Watch for changes in subject selection\n    watch(selectedSubject, async (newSubject) => {\n      if (newSubject) {\n        await fetchClassData(); // Fetch class data based on selected year, section, and subject\n        await saveUserPreferences(); // Save the updated preference\n      } else {\n        students.value = [];\n      }\n    });\n\n    // Add clearFilters function\n    const clearFilters = async () => {\n      // Reset all filter values\n      selectedYear.value = '';\n      selectedSection.value = '';\n      selectedSubject.value = '';\n      currentPage.value = 1;\n      \n      // Clear students array to avoid showing stale data\n      students.value = [];\n      assessments.value = [];\n      \n      // Remove preferences from localStorage\n      localStorage.removeItem('classRecordPreferences');\n      \n      try {\n        // Then clear from backend\n        const token = store.state.auth.token;\n        const userId = store.state.auth.user?._id;\n        \n        if (userId) {\n          const emptyPreferences = {\n            selectedYear: '',\n            selectedSection: '',\n            selectedSubject: '',\n            currentPage: 1\n          };\n          \n          await api.post('/users/preferences', \n            { userId, preferences: emptyPreferences },\n            { headers: { 'Authorization': `Bearer ${token}` } }\n          );\n          \n          console.log('Preferences cleared successfully');\n        }\n      } catch (error) {\n        console.error('Error clearing preferences:', error);\n      }\n    };\n\n    // Add onMounted hook to fetch initial data\n    onMounted(async () => {\n      if (store.getters.isLoggedIn) {\n        try {\n          const token = store.state.auth.token;\n          if (!token) {\n            console.error('No auth token found');\n            router.push('/login');\n            return;\n          }\n\n          console.log('Fetching user profile...');\n          const response = await api.get('/users/profile', {\n            headers: {\n              'Authorization': `Bearer ${token}`\n            }\n          });\n          \n          console.log('User profile response:', response.data);\n          \n          if (response.data && response.data.role === 'teacher') {\n            user.value = response.data;\n            console.log('Teacher data loaded:', user.value);\n            \n            // Fetch available years first\n            await fetchAvailableYears();\n            \n            // If year is selected, fetch sections\n            if (selectedYear.value) {\n              await fetchAvailableSections();\n              \n              // If section is selected, fetch subjects\n              if (selectedSection.value) {\n                await updateTeacherSubjects();\n                \n                // If subject is selected, fetch class data and assessments\n                if (selectedSubject.value) {\n                  await Promise.all([\n                    fetchClassData(),\n                    fetchAssessments()\n                  ]);\n                }\n              }\n            }\n          } else {\n            console.error('User is not a teacher:', response.data);\n            router.push('/login');\n          }\n        } catch (error) {\n          handleApiError(error, 'onMounted');\n        }\n      } else {\n        console.log('User not logged in, redirecting to login');\n        router.push('/login');\n      }\n    })\n\n    // Add these new methods in the setup function\n    const getAssessmentBadgeClass = (type) => {\n      switch (type) {\n        case 'Quiz': return 'badge-quiz'\n        case 'Activity': return 'badge-activity'\n        case 'Performance Task': return 'badge-performance'\n        default: return ''\n      }\n    }\n\n    const getScoreClass = (percentage) => {\n      if (percentage >= 90) return 'score-excellent'\n      if (percentage >= 80) return 'score-good'\n      if (percentage >= 75) return 'score-average'\n      return 'score-poor'\n    }\n\n    // Watch for changes in section or subject\n    watch([selectedSection, selectedSubject], async () => {\n      if (selectedSection.value && selectedSubject.value) {\n        await fetchClassData()\n        await fetchAssessments()\n      }\n    })\n\n    const createChart = (chartRef, data) => {\n      // Destroy existing chart if it exists\n      if (chartRef.value) {\n        const existingChart = Chart.getChart(chartRef.value);\n        if (existingChart) {\n          existingChart.destroy();\n        }\n      }\n\n      const chartColors = {\n        Quiz: '#4e73df',\n        Activity: '#1cc88a',\n        'Performance Task': '#f6c23e'\n      };\n\n      const chartConfig = {\n        type: 'bar',\n        data: {\n          labels: data.labels,\n          datasets: [{\n            data: data.scores,\n            backgroundColor: chartColors[data.type],\n            borderRadius: 6,\n            maxBarThickness: 40,\n            borderSkipped: false\n          }]\n        },\n        options: {\n        responsive: true,\n        maintainAspectRatio: false,\n        plugins: {\n          legend: {\n            display: false\n          },\n          tooltip: {\n            backgroundColor: '#fff',\n            titleColor: '#203464',\n            bodyColor: '#203464',\n            borderColor: '#e9ecef',\n            borderWidth: 1,\n            padding: 12,\n            displayColors: false,\n            callbacks: {\n              label: function(context) {\n                return `Score: ${context.parsed.y}%`;\n              }\n            }\n          }\n        },\n        scales: {\n          x: {\n            grid: {\n              display: false\n            },\n            ticks: {\n              color: '#6c757d',\n              font: {\n                size: 11\n              }\n            }\n          },\n          y: {\n            beginAtZero: true,\n            max: 100,\n            grid: {\n              color: '#f8f9fa',\n              drawBorder: false\n            },\n            ticks: {\n              color: '#6c757d',\n              font: {\n                size: 11,\n                callback: function(value) {\n                  return value + '%';\n                  }\n                }\n              }\n            }\n          }\n        }\n      };\n\n      return new Chart(chartRef.value, chartConfig);\n    };\n\n    const updateCharts = () => {\n      // Destroy existing charts\n      [quizChart, activityChart, performanceChart].forEach(chartRef => {\n        if (chartRef.value) {\n          const existingChart = Chart.getChart(chartRef.value);\n          if (existingChart) {\n            existingChart.destroy();\n          }\n        }\n      });\n\n      if (!selectedStudent.value) return;\n\n      const chartTypes = {\n        Quiz: quizChart,\n        Activity: activityChart,\n        'Performance Task': performanceChart\n      };\n\n      // Create new charts for each assessment type\n      Object.entries(chartTypes).forEach(([type, chartRef]) => {\n        const assessments = selectedStudent.value.assessments\n          .filter(a => a.type === type)\n          .sort((a, b) => new Date(a.date) - new Date(b.date));\n\n        if (assessments.length > 0) {\n          const data = {\n            type,\n            labels: assessments.map(a => formatDate(a.date)),\n            scores: assessments.map(a => (a.score / a.maxScore * 100).toFixed(1))\n          };\n\n          createChart(chartRef, data);\n        }\n      });\n    };\n\n    // Add these to the setup function\n    const showEditAssessmentModal = ref(false)\n    const editingAssessment = ref({\n      type: '',\n      number: '',\n      maxScore: ''\n    })\n\n    const editAssessment = (assessment) => {\n      editingAssessment.value = { ...assessment }\n      showEditAssessmentModal.value = true\n    }\n\n    const handleEditAssessment = async () => {\n      try {\n        const token = store.state.auth.token\n        const response = await api.put(\n          `/assessments/${editingAssessment.value._id}`,\n          {\n            type: editingAssessment.value.type,\n            number: editingAssessment.value.number,\n            maxScore: editingAssessment.value.maxScore\n          },\n          {\n            headers: {\n              'Authorization': `Bearer ${token}`\n            }\n          }\n        )\n\n        if (response.data) {\n          // Update the assessment in the local state\n          const index = assessments.value.findIndex(a => a._id === editingAssessment.value._id)\n          if (index !== -1) {\n            assessments.value[index] = {\n              ...response.data,\n              id: response.data._id\n            }\n          }\n\n          // Close modal and show success message\n          showEditAssessmentModal.value = false\n          alert('Assessment updated successfully!')\n        }\n      } catch (error) {\n        console.error('Failed to update assessment:', error)\n        alert('Failed to update assessment. Please try again.')\n      }\n    }\n\n    const handleDeleteAssessment = async () => {\n      if (!confirm('Are you sure you want to delete this assessment? This action cannot be undone.')) {\n        return\n      }\n\n      try {\n        const token = store.state.auth.token\n        await api.delete(\n          `/assessments/${editingAssessment.value._id}`,\n          {\n            headers: {\n              'Authorization': `Bearer ${token}`\n            }\n          }\n        )\n\n        // Remove the assessment from the local state\n        assessments.value = assessments.value.filter(a => a._id !== editingAssessment.value._id)\n        \n        // Close modal and show success message\n        showEditAssessmentModal.value = false\n        alert('Assessment deleted successfully!')\n      } catch (error) {\n        console.error('Failed to delete assessment:', error)\n        alert('Failed to delete assessment. Please try again.')\n      }\n    }\n\n    // Fetch available years for the teacher\n    const fetchAvailableYears = async () => {\n      try {\n        console.log('Starting fetchAvailableYears...');\n        const token = store.state.auth.token;\n        const teacherId = store.state.auth.user?._id;\n\n        if (!teacherId) {\n          console.error('No teacherId available');\n          return;\n        }\n\n        console.log('Making API request for available years...');\n        const response = await api.get('/teacher-class-records', {\n          params: { teacherId },\n          headers: { 'Authorization': `Bearer ${token}` }\n        });\n\n        console.log('Available years response:', response.data);\n        // Extract unique years from teacher's records\n        const years = [...new Set(response.data.map(record => record.year))]\n        availableYears.value = years.sort()\n\n        // If no year is selected but we have years available, select the first one\n        if (!selectedYear.value && availableYears.value.length > 0) {\n          selectedYear.value = availableYears.value[0]\n        }\n      } catch (error) {\n        handleApiError(error, 'fetchAvailableYears');\n      }\n    }\n\n    // Fetch available sections for the selected year\n    const fetchAvailableSections = async () => {\n      try {\n        if (!selectedYear.value) {\n          console.log('No year selected for fetching sections');\n          availableSections.value = [];\n          return;\n        }\n\n        const teacherId = store.state.auth.user?._id;\n        const response = await api.get('/teacher-class-records/available-sections', {\n          params: { \n            teacherId,\n            year: selectedYear.value\n          },\n          headers: {\n            'Authorization': `Bearer ${store.state.auth.token}`\n          }\n        });\n\n        // Extract unique sections from teacher's records for the selected year\n        const sections = [...new Set(response.data.map(record => record.section))];\n        availableSections.value = sections.sort();\n\n        console.log('Fetched available sections:', availableSections.value);\n      } catch (error) {\n        console.error('Failed to fetch available sections:', error);\n        availableSections.value = [];\n      }\n    };\n\n    // Disable section and subject until year is selected\n    const canSelectSection = computed(() => !!selectedYear.value);\n    const canSelectSubject = computed(() => !!selectedSection.value);\n\n    // Add computed property for filtered assessments\n    const filteredAssessments = computed(() => {\n      if (!selectedStudent.value?.assessments) return [];\n\n      return selectedStudent.value.assessments.filter(assessment => {\n        // Apply type filter\n        if (selectedAssessmentType.value && assessment.type !== selectedAssessmentType.value) {\n          return false;\n        }\n\n        // Apply date filter\n        if (historyDateRange.value.start && historyDateRange.value.end) {\n          const assessmentDate = new Date(assessment.date);\n          const startDate = new Date(historyDateRange.value.start);\n          startDate.setUTCHours(0, 0, 0, 0);\n          startDate.setHours(startDate.getHours() + 8);\n          \n          const endDate = new Date(historyDateRange.value.end);\n          endDate.setUTCHours(23, 59, 59, 999);\n          endDate.setHours(endDate.getHours() + 8); // Adjust for Philippine timezone\n          \n          if (assessmentDate < startDate || assessmentDate > endDate) {\n            return false;\n          }\n        }\n\n        return true;\n      }).sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date, newest first\n    });\n\n    // Add filter handling functions\n    const applyChartDateFilter = () => {\n      if (chartDateRange.value.start && chartDateRange.value.end) {\n        // Create charts with the new date range\n        nextTick(() => {\n          createPerformanceChart();\n        });\n      }\n      showChartDateFilter = false;\n    };\n\n    const clearChartDateFilter = () => {\n      chartDateRange.value = { \n        start: moment().subtract(30, 'days').format('YYYY-MM-DD'),\n        end: moment().format('YYYY-MM-DD')\n      };\n      \n      // Create charts with the reset date range\n      nextTick(() => {\n        createPerformanceChart();\n      });\n      \n      showChartDateFilter = false;\n    };\n\n    const applyHistoryDateFilter = () => {\n        // The filteredAssessments computed property will automatically update\n        // based on the new date range\n      showHistoryDateFilter = false;\n    };\n\n    const clearHistoryDateFilter = () => {\n      historyDateRange.value = { \n        start: moment().subtract(30, 'days').format('YYYY-MM-DD'),\n        end: moment().format('YYYY-MM-DD')\n      };\n      showHistoryDateFilter = false;\n    };\n\n    // Watch for assessment type changes\n    watch(selectedAssessmentType, () => {\n      // The computed filteredAssessments will automatically update\n    });\n\n    const handleLogout = async () => {\n      try {\n        await store.dispatch('logout')\n        router.push('/login')\n      } catch (error) {\n        console.error('Logout failed:', error)\n      }\n    }\n\n    // Add date navigation function\n    const navigateDate = (direction) => {\n      const now = moment().tz('Asia/Manila').startOf('day')\n      const newDate = moment(currentDate.value).tz('Asia/Manila').startOf('day').add(direction, 'days')\n      \n      // Only allow navigation to past dates or current date\n      if (direction < 0 || (direction > 0 && !newDate.isAfter(now, 'day'))) {\n        slideDirection.value = direction > 0 ? 'slide-left' : 'slide-right'\n        currentDate.value = newDate.toDate()\n        \n        // Refresh data for the new date\n        fetchClassData()\n        fetchAttendance()\n        \n        setTimeout(() => {\n          slideDirection.value = ''\n        }, 300)\n      }\n    }\n\n    // Format date for display\n    const formatDateForDisplay = (dateString) => {\n      if (!dateString) return '';\n      const date = new Date(dateString);\n      // Adjust for Philippine timezone\n      date.setHours(date.getHours() + 8);\n      return date.toLocaleDateString('en-US', {\n        year: 'numeric',\n        month: 'short',\n        day: 'numeric',\n        timeZone: 'Asia/Manila'\n      });\n    };\n\n    const openChartDateFilter = () => {\n      showChartDateFilter.value = true\n      // Close other modals if open\n      showHistoryDateFilter.value = false\n    }\n\n    const openHistoryDateFilter = () => {\n      showHistoryDateFilter.value = true\n      // Close other modals if open\n      showChartDateFilter.value = false\n    }\n\n    const slideDirection = ref('')\n\n    // Add computed property for next day button\n    const isNextDayDisabled = computed(() => {\n      const now = moment().tz('Asia/Manila').startOf('day')\n      const selected = moment(currentDate.value).tz('Asia/Manila').startOf('day')\n      return selected.isSameOrAfter(now, 'day')\n    })\n\n    // Add this near the top of the setup function\n    const handleApiError = (error, context) => {\n      console.error(`Error in ${context}:`, error);\n      console.error('Error details:', {\n        message: error.message,\n        response: error.response?.data,\n        status: error.response?.status\n      });\n      \n      if (error.response?.status === 401) {\n        store.dispatch('logout');\n        router.push('/login');\n      }\n    };\n\n    // Add new method to fetch available years and sections\n    const fetchAvailableYearsAndSections = async () => {\n      try {\n        const token = store.state.auth.token;\n        \n        console.log('Fetching available years and sections...');\n        \n        // Use the available-years-sections endpoint\n        const response = await api.get('/students/available-years-sections', {\n          headers: { 'Authorization': `Bearer ${token}` }\n        });\n\n        console.log('API Response:', response.data);\n\n        if (response.data) {\n          // Set available years and sections from the response\n          availableYears.value = response.data.years || [];\n          availableSections.value = response.data.sections || [];\n          \n          // Use sectionsByYear from the API response\n          if (response.data.sectionsByYear) {\n            sectionsByYear.value = response.data.sectionsByYear;\n          } else {\n            sectionsByYear.value = {};\n          }\n          \n          // If no years are available, add default values\n          if (availableYears.value.length === 0) {\n            availableYears.value = ['1st', '2nd', '3rd', '4th'];\n            console.log('No years found, using default values:', availableYears.value);\n          }\n          \n          // If no sections are available, add default values\n          if (availableSections.value.length === 0) {\n            availableSections.value = ['South 1', 'South 2', 'South 3'];\n            console.log('No sections found, using default values:', availableSections.value);\n          }\n          \n          // If sectionsByYear is empty, create a default mapping\n          if (Object.keys(sectionsByYear.value).length === 0) {\n            const defaultYears = ['1st', '2nd', '3rd', '4th'];\n            const defaultSections = ['South 1', 'South 2', 'South 3'];\n            \n            defaultYears.forEach(year => {\n              sectionsByYear.value[year] = defaultSections;\n            });\n            \n            console.log('No sections by year found, using default mapping:', sectionsByYear.value);\n          }\n          \n          console.log('Available years:', availableYears.value);\n          console.log('Available sections:', availableSections.value);\n          console.log('Sections by year:', sectionsByYear.value);\n        }\n      } catch (error) {\n        console.error('Failed to fetch available years and sections:', error);\n        \n        // Set default values in case of error\n        availableYears.value = ['1st', '2nd', '3rd', '4th'];\n        availableSections.value = ['South 1', 'South 2', 'South 3'];\n        \n        // Create default sectionsByYear mapping\n        sectionsByYear.value = {\n          '1st': ['South 1', 'South 2', 'South 3'],\n          '2nd': ['South 1', 'South 2', 'South 3'],\n          '3rd': ['South 1', 'South 2', 'South 3'],\n          '4th': ['South 1', 'South 2', 'South 3']\n        };\n        \n        console.log('Using default values due to error');\n      }\n    };\n\n    // Add method to fetch teacher subjects\n    const fetchTeacherSubjects = async () => {\n      try {\n        const token = store.state.auth.token;\n        const teacherId = store.state.auth.user?._id;\n        \n        console.log('Fetching teacher subjects...');\n\n        if (!teacherId) {\n          console.error('Teacher ID not available');\n          teacherSubjects.value = [];\n          return;\n        }\n\n        const response = await api.get('/users/profile', {\n          headers: { 'Authorization': `Bearer ${token}` }\n        });\n\n        console.log('Teacher profile response:', response.data);\n\n        if (response.data && response.data.subjects && response.data.subjects.length > 0) {\n          teacherSubjects.value = response.data.subjects.sort();\n          console.log('Fetched teacher subjects:', teacherSubjects.value);\n        } else {\n          console.log('No subjects found in teacher profile');\n          teacherSubjects.value = [];\n        }\n      } catch (error) {\n        console.error('Failed to fetch teacher subjects:', error);\n        teacherSubjects.value = [];\n      }\n    };\n\n    // Helper function to set default subjects based on teaching year\n    const setDefaultSubjects = () => {\n      const year = user.value?.teachingYear || '1st';\n      console.log('Setting default subjects for teaching year:', year);\n      \n      switch (year) {\n        case '1st':\n          teacherSubjects.value = ['ITE 100', 'ITE 101', 'ITE 102', 'ITE 103'];\n          break;\n        case '2nd':\n          teacherSubjects.value = ['ITE 200', 'ITE 201', 'ITE 202', 'ITE 203'];\n          break;\n        case '3rd':\n          teacherSubjects.value = ['ITE 301', 'ITE 302', 'ITE 303', 'ITE 304'];\n          break;\n        case '4th':\n          teacherSubjects.value = ['ITE 400', 'ITE 401', 'ITE 402', 'ITE 403', 'ITE 404'];\n          break;\n        default:\n          teacherSubjects.value = [\n            'ITE 100', 'ITE 101', 'ITE 102', 'ITE 103',\n            'ITE 200', 'ITE 201', 'ITE 202', 'ITE 203',\n            'ITE 301', 'ITE 302', 'ITE 303', 'ITE 304',\n            'ITE 400', 'ITE 401', 'ITE 402', 'ITE 403', 'ITE 404'\n          ];\n      }\n      \n      console.log('Default subjects set:', teacherSubjects.value);\n    };\n\n    // Modify the existing showAddStudentRecordModal watcher or toggle function\n    const openAddStudentRecordModal = async () => {\n      // Reset form fields\n      newStudentRecord.value = {\n        year: '',\n        section: '',\n        subject: ''\n      };\n      \n      console.log('Opening Add Student Record modal');\n      \n      try {\n        // Fetch available options\n        await fetchAvailableYearsAndSections();\n        await fetchTeacherSubjects();\n        \n        console.log('Form reset and data fetched, opening modal');\n        \n        // Log available options for debugging\n        console.log('- Years:', availableYears.value);\n        console.log('- Sections by year:', sectionsByYear.value);\n        console.log('- Subjects:', teacherSubjects.value);\n        \n        // Always open the modal, even if no options are available\n        showAddStudentRecordModal.value = true;\n      } catch (error) {\n        console.error('Error preparing Add Student Record modal:', error);\n        alert('Failed to prepare the Add Student Record form. Please try again.');\n      }\n    };\n\n    // Add computed property for filtered sections based on selected year\n    const filteredSections = computed(() => {\n      if (!newStudentRecord.value.year) return [];\n      \n      console.log('Filtering sections for year:', newStudentRecord.value.year);\n      console.log('Available sections by year:', sectionsByYear.value);\n      \n      const sections = sectionsByYear.value[newStudentRecord.value.year] || [];\n      console.log('Filtered sections:', sections);\n      \n      return sections;\n    });\n\n    // Watch for year changes to reset section\n    watch(() => newStudentRecord.value.year, (newYear) => {\n      newStudentRecord.value.section = '';\n    });\n\n    // Add auto date update interval\n    let dateUpdateInterval = null\n\n    // Add function to check and update date at midnight\n    const setupDateAutoUpdate = () => {\n      const checkAndUpdateDate = () => {\n        const now = moment().tz('Asia/Manila')\n        const current = moment(currentDate.value).tz('Asia/Manila')\n        \n        // If it's past midnight and we're showing yesterday's date\n        if (now.isAfter(current, 'day')) {\n          currentDate.value = now.toDate()\n          fetchClassData()\n          fetchAttendance()\n        }\n      }\n\n      // Clear existing interval if any\n      if (dateUpdateInterval) {\n        clearInterval(dateUpdateInterval)\n      }\n\n      // Check every minute\n      dateUpdateInterval = setInterval(checkAndUpdateDate, 60000)\n    }\n\n    // Add attendance-related state and functions\n    const attendanceRecords = ref([])\n    const attendanceStatistics = ref(null)\n\n    const fetchAttendance = async () => {\n      try {\n        if (!selectedSection.value || !selectedSubject.value) {\n          console.log('fetchAttendance: Missing required filters', {\n            section: selectedSection.value,\n            subject: selectedSubject.value\n          });\n          return;\n        }\n\n        console.log('fetchAttendance: Fetching attendance data with filters', {\n          section: selectedSection.value,\n          subject: selectedSubject.value,\n          date: moment(currentDate.value).tz('Asia/Manila').format('YYYY-MM-DD')\n        });\n        const date = moment(currentDate.value).tz('Asia/Manila').format('YYYY-MM-DD')\n        const response = await api.get(`/attendance/date/${date}`, {\n          params: {\n            subject: selectedSubject.value,\n            section: selectedSection.value\n          },\n          headers: { 'Authorization': `Bearer ${store.state.auth.token}` }\n        })\n\n        attendanceRecords.value = response.data\n      } catch (error) {\n        console.error('Error fetching attendance:', error)\n      }\n    }\n\n    // Add attendance chart creation\n    const createAttendanceChart = () => {\n      // This function is no longer needed as attendance is handled in the Attendance.vue page\n      console.log('Attendance functionality moved to Attendance.vue page');\n    }\n\n    // Add cleanup on component unmount\n    onUnmounted(() => {\n      if (dateUpdateInterval) {\n        clearInterval(dateUpdateInterval)\n      }\n    })\n\n    // Update onMounted to include new initialization\n    onMounted(async () => {\n      if (store.getters.isLoggedIn) {\n        try {\n          await fetchUserProfile()\n          await fetchTeacherSubjects()\n          setupDateAutoUpdate()\n        } catch (error) {\n          handleApiError(error, 'component mount')\n        }\n      } else {\n        router.push('/login')\n      }\n    })\n\n    const syncStudentRecords = async () => {\n      try {\n        if (!selectedYear.value || !selectedSection.value) {\n          alert('Please select a year and section first');\n          return;\n        }\n\n        const response = await api.post(\n          '/teacher-class-records/sync-records',\n          {\n            year: selectedYear.value,\n            section: selectedSection.value\n          },\n          {\n            headers: {\n              'Authorization': `Bearer ${store.state.auth.token}`,\n              'Content-Type': 'application/json'\n            }\n          }\n        );\n\n        if (response.data.success) {\n          // Refresh the data after sync\n          await fetchClassData();\n          await fetchAttendance();\n          alert('Student records synchronized successfully!');\n        }\n      } catch (error) {\n        console.error('Failed to sync student records:', error);\n        alert('Failed to sync student records. Please try again.');\n      }\n    };\n\n    // Add redirection method\n    const redirectToAttendance = () => {\n      if (!selectedYear.value || !selectedSection.value || !selectedSubject.value) {\n        alert('Please select a year, section, and subject first');\n        return;\n      }\n      router.push({\n        name: 'Attendance',\n        query: {\n          year: selectedYear.value,\n          section: selectedSection.value,\n          subject: selectedSubject.value\n        }\n      });\n    };\n\n    // Add pagination state\n    const currentPage = ref(1)\n    const itemsPerPage = 25\n\n    // Compute total pages\n    const totalPages = computed(() => Math.ceil(sortedStudents.value.length / itemsPerPage))\n\n    // Get paginated students\n    const paginatedStudents = computed(() => {\n      const start = (currentPage.value - 1) * itemsPerPage\n      const end = start + itemsPerPage\n      return sortedStudents.value.slice(start, end)\n    })\n\n    // Compute pagination info\n    const paginationInfo = computed(() => {\n      const start = sortedStudents.value.length === 0 ? 0 : (currentPage.value - 1) * itemsPerPage + 1\n      const end = Math.min(start + itemsPerPage - 1, sortedStudents.value.length)\n      return { start, end }\n    })\n\n    // Pagination methods\n    const nextPage = () => {\n      if (currentPage.value < totalPages.value) {\n        currentPage.value++\n        saveUserPreferences(); // Save the updated page\n      }\n    }\n\n    const previousPage = () => {\n      if (currentPage.value > 1) {\n        currentPage.value--\n        saveUserPreferences(); // Save the updated page\n      }\n    }\n\n    // Reset pagination when filters change\n    watch([searchQuery, selectedYear, selectedSection, selectedSubject], () => {\n      currentPage.value = 1\n      // No need to save here as the filter change will trigger the filter watcher\n    })\n\n    // Add chart instances\n    let quizChartInstance = null;\n    let activityChartInstance = null;\n    let performanceChartInstance = null;\n\n    // Helper function to destroy chart\n    const destroyChart = (chartInstance, canvasRef) => {\n      try {\n        // Destroy the chart instance if it exists\n        if (chartInstance) {\n          chartInstance.destroy();\n        }\n        \n        // Clear any existing chart from the canvas\n        if (canvasRef && canvasRef.value) {\n          const existingChart = Chart.getChart(canvasRef.value);\n          if (existingChart) {\n            existingChart.destroy();\n          }\n          \n          // Clear any \"no data\" messages\n          const container = canvasRef.value.parentElement;\n          if (container) {\n            // Preserve the canvas but remove other elements\n            const canvas = canvasRef.value;\n            container.innerHTML = '';\n            if (canvas) {\n              container.appendChild(canvas);\n            }\n          }\n        }\n      } catch (error) {\n        console.error('Error destroying chart:', error);\n      }\n    };\n\n    // Handle date filter change from the modal\n    const handleDateFilterChange = (dateFilter) => {\n      console.log('Date filter changed:', dateFilter);\n      \n      // Update chart date range\n      if (dateFilter.start) {\n        chartDateRange.value.start = dateFilter.start;\n        historyDateRange.value.start = dateFilter.start;\n      }\n      \n      if (dateFilter.end) {\n        chartDateRange.value.end = dateFilter.end;\n        historyDateRange.value.end = dateFilter.end;\n      }\n      \n      // Recreate charts with the new date range\n      nextTick(() => {\n        createPerformanceChart();\n        // The assessment history table will be updated by createPerformanceChart\n      });\n    };\n\n    // Handle assessment type change from the modal\n    const handleAssessmentTypeChange = (type) => {\n      console.log('Assessment type changed:', type);\n      \n      // Update the selected assessment type\n      selectedAssessmentType.value = type;\n      \n      // Recreate charts with the new assessment type\n      nextTick(() => {\n        createPerformanceChart();\n      });\n    };\n\n    // Create performance chart function\n    const createPerformanceChart = () => {\n      if (!selectedStudent.value) {\n        console.error('No student selected, cannot create performance chart');\n        return;\n      }\n\n      console.log('Creating performance charts for student:', selectedStudent.value.studentNumber);\n      console.log('Selected assessment type:', selectedAssessmentType.value);\n      console.log('Date range:', chartDateRange.value);\n\n      // Group assessments by type\n      const assessmentsByType = {\n        'Quiz': [],\n        'Activity': [],\n        'Performance Task': []\n      };\n\n      // Process assessments if they exist\n      if (selectedStudent.value.assessments && selectedStudent.value.assessments.length > 0) {\n        console.log(`Processing ${selectedStudent.value.assessments.length} assessments for charts`);\n        \n        selectedStudent.value.assessments.forEach(assessment => {\n          if (assessment && assessment.type in assessmentsByType) {\n            // Get the score for this student\n            const studentNumber = selectedStudent.value.studentNumber;\n            let scoreValue = null;\n            \n            // Check if scores is a Map or an object\n            if (assessment.scores) {\n              if (assessment.scores instanceof Map) {\n                scoreValue = assessment.scores.get(studentNumber);\n              } else if (typeof assessment.scores === 'object') {\n                scoreValue = assessment.scores[studentNumber];\n              }\n            }\n            \n            // If score is not found in assessment.scores, check student.scores\n            if ((scoreValue === null || scoreValue === undefined) && \n                selectedStudent.value.scores && \n                (assessment._id in selectedStudent.value.scores || assessment.id in selectedStudent.value.scores)) {\n              scoreValue = selectedStudent.value.scores[assessment._id] || selectedStudent.value.scores[assessment.id];\n            }\n            \n            // Only include assessments with scores\n            if (scoreValue !== null && scoreValue !== undefined) {\n              const maxScore = assessment.maxScore || 100;\n              const scorePercentage = (scoreValue / maxScore) * 100;\n              \n              // Apply date filter if set\n              const assessmentDate = new Date(assessment.date);\n              const startDate = chartDateRange.value.start ? new Date(chartDateRange.value.start) : null;\n              const endDate = chartDateRange.value.end ? new Date(chartDateRange.value.end) : null;\n              \n              // Skip if outside date range\n              if ((startDate && assessmentDate < startDate) || \n                  (endDate && assessmentDate > endDate)) {\n                console.log(`Skipping assessment ${assessment.type} #${assessment.number} due to date filter`);\n                return;\n              }\n              \n              console.log(`Including assessment ${assessment.type} #${assessment.number}: Score=${scoreValue}/${maxScore} (${scorePercentage.toFixed(1)}%)`);\n              \n              assessmentsByType[assessment.type].push({\n                date: assessment.date,\n                score: scorePercentage,\n                rawScore: scoreValue,\n                maxScore: maxScore,\n                number: assessment.number,\n                title: `${assessment.type} #${assessment.number}`\n              });\n            }\n          }\n        });\n      }\n\n      // Log the grouped assessments for debugging\n      Object.keys(assessmentsByType).forEach(type => {\n        console.log(`${type} assessments: ${assessmentsByType[type].length}`);\n      });\n\n      // Create charts for each type using the new chart IDs\n      const chartIdBase = `performanceChart-${selectedStudent.value.studentNumber}`;\n      \n      // First, clean up any existing charts\n      const chartIds = [\n        `all-${chartIdBase}`,\n        `quiz-${chartIdBase}`,\n        `activity-${chartIdBase}`,\n        `performance-${chartIdBase}`\n      ];\n      \n      chartIds.forEach(id => {\n        const chartElement = document.getElementById(id);\n        if (chartElement) {\n          const existingChart = Chart.getChart(chartElement);\n          if (existingChart) {\n            console.log(`Destroying existing chart: ${id}`);\n            existingChart.destroy();\n          }\n        }\n      });\n      \n      // Update the assessment history table with the filtered data\n      updateAssessmentHistoryTable(assessmentsByType);\n      \n      // Create \"All\" chart that combines all assessment types\n      if (selectedAssessmentType.value === 'All') {\n        const allChartElement = document.getElementById(`all-${chartIdBase}`);\n        if (allChartElement) {\n          const ctx = allChartElement.getContext('2d');\n          if (ctx) {\n            // Combine all assessment types into one dataset\n            const allAssessments = [\n              ...assessmentsByType['Quiz'].map(item => ({ ...item, type: 'Quiz' })),\n              ...assessmentsByType['Activity'].map(item => ({ ...item, type: 'Activity' })),\n              ...assessmentsByType['Performance Task'].map(item => ({ ...item, type: 'Performance Task' }))\n            ].sort((a, b) => new Date(a.date) - new Date(b.date));\n            \n            if (allAssessments.length === 0) {\n              // Display no data message\n              const container = allChartElement.parentElement;\n              if (container) {\n                container.innerHTML = '';\n                const noDataMessage = document.createElement('div');\n                noDataMessage.className = 'text-center py-5 text-muted';\n                noDataMessage.innerHTML = '<i class=\"fas fa-info-circle me-2\"></i>No assessment data available for this student in the selected date range.';\n                container.appendChild(noDataMessage);\n              }\n            } else {\n              // Create datasets for each type\n              const datasets = [\n                {\n                  label: 'Quiz',\n                  data: allAssessments.filter(item => item.type === 'Quiz').map(item => ({ x: new Date(item.date), y: item.score })),\n                  borderColor: '#4285F4',\n                  backgroundColor: 'rgba(66, 133, 244, 0.1)',\n                  borderWidth: 2,\n                  tension: 0.4,\n                  pointBackgroundColor: '#4285F4',\n                  pointBorderColor: '#fff',\n                  pointRadius: 5\n                },\n                {\n                  label: 'Activity',\n                  data: allAssessments.filter(item => item.type === 'Activity').map(item => ({ x: new Date(item.date), y: item.score })),\n                  borderColor: '#34A853',\n                  backgroundColor: 'rgba(52, 168, 83, 0.1)',\n                  borderWidth: 2,\n                  tension: 0.4,\n                  pointBackgroundColor: '#34A853',\n                  pointBorderColor: '#fff',\n                  pointRadius: 5\n                },\n                {\n                  label: 'Performance Task',\n                  data: allAssessments.filter(item => item.type === 'Performance Task').map(item => ({ x: new Date(item.date), y: item.score })),\n                  borderColor: '#FBBC05',\n                  backgroundColor: 'rgba(251, 188, 5, 0.1)',\n                  borderWidth: 2,\n                  tension: 0.4,\n                  pointBackgroundColor: '#FBBC05',\n                  pointBorderColor: '#fff',\n                  pointRadius: 5\n                }\n              ].filter(dataset => dataset.data.length > 0); // Only include datasets with data\n              \n              // Create the combined chart\n              new Chart(ctx, {\n                type: 'line',\n                data: { datasets },\n                options: {\n                  responsive: true,\n                  maintainAspectRatio: false,\n                  scales: {\n                    x: {\n                      type: 'time',\n                      time: {\n                        unit: 'day',\n                        displayFormats: {\n                          day: 'MMM D, YYYY'\n                        },\n                        tooltipFormat: 'MMM D, YYYY'\n                      },\n                      adapters: {\n                        date: {\n                          locale: 'en'\n                        }\n                      },\n                      title: {\n                        display: true,\n                        text: 'Date'\n                      },\n                      grid: {\n                        display: false\n                      },\n                      ticks: {\n                        font: {\n                          size: 12,\n                          weight: 'bold'\n                        },\n                        padding: 10\n                      }\n                    },\n                    y: {\n                      beginAtZero: true,\n                      max: 100,\n                      title: {\n                        display: true,\n                        text: 'Score (%)'\n                      },\n                      ticks: {\n                        callback: value => value + '%'\n                      }\n                    }\n                  },\n                  plugins: {\n                    tooltip: {\n                      callbacks: {\n                        title: (context) => {\n                          return moment(context[0].parsed.x).format('MMMM D, YYYY');\n                        },\n                        label: (context) => {\n                          const datasetLabel = context.dataset.label;\n                          const value = context.parsed.y;\n                          return `${datasetLabel}: ${value.toFixed(1)}%`;\n                        }\n                      }\n                    },\n                    legend: {\n                      position: 'top'\n                    }\n                  }\n                }\n              });\n            }\n          }\n        }\n      }\n      \n      // Create Quiz chart\n      if (selectedAssessmentType.value === 'Quiz') {\n        const quizChartElement = document.getElementById(`quiz-${chartIdBase}`);\n        if (quizChartElement) {\n          const ctx = quizChartElement.getContext('2d');\n          if (ctx) {\n            const data = assessmentsByType['Quiz'].sort((a, b) => new Date(a.date) - new Date(b.date));\n            \n            if (data.length === 0) {\n              // Display no data message\n              const container = quizChartElement.parentElement;\n              if (container) {\n                container.innerHTML = '';\n                const noDataMessage = document.createElement('div');\n                noDataMessage.className = 'text-center py-5 text-muted';\n                noDataMessage.innerHTML = '<i class=\"fas fa-info-circle me-2\"></i>No quiz data available for this student in the selected date range.';\n                container.appendChild(noDataMessage);\n              }\n            } else {\n              // Create time series data\n              const timeSeriesData = data.map(item => ({\n                x: new Date(item.date),\n                y: item.score,\n                rawScore: item.rawScore,\n                maxScore: item.maxScore,\n                number: item.number\n              }));\n              \n              // Create chart\n              new Chart(ctx, {\n                type: 'line',\n                data: {\n                  datasets: [{\n                    label: 'Quiz Scores',\n                    data: timeSeriesData,\n                    borderColor: '#4285F4',\n                    backgroundColor: 'rgba(66, 133, 244, 0.1)',\n                    borderWidth: 2,\n                    tension: 0.4,\n                    fill: true,\n                    pointBackgroundColor: '#4285F4',\n                    pointBorderColor: '#fff',\n                    pointRadius: 5\n                  }]\n                },\n                options: {\n                  responsive: true,\n                  maintainAspectRatio: false,\n                  scales: {\n                    x: {\n                      type: 'time',\n                      time: {\n                        unit: 'day',\n                        displayFormats: {\n                          day: 'MMM D, YYYY'\n                        },\n                        tooltipFormat: 'MMM D, YYYY'\n                      },\n                      adapters: {\n                        date: {\n                          locale: 'en'\n                        }\n                      },\n                      title: {\n                        display: true,\n                        text: 'Date'\n                      },\n                      grid: {\n                        display: false\n                      }\n                    },\n                    y: {\n                      beginAtZero: true,\n                      max: 100,\n                      title: {\n                        display: true,\n                        text: 'Score (%)'\n                      },\n                      ticks: {\n                        callback: value => value + '%'\n                      }\n                    }\n                  },\n                  plugins: {\n                    tooltip: {\n                      callbacks: {\n                        title: (context) => {\n                          return moment(context[0].parsed.x).format('MMMM D, YYYY');\n                        },\n                        label: (context) => {\n                          const item = context.raw;\n                          return [\n                            `Quiz #${item.number}`,\n                            `Score: ${item.rawScore}/${item.maxScore} (${item.y.toFixed(1)}%)`\n                          ];\n                        }\n                      }\n                    }\n                  }\n                }\n              });\n            }\n          }\n        }\n      }\n\n      // Create Activity chart\n      if (selectedAssessmentType.value === 'Activity') {\n        const activityChartElement = document.getElementById(`activity-${chartIdBase}`);\n        if (activityChartElement) {\n          const ctx = activityChartElement.getContext('2d');\n          if (ctx) {\n            const data = assessmentsByType['Activity'].sort((a, b) => new Date(a.date) - new Date(b.date));\n            \n            if (data.length === 0) {\n              // Display no data message\n              const container = activityChartElement.parentElement;\n              if (container) {\n                container.innerHTML = '';\n                const noDataMessage = document.createElement('div');\n                noDataMessage.className = 'text-center py-5 text-muted';\n                noDataMessage.innerHTML = '<i class=\"fas fa-info-circle me-2\"></i>No activity data available for this student in the selected date range.';\n                container.appendChild(noDataMessage);\n              }\n            } else {\n              // Create time series data\n              const timeSeriesData = data.map(item => ({\n                x: new Date(item.date),\n                y: item.score,\n                rawScore: item.rawScore,\n                maxScore: item.maxScore,\n                number: item.number\n              }));\n              \n              // Create chart\n              new Chart(ctx, {\n                type: 'line',\n                data: {\n                  datasets: [{\n                    label: 'Activity Scores',\n                    data: timeSeriesData,\n                    borderColor: '#34A853',\n                    backgroundColor: 'rgba(52, 168, 83, 0.1)',\n                    borderWidth: 2,\n                    tension: 0.4,\n                    fill: true,\n                    pointBackgroundColor: '#34A853',\n                    pointBorderColor: '#fff',\n                    pointRadius: 5\n                  }]\n                },\n                options: {\n                  responsive: true,\n                  maintainAspectRatio: false,\n                  scales: {\n                    x: {\n                      type: 'time',\n                      time: {\n                        unit: 'day',\n                        displayFormats: {\n                          day: 'MMM D, YYYY'\n                        },\n                        tooltipFormat: 'MMM D, YYYY'\n                      },\n                      adapters: {\n                        date: {\n                          locale: 'en'\n                        }\n                      },\n                      title: {\n                        display: true,\n                        text: 'Date'\n                      },\n                      grid: {\n                        display: false\n                      }\n                    },\n                    y: {\n                      beginAtZero: true,\n                      max: 100,\n                      title: {\n                        display: true,\n                        text: 'Score (%)'\n                      },\n                      ticks: {\n                        callback: value => value + '%'\n                      }\n                    }\n                  },\n                  plugins: {\n                    tooltip: {\n                      callbacks: {\n                        title: (context) => {\n                          return moment(context[0].parsed.x).format('MMMM D, YYYY');\n                        },\n                        label: (context) => {\n                          const item = context.raw;\n                          return [\n                            `Activity #${item.number}`,\n                            `Score: ${item.rawScore}/${item.maxScore} (${item.y.toFixed(1)}%)`\n                          ];\n                        }\n                      }\n                    }\n                  }\n                }\n              });\n            }\n          }\n        }\n      }\n\n      // Create Performance Task chart\n      if (selectedAssessmentType.value === 'Performance Task') {\n        const performanceChartElement = document.getElementById(`performance-${chartIdBase}`);\n        if (performanceChartElement) {\n          const ctx = performanceChartElement.getContext('2d');\n          if (ctx) {\n            const data = assessmentsByType['Performance Task'].sort((a, b) => new Date(a.date) - new Date(b.date));\n            \n            if (data.length === 0) {\n              // Display no data message\n              const container = performanceChartElement.parentElement;\n              if (container) {\n                container.innerHTML = '';\n                const noDataMessage = document.createElement('div');\n                noDataMessage.className = 'text-center py-5 text-muted';\n                noDataMessage.innerHTML = '<i class=\"fas fa-info-circle me-2\"></i>No performance task data available for this student in the selected date range.';\n                container.appendChild(noDataMessage);\n              }\n            } else {\n              // Create time series data\n              const timeSeriesData = data.map(item => ({\n                x: new Date(item.date),\n                y: item.score,\n                rawScore: item.rawScore,\n                maxScore: item.maxScore,\n                number: item.number\n              }));\n              \n              // Create chart\n              new Chart(ctx, {\n                type: 'line',\n                data: {\n                  datasets: [{\n                    label: 'Performance Task Scores',\n                    data: timeSeriesData,\n                    borderColor: '#FBBC05',\n                    backgroundColor: 'rgba(251, 188, 5, 0.1)',\n                    borderWidth: 2,\n                    tension: 0.4,\n                    fill: true,\n                    pointBackgroundColor: '#FBBC05',\n                    pointBorderColor: '#fff',\n                    pointRadius: 5\n                  }]\n                },\n                options: {\n                  responsive: true,\n                  maintainAspectRatio: false,\n                  scales: {\n                    x: {\n                      type: 'time',\n                      time: {\n                        unit: 'day',\n                        displayFormats: {\n                          day: 'MMM D, YYYY'\n                        },\n                        tooltipFormat: 'MMM D, YYYY'\n                      },\n                      adapters: {\n                        date: {\n                          locale: 'en'\n                        }\n                      },\n                      title: {\n                        display: true,\n                        text: 'Date'\n                      },\n                      grid: {\n                        display: false\n                      }\n                    },\n                    y: {\n                      beginAtZero: true,\n                      max: 100,\n                      title: {\n                        display: true,\n                        text: 'Score (%)'\n                      },\n                      ticks: {\n                        callback: value => value + '%'\n                      }\n                    }\n                  },\n                  plugins: {\n                    tooltip: {\n                      callbacks: {\n                        title: (context) => {\n                          return moment(context[0].parsed.x).format('MMMM D, YYYY');\n                        },\n                        label: (context) => {\n                          const item = context.raw;\n                          return [\n                            `Performance Task #${item.number}`,\n                            `Score: ${item.rawScore}/${item.maxScore} (${item.y.toFixed(1)}%)`\n                          ];\n                        }\n                      }\n                    }\n                  }\n                }\n              });\n            }\n          }\n        }\n      }\n    };\n\n    // Helper function to create individual charts\n    const createChartInstance = (ctx, type, data) => {\n      if (!ctx) return null;\n\n      // Generate a unique ID for the chart\n      const chartId = `${type.toLowerCase()}-${Date.now()}`;\n      ctx.canvas.id = chartId;\n\n      if (data.length === 0) {\n        try {\n          // Find the parent container safely\n          const canvas = ctx.canvas;\n          if (!canvas) return null;\n          \n          const container = canvas.parentElement;\n          if (!container) return null;\n          \n          // Create a wrapper div for the message\n          const messageWrapper = document.createElement('div');\n          messageWrapper.className = 'text-center py-4 text-muted';\n          messageWrapper.innerHTML = `<i class=\"fas fa-info-circle me-2\"></i>No ${type.toLowerCase()} data available`;\n          \n          // Clear the container and append the message\n          container.innerHTML = '';\n          container.appendChild(messageWrapper);\n          \n          return null;\n        } catch (error) {\n          console.error('Error displaying no data message:', error);\n          return null;\n        }\n      }\n\n      // Define chart colors based on type\n      const getChartColors = (type) => {\n        switch(type) {\n          case 'Quiz':\n            return {\n              gradient: ['rgba(66, 133, 244, 0.8)', 'rgba(66, 133, 244, 0.1)'],\n              border: '#4285F4',\n              point: '#4285F4',\n              pointHover: '#3367D6'\n            };\n          case 'Activity':\n            return {\n              gradient: ['rgba(52, 168, 83, 0.8)', 'rgba(52, 168, 83, 0.1)'],\n              border: '#34A853',\n              point: '#34A853',\n              pointHover: '#2E7D32'\n            };\n          case 'Performance Task':\n            return {\n              gradient: ['rgba(251, 188, 5, 0.8)', 'rgba(251, 188, 5, 0.1)'],\n              border: '#FBBC05',\n              point: '#FBBC05',\n              pointHover: '#F57F17'\n            };\n          default:\n            return {\n              gradient: ['rgba(66, 133, 244, 0.8)', 'rgba(66, 133, 244, 0.1)'],\n              border: '#4285F4',\n              point: '#4285F4',\n              pointHover: '#3367D6'\n            };\n        }\n      };\n\n      const colors = getChartColors(type);\n      \n      // Create gradient for background\n      const gradient = ctx.createLinearGradient(0, 0, 0, 400);\n      gradient.addColorStop(0, colors.gradient[0]);\n      gradient.addColorStop(1, colors.gradient[1]);\n\n      // Convert data to time series format\n      const timeSeriesData = data.map(item => ({\n        x: new Date(item.date),\n        y: item.score\n      }));\n\n      return new Chart(ctx, {\n        type: 'line',\n        data: {\n          datasets: [{\n            label: `${type} Scores`,\n            data: timeSeriesData,\n            borderColor: colors.border,\n            backgroundColor: gradient,\n            borderWidth: 3,\n            tension: 0.4,\n            fill: true,\n            pointBackgroundColor: colors.point,\n            pointBorderColor: '#fff',\n            pointBorderWidth: 2,\n            pointRadius: 5,\n            pointHoverRadius: 7,\n            pointHoverBackgroundColor: colors.pointHover,\n            pointHoverBorderColor: '#fff',\n            pointHoverBorderWidth: 2\n          }]\n        },\n        options: {\n          responsive: true,\n          maintainAspectRatio: false,\n          animations: {\n            tension: {\n              duration: 1000,\n              easing: 'linear',\n              from: 0.4,\n              to: 0.4,\n              loop: false\n            }\n          },\n          scales: {\n            x: {\n              type: 'time',\n              time: {\n                unit: 'day',\n                displayFormats: {\n                  day: 'MMM D, YYYY'\n                },\n                tooltipFormat: 'MMM D, YYYY'\n              },\n              adapters: {\n                date: {\n                  locale: 'en'\n                }\n              },\n              title: {\n                display: true,\n                text: 'Date'\n              },\n              grid: {\n                display: false\n              },\n              ticks: {\n                font: {\n                  size: 12,\n                  weight: 'bold'\n                },\n                padding: 10\n              }\n            },\n            y: {\n              beginAtZero: true,\n              max: 100,\n              grid: {\n                color: 'rgba(0, 0, 0, 0.05)',\n                borderDash: [5, 5]\n              },\n              ticks: {\n                font: {\n                  size: 12,\n                  weight: 'bold'\n                },\n                padding: 10,\n                callback: value => value + '%'\n              },\n              title: {\n                display: true,\n                text: 'Score (%)'\n              }\n            }\n          },\n          plugins: {\n            legend: {\n              display: true,\n              position: 'top',\n              labels: {\n                boxWidth: 15,\n                padding: 15,\n                font: {\n                  size: 14,\n                  weight: 'bold'\n                }\n              }\n            },\n            tooltip: {\n              backgroundColor: 'rgba(0, 0, 0, 0.8)',\n              titleFont: {\n                size: 14,\n                weight: 'bold'\n              },\n              bodyFont: {\n                size: 13\n              },\n              padding: 15,\n              cornerRadius: 8,\n              displayColors: false,\n              callbacks: {\n                title: (tooltipItems) => {\n                  return moment(tooltipItems[0].parsed.x).format('MMMM D, YYYY');\n                },\n                label: (context) => {\n                  const index = context.dataIndex;\n                  const item = data[index];\n                  return [\n                    `${type} #${item.number}`,\n                    `Score: ${item.rawScore}/${item.maxScore} (${item.score.toFixed(1)}%)`\n                  ];\n                }\n              }\n            }\n          }\n        }\n      });\n    };\n\n    // Clean up charts when component unmounts\n    onUnmounted(() => {\n      // Clean up all charts\n      const chartIdBase = selectedStudent.value ? `performanceChart-${selectedStudent.value.studentNumber}` : '';\n      \n      if (chartIdBase) {\n        // Destroy all charts\n        const chartIds = [\n          `all-${chartIdBase}`,\n          `quiz-${chartIdBase}`,\n          `activity-${chartIdBase}`,\n          `performance-${chartIdBase}`\n        ];\n        \n        chartIds.forEach(id => {\n          const chartElement = document.getElementById(id);\n          if (chartElement) {\n            const chart = Chart.getChart(chartElement);\n            if (chart) {\n              chart.destroy();\n            }\n          }\n        });\n      }\n    });\n\n    // Watch for changes in selected student to update charts\n    watch(selectedStudent, () => {\n      if (selectedStudent.value) {\n        nextTick(() => {\n          createPerformanceChart();\n        });\n      } else {\n        // Clean up all charts when student is deselected\n        const chartIdBase = `performanceChart-${selectedStudent.value?.studentNumber}`;\n        \n        if (chartIdBase) {\n          // Destroy all charts\n          const chartIds = [\n            `all-${chartIdBase}`,\n            `quiz-${chartIdBase}`,\n            `activity-${chartIdBase}`,\n            `performance-${chartIdBase}`\n          ];\n          \n          chartIds.forEach(id => {\n            const chartElement = document.getElementById(id);\n            if (chartElement) {\n              const chart = Chart.getChart(chartElement);\n              if (chart) {\n                chart.destroy();\n              }\n            }\n          });\n        }\n      }\n    });\n\n    // Watch for changes in date range to update charts\n    watch([chartDateRange, historyDateRange], () => {\n      if (selectedStudent.value) {\n        nextTick(() => {\n          createPerformanceChart();\n        });\n      }\n    });\n\n    // Watch for changes in current date to refresh data\n    watch(currentDate, async () => {\n      await fetchAssessments();\n      if (selectedStudent.value) {\n        await viewStudentDetails(selectedStudent.value);\n      }\n    });\n\n    // Function to fetch user preferences from the API\n    const fetchUserPreferences = async () => {\n      try {\n        console.log('Fetching user preferences...');\n        \n        // First try to get from localStorage\n        const localPrefs = localStorage.getItem('classRecordPreferences');\n        let localPrefsObj = null;\n        \n        if (localPrefs) {\n          try {\n            localPrefsObj = JSON.parse(localPrefs);\n            console.log('Found preferences in localStorage:', localPrefsObj);\n            \n            // Apply local preferences first\n            if (localPrefsObj.selectedYear) selectedYear.value = localPrefsObj.selectedYear;\n            if (localPrefsObj.selectedSection) selectedSection.value = localPrefsObj.selectedSection;\n            if (localPrefsObj.selectedSubject) selectedSubject.value = localPrefsObj.selectedSubject;\n            if (localPrefsObj.currentPage) currentPage.value = parseInt(localPrefsObj.currentPage) || 1;\n          } catch (parseError) {\n            console.error('Error parsing localStorage preferences:', parseError);\n            localStorage.removeItem('classRecordPreferences');\n          }\n        } else {\n          console.log('No preferences found in localStorage');\n        }\n\n        // Then try to get from backend\n        const token = store.state.auth.token;\n        const userId = store.state.auth.user?._id;\n        \n        if (!userId) {\n          console.error('User ID not available for fetching preferences');\n          return;\n        }\n        \n        console.log('Fetching preferences from backend for user:', userId);\n        \n        const response = await api.get('/users/preferences', {\n          params: { userId },\n          headers: { 'Authorization': `Bearer ${token}` }\n        });\n        \n        console.log('Backend preferences response:', response.data);\n        \n        if (response.data && response.data.preferences) {\n          const prefs = response.data.preferences;\n          \n          // Update preferences if available\n          if (prefs.selectedYear) selectedYear.value = prefs.selectedYear;\n          if (prefs.selectedSection) selectedSection.value = prefs.selectedSection;\n          if (prefs.selectedSubject) selectedSubject.value = prefs.selectedSubject;\n          if (prefs.currentPage) currentPage.value = parseInt(prefs.currentPage) || 1;\n          \n          // Save to localStorage to ensure consistency\n          localStorage.setItem('classRecordPreferences', JSON.stringify(prefs));\n          console.log('Updated preferences from backend:', prefs);\n        } else {\n          console.log('No preferences found in backend, using localStorage values');\n          \n          // If we have local preferences but none from backend, save local to backend\n          if (localPrefsObj) {\n            await saveUserPreferences();\n          }\n        }\n        \n        console.log('Final preferences after fetching:', {\n          year: selectedYear.value,\n          section: selectedSection.value,\n          subject: selectedSubject.value,\n          page: currentPage.value\n        });\n        \n        // Fetch data based on preferences in a specific order\n        if (selectedYear.value) {\n          console.log('Fetching sections for year:', selectedYear.value);\n          await fetchAvailableSections();\n        \n          if (selectedSection.value) {\n            console.log('Updating teacher subjects for section:', selectedSection.value);\n          await updateTeacherSubjects();\n        \n            if (selectedSubject.value) {\n              console.log('Fetching class data for subject:', selectedSubject.value);\n              // Ensure we fetch the data with the current filters\n          await fetchClassData();\n              \n              // Ensure the current page is applied after data is loaded\n              console.log('Applying saved page number:', currentPage.value);\n            }\n          }\n        }\n      } catch (error) {\n        console.error('Error fetching user preferences:', error);\n        console.error('Error details:', {\n          message: error.message,\n          response: error.response?.data,\n          status: error.response?.status\n        });\n        \n        // Try to use localStorage preferences if API call fails\n        const localPrefs = localStorage.getItem('classRecordPreferences');\n        if (localPrefs) {\n          try {\n            const prefs = JSON.parse(localPrefs);\n            console.log('Falling back to localStorage preferences:', prefs);\n            \n            selectedYear.value = prefs.selectedYear || '';\n            selectedSection.value = prefs.selectedSection || '';\n            selectedSubject.value = prefs.selectedSubject || '';\n            if (prefs.currentPage) currentPage.value = parseInt(prefs.currentPage) || 1;\n            \n            // Try to fetch data with these preferences\n            if (selectedYear.value) {\n              await fetchAvailableSections();\n              \n              if (selectedSection.value) {\n                await updateTeacherSubjects();\n                \n                if (selectedSubject.value) {\n                  await fetchClassData();\n                }\n              }\n            }\n          } catch (parseError) {\n            console.error('Error parsing localStorage preferences during fallback:', parseError);\n          }\n        }\n      }\n    };\n    \n    // Function to save user preferences to the API\n    const saveUserPreferences = async () => {\n      try {\n        const token = store.state.auth.token;\n        const userId = store.state.auth.user?._id;\n        \n        if (!userId) {\n          console.error('User ID not available for saving preferences');\n          return;\n        }\n        \n        const preferences = {\n          selectedYear: selectedYear.value,\n          selectedSection: selectedSection.value,\n          selectedSubject: selectedSubject.value,\n          currentPage: currentPage.value\n        };\n\n        console.log('Saving preferences:', preferences);\n\n        // Save to localStorage first for immediate persistence\n        localStorage.setItem('classRecordPreferences', JSON.stringify(preferences));\n        \n        // Then save to backend\n        const response = await api.post('/users/preferences', \n          { userId, preferences },\n          { headers: { 'Authorization': `Bearer ${token}` } }\n        );\n        \n        console.log('User preferences saved successfully:', response.data);\n      } catch (error) {\n        console.error('Error saving user preferences:', error);\n        console.error('Error details:', {\n          message: error.message,\n          response: error.response?.data,\n          status: error.response?.status\n        });\n        \n        // Ensure localStorage is still updated even if API call fails\n        try {\n          const preferences = {\n            selectedYear: selectedYear.value,\n            selectedSection: selectedSection.value,\n            selectedSubject: selectedSubject.value,\n            currentPage: currentPage.value\n          };\n          localStorage.setItem('classRecordPreferences', JSON.stringify(preferences));\n          console.log('Preferences saved to localStorage as fallback');\n        } catch (localStorageError) {\n          console.error('Failed to save preferences to localStorage:', localStorageError);\n        }\n      }\n    };\n\n    // Update the watchers for filter changes\n    watch([selectedYear, selectedSection, selectedSubject], async ([newYear, newSection, newSubject], [oldYear, oldSection, oldSubject]) => {\n      // Save preferences whenever they change\n      await saveUserPreferences();\n      \n      // Handle year changes\n      if (newYear !== oldYear) {\n        selectedSection.value = '';\n        selectedSubject.value = '';\n        if (newYear) {\n          await fetchAvailableSections();\n        }\n      }\n      \n      // Handle section changes\n      if (newSection !== oldSection) {\n        selectedSubject.value = '';\n        if (newSection) {\n          await updateTeacherSubjects();\n        }\n      }\n      \n      // Handle subject changes\n      if (newSubject !== oldSubject && newSubject) {\n        await fetchClassData();\n      }\n    });\n\n    // Add watcher for currentPage\n    watch(currentPage, () => {\n      console.log('Current page changed to:', currentPage.value);\n      saveUserPreferences();\n    });\n\n    // Add cleanup on component unmount\n    onUnmounted(() => {\n      // Save preferences before unmounting\n      saveUserPreferences();\n      \n      // Clear intervals if any\n      if (dateUpdateInterval) {\n        clearInterval(dateUpdateInterval);\n      }\n    });\n\n    // Add a function to load the last used filters\n    const loadLastUsedFilters = async () => {\n      try {\n        console.log('Attempting to load last used filters');\n        const token = store.state.auth.token;\n        const userId = store.state.auth.user?._id;\n        \n        if (!userId) {\n          console.error('User ID not available for loading last used filters');\n          return false;\n        }\n        \n        // First check if we have any recent filters in localStorage\n        const recentFilters = localStorage.getItem('recentFilters');\n        if (recentFilters) {\n          try {\n            const filters = JSON.parse(recentFilters);\n            console.log('Found recent filters in localStorage:', filters);\n            \n            if (filters.length > 0) {\n              // Get the most recent filter\n              const mostRecent = filters[0];\n              \n              // Apply the values\n              if (mostRecent.year) selectedYear.value = mostRecent.year;\n              if (mostRecent.section) selectedSection.value = mostRecent.section;\n              if (mostRecent.subject) selectedSubject.value = mostRecent.subject;\n              \n              // Save to classRecordPreferences\n              const preferences = {\n                selectedYear: selectedYear.value,\n                selectedSection: selectedSection.value,\n                selectedSubject: selectedSubject.value,\n                currentPage: currentPage.value\n              };\n              \n              localStorage.setItem('classRecordPreferences', JSON.stringify(preferences));\n              console.log('Recent filters applied from localStorage:', preferences);\n              \n              return true;\n            }\n          } catch (parseError) {\n            console.error('Error parsing recent filters from localStorage:', parseError);\n          }\n        }\n        \n        // If no recent filters in localStorage, try to get from API\n        try {\n          // First try to get the user's teaching assignments\n          const response = await api.get('/users/teaching-assignments', {\n            params: { userId },\n            headers: { 'Authorization': `Bearer ${token}` }\n          });\n          \n          if (response.data && response.data.assignments && response.data.assignments.length > 0) {\n            // Sort by last accessed timestamp if available\n            const sortedAssignments = [...response.data.assignments].sort((a, b) => {\n              // If lastAccessed is available, use it for sorting\n              if (a.lastAccessed && b.lastAccessed) {\n                return new Date(b.lastAccessed) - new Date(a.lastAccessed);\n              }\n              return 0;\n            });\n            \n            // Use the most recently accessed assignment\n            const mostRecent = sortedAssignments[0];\n            console.log('Most recently used assignment from API:', mostRecent);\n            \n            // Apply the values\n            if (mostRecent.year) selectedYear.value = mostRecent.year;\n            if (mostRecent.section) selectedSection.value = mostRecent.section;\n            if (mostRecent.subject) selectedSubject.value = mostRecent.subject;\n            \n            // Save to localStorage\n            const preferences = {\n              selectedYear: selectedYear.value,\n              selectedSection: selectedSection.value,\n              selectedSubject: selectedSubject.value,\n              currentPage: currentPage.value\n            };\n            \n            localStorage.setItem('classRecordPreferences', JSON.stringify(preferences));\n            console.log('Last used filters applied from API:', preferences);\n            \n            // Also save to recentFilters\n            saveToRecentFilters({\n              year: selectedYear.value,\n              section: selectedSection.value,\n              subject: selectedSubject.value,\n              timestamp: new Date().toISOString()\n            });\n            \n            return true;\n          } else {\n            console.log('No teaching assignments found in API');\n            return false;\n          }\n        } catch (apiError) {\n          console.error('Error fetching teaching assignments from API:', apiError);\n          return false;\n        }\n      } catch (error) {\n        console.error('Error loading last used filters:', error);\n        return false;\n      }\n    };\n\n    // Function to save a filter combination to the recent filters list\n    const saveToRecentFilters = (filter) => {\n      try {\n        // Get existing recent filters or initialize empty array\n        const recentFiltersStr = localStorage.getItem('recentFilters');\n        let recentFilters = [];\n        \n        if (recentFiltersStr) {\n          try {\n            recentFilters = JSON.parse(recentFiltersStr);\n          } catch (parseError) {\n            console.error('Error parsing recent filters, resetting:', parseError);\n          }\n        }\n        \n        // Check if this filter combination already exists\n        const existingIndex = recentFilters.findIndex(f => \n          f.year === filter.year && \n          f.section === filter.section && \n          f.subject === filter.subject\n        );\n        \n        // If it exists, remove it (we'll add it back at the top)\n        if (existingIndex !== -1) {\n          recentFilters.splice(existingIndex, 1);\n        }\n        \n        // Add the new filter at the beginning\n        recentFilters.unshift(filter);\n        \n        // Keep only the 5 most recent filters\n        if (recentFilters.length > 5) {\n          recentFilters = recentFilters.slice(0, 5);\n        }\n        \n        // Save back to localStorage\n        localStorage.setItem('recentFilters', JSON.stringify(recentFilters));\n        console.log('Updated recent filters:', recentFilters);\n      } catch (error) {\n        console.error('Error saving to recent filters:', error);\n      }\n    };\n\n    // Update assessment history table\n    const updateAssessmentHistoryTable = (assessmentsByType) => {\n      if (!selectedStudent.value) return;\n      \n      console.log('Updating assessment history table with date range:', historyDateRange.value);\n      \n      // If assessmentsByType is not provided, use the current assessments\n      if (!assessmentsByType) {\n        // Group assessments by type\n        assessmentsByType = {\n          'Quiz': [],\n          'Activity': [],\n          'Performance Task': []\n        };\n        \n        // Filter assessments for the selected student\n        if (selectedStudent.value.assessments && selectedStudent.value.assessments.length > 0) {\n          selectedStudent.value.assessments.forEach(assessment => {\n            // Get the score for this student\n            const studentNumber = selectedStudent.value.studentNumber;\n            let scoreValue = null;\n            \n            // Check if scores is a Map or an object\n            if (assessment.scores) {\n              if (assessment.scores instanceof Map) {\n                scoreValue = assessment.scores.get(studentNumber);\n              } else if (typeof assessment.scores === 'object') {\n                scoreValue = assessment.scores[studentNumber];\n              }\n            }\n            \n            // If score is not found in assessment.scores, check student.scores\n            if ((scoreValue === null || scoreValue === undefined) && \n                selectedStudent.value.scores && \n                (assessment._id in selectedStudent.value.scores || assessment.id in selectedStudent.value.scores)) {\n              scoreValue = selectedStudent.value.scores[assessment._id] || selectedStudent.value.scores[assessment.id];\n            }\n            \n            if (scoreValue !== null && scoreValue !== undefined) {\n              const maxScore = assessment.maxScore || 100;\n              const scorePercentage = (scoreValue / maxScore) * 100;\n              \n              // Apply date filter if set\n              const assessmentDate = new Date(assessment.date);\n              const startDate = historyDateRange.value.start ? new Date(historyDateRange.value.start) : null;\n              const endDate = historyDateRange.value.end ? new Date(historyDateRange.value.end) : null;\n              \n              // Skip if outside date range\n              if ((startDate && assessmentDate < startDate) || \n                  (endDate && assessmentDate > endDate)) {\n                return;\n              }\n              \n              const type = assessment.type || 'Quiz'; // Default to Quiz if type is not specified\n              \n              assessmentsByType[type].push({\n                ...assessment,\n                date: assessment.date,\n                rawScore: scoreValue,\n                score: scorePercentage,\n                maxScore: maxScore,\n                number: assessment.number,\n                title: `${assessment.type} #${assessment.number}`\n              });\n            }\n          });\n        }\n      }\n      \n      // Get all assessments across all types\n      const allAssessments = [\n        ...(assessmentsByType['Quiz'] || []),\n        ...(assessmentsByType['Activity'] || []),\n        ...(assessmentsByType['Performance Task'] || [])\n      ];\n      \n      // Apply date filter to the history table\n      const filteredAssessments = allAssessments.filter(assessment => {\n        const assessmentDate = new Date(assessment.date);\n        const startDate = historyDateRange.value.start ? new Date(historyDateRange.value.start) : null;\n        const endDate = historyDateRange.value.end ? new Date(historyDateRange.value.end) : null;\n        \n        return (!startDate || assessmentDate >= startDate) && \n               (!endDate || assessmentDate <= endDate);\n      });\n      \n      // Sort by date (newest first)\n      filteredAssessments.sort((a, b) => new Date(b.date) - new Date(a.date));\n      \n      // Store in the selected student object\n      selectedStudent.value.assessmentHistory = filteredAssessments.map(assessment => ({\n        date: assessment.date,\n        type: assessment.title || `${assessment.type} #${assessment.number}`,\n        score: assessment.rawScore,\n        maxScore: assessment.maxScore,\n        percentage: assessment.score\n      }));\n      \n      console.log(`Updated assessment history with ${selectedStudent.value.assessmentHistory.length} records`);\n    };\n\n    // Helper function to get the student's score for an assessment\n    const getStudentScore = (student, assessment) => {\n      // Get the assessment ID\n      const assessmentId = assessment._id || assessment.id;\n      \n      // Check if the student has a score for this assessment\n      if (student.scores && (assessmentId in student.scores)) {\n        return student.scores[assessmentId];\n      }\n      \n      // Check if the assessment has a score for this student\n      if (assessment.scores) {\n        let score;\n        \n        // Handle both Map and plain object\n        if (assessment.scores instanceof Map) {\n          score = assessment.scores.get(student.studentNumber);\n        } else if (typeof assessment.scores === 'object') {\n          score = assessment.scores[student.studentNumber];\n        }\n        \n        if (score !== undefined) {\n          // Store the score in the student object for future reference\n          if (!student.scores) {\n            student.scores = {};\n          }\n          student.scores[assessmentId] = score;\n          return score;\n        }\n      }\n      \n      // No score found\n      return '';\n    };\n\n    return {\n      selectedYear,\n      selectedSection,\n      selectedSubject,\n      searchQuery,\n      students,\n      assessments,\n      filteredAssessmentsByDate,\n      currentDate,\n      showAddAssessmentModal,\n      newAssessment,\n      selectedStudent,\n      quizChart,\n      activityChart,\n      performanceChart,\n      handleAddAssessment,\n      updateScore,\n      viewStudentDetails,\n      formatDate,\n      formatDateForDisplay,\n      navigateDate,\n      user,\n      showAddStudentRecordModal,\n      newStudentRecord,\n      canAddStudentRecord,\n      handleAddStudentRecord,\n      clearFilters,\n      sortField,\n      sortOrder,\n      sortBy,\n      getSortIcon,\n      sortedStudents,\n      showSearch,\n      toggleSearch,\n      handleSearch,\n      applyFilters,\n      getAssessmentBadgeClass,\n      getScoreClass,\n      updateCharts,\n      showEditAssessmentModal,\n      editingAssessment,\n      editAssessment,\n      handleEditAssessment,\n      handleDeleteAssessment,\n      selectedAssessmentType,\n      showChartDateFilter,\n      showHistoryDateFilter,\n      chartDateRange,\n      historyDateRange,\n      filteredAssessments,\n      applyChartDateFilter,\n      clearChartDateFilter,\n      applyHistoryDateFilter,\n      clearHistoryDateFilter,\n      handleLogout,\n      availableYears,\n      availableSections,\n      teacherSubjects,\n      openChartDateFilter,\n      openHistoryDateFilter,\n      slideDirection,\n      isNextDayDisabled,\n      openAddStudentRecordModal,\n      filteredSections,\n      canSelectSection,\n      canSelectSubject,\n      attendanceRecords,\n      attendanceStatistics,\n      fetchAttendance,\n      syncStudentRecords,\n      redirectToAttendance,\n      currentPage,\n      totalPages,\n      paginatedStudents,\n      paginationInfo,\n      nextPage,\n      previousPage,\n      createPerformanceChart,\n      loadLastUsedFilters, // Add the new function\n      saveToRecentFilters, // Add the new function\n      getStudentScore,\n    }\n  }\n}\n</script>\n\n<style scoped>\n/* Remove all modal-related styles since they're now in StudentDetailsModal.vue */\n/* Keep only the styles needed for the main component */\n.class-records {\n  padding: 1.5rem;\n}\n\n.table-controls {\n  background: white;\n  padding: 1rem;\n  border-radius: 12px;\n  box-shadow: 0 2px 4px rgba(0,0,0,0.05);\n}\n\n.btn-control {\n  background: #f8fafc;\n  border: 1px solid #e2e8f0;\n  color: #4a5568;\n  font-size: 0.9rem;\n  padding: 0.5rem 1rem;\n  display: flex;\n  align-items: center;\n  gap: 0.5rem;\n  border-radius: 8px;\n  transition: all 0.2s ease;\n  position: relative;\n}\n\n.btn-control:hover {\n  background: #f1f5f9;\n  border-color: #cbd5e1;\n  color: #2d3748;\n}\n\n.control-menu {\n  border: none;\n  border-radius: 12px;\n  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);\n  padding: 0.5rem 0;\n  margin-top: 0.5rem;\n}\n\n.dropdown-item {\n  padding: 0.6rem 1rem;\n  font-size: 0.9rem;\n  color: #4a5568;\n  display: flex;\n  align-items: center;\n  gap: 0.5rem;\n}\n\n.filter-badge {\n  position: absolute;\n  top: -6px;\n  right: -6px;\n  background: #e53e3e;\n  color: white;\n  width: 18px;\n  height: 18px;\n  border-radius: 50%;\n  font-size: 0.7rem;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  border: 2px solid white;\n}\n\n.search-control {\n  flex: 1;\n  max-width: 400px;\n}\n\n.table-responsive {\n  background: white;\n  border-radius: 12px;\n  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);\n  overflow: hidden;\n}\n\n.table th {\n  background-color: #f8f9fa;\n  color: #666;\n  font-weight: 600;\n  padding: 0.75rem 1rem;\n  border-top: none;\n  white-space: nowrap;\n}\n\n.table td {\n  padding: 0.75rem 1rem;\n  vertical-align: middle;\n  border-color: #eee;\n}\n\n.table tbody tr:hover {\n  background-color: #f8f9fa;\n  cursor: pointer;\n}\n\n.score-input {\n  width: 80px;\n  text-align: center;\n  border: 1px solid #e2e8f0;\n  border-radius: 6px;\n  padding: 0.25rem;\n}\n\n.score-input:focus {\n  border-color: #4299e1;\n  box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.25);\n  outline: none;\n}\n\n.date-display {\n  font-size: 1.1rem;\n  font-weight: 500;\n  color: #495057;\n  padding: 0.5rem 1rem;\n  background: #fff;\n  border-radius: 0.5rem;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n  min-width: 200px;\n  text-align: center;\n}\n\n.empty-state-message {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  gap: 0.5rem;\n  padding: 2rem;\n  color: #6c757d;\n}\n\n.empty-state-message i {\n  font-size: 2rem;\n}\n\n.pagination-controls {\n  background: white;\n  padding: 1rem;\n  border-top: 1px solid #e2e8f0;\n}\n\n.pagination-info {\n  color: #4a5568;\n  font-size: 0.9rem;\n}\n\n.pagination-buttons .btn {\n  min-width: 100px;\n}\n\n.modal-overlay {\n  position: fixed;\n  top: 0;\n  left: 0;\n  width: 100vw;\n  height: 100vh;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  z-index: 9999;\n}\n\n.modal-backdrop {\n  position: fixed;\n  top: 0;\n  left: 0;\n  width: 100vw;\n  height: 100vh;\n  background-color: rgba(0, 0, 0, 0.5);\n  backdrop-filter: blur(4px);\n  z-index: 9998;\n}\n\n.modal-wrapper {\n  position: relative;\n  width: 100%;\n  height: 100%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  z-index: 10000;\n}\n\n.modal-dialog {\n  position: relative;\n  width: 90%;\n  max-width: 600px;\n  margin: 1.75rem auto;\n  pointer-events: auto;\n}\n\n.modal-content {\n  position: relative;\n  display: flex;\n  flex-direction: column;\n  width: 100%;\n  pointer-events: auto;\n  background-color: #fff;\n  background-clip: padding-box;\n  border: none;\n  border-radius: 0.5rem;\n  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);\n  outline: 0;\n  max-height: calc(100vh - 3.5rem);\n  overflow-y: auto;\n}\n\n.modal-header {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  padding: 1.5rem;\n  border-bottom: 1px solid #dee2e6;\n  border-top-left-radius: calc(0.5rem - 1px);\n  border-top-right-radius: calc(0.5rem - 1px);\n}\n\n.modal-body {\n  position: relative;\n  flex: 1 1 auto;\n  padding: 1.5rem;\n}\n\n.modal-xxl {\n  max-width: 1400px;\n}\n</style>"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}